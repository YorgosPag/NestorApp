{
  "category": "FIX",
  "shortDescription": "Click position now matches crosshair center in overlay draw mode",
  "problem": "When drawing colored layers (overlay draw mode), the click position did not align with the crosshair center. Vertices appeared at a slightly different position than where the user aimed.",
  "cause": "Three different DOM elements were used as coordinate sources: (1) Crosshair used container div position (overwritten by bubbling in useCanvasMouse), (2) Click used DxfCanvas position (e.currentTarget in useCentralizedMouseHandlers), (3) Render used LayerCanvas dimensions (canvasBoundsService.refreshBounds). Subpixel differences between these elements caused misalignment in the screenToWorld/worldToScreen formulas.",
  "filesChanged": [
    "src/subapps/dxf-viewer/hooks/canvas/useCanvasMouse.ts",
    "src/subapps/dxf-viewer/canvas-v2/layer-canvas/LayerRenderer.ts"
  ],
  "solution": "Phase 1: Removed duplicate setImmediatePosition(screenPos) from container mousemove handler (useCanvasMouse.ts:320) — DxfCanvas handler already sets it, container handler was overwriting with container-relative coords due to event bubbling. Phase 2: Changed renderUnified/renderLegacy in LayerRenderer.ts to use the viewport parameter (container-based SSoT) instead of actualViewport (LayerCanvas element) for coordinate transforms, so worldToScreen uses the same viewport as screenToWorld (click handler).",
  "testing": "TypeScript compilation check passed (0 new errors). Verification steps: overlay draw vertices should align with crosshair center, DXF polygon tool vertices match crosshair, zoom/pan consistency maintained, snap indicators correct.",
  "notes": "actualViewport still used for clearRect (needs actual canvas pixel dimensions). The setImmediatePosition(null) call in handleContainerMouseLeave is preserved for cleanup.",
  "contributors": {
    "user": "Γιώργος Παγώνης",
    "assistant": "Claude Opus 4.6",
    "sessionDate": "2026-02-15"
  },
  "relatedBackups": [],
  "commits": [
    {
      "hash": "5b0bf282",
      "message": "fix(dxf-viewer): align crosshair, click, and render to same coordinate source"
    }
  ]
}
