{
  "backupId": "backup-2026-02-09-multi-intent-pipeline-adr131",
  "timestamp": "2026-02-09T23:30:00+02:00",
  "category": "FEATURE",
  "shortDescription": "Multi-intent pipeline — one message, multiple intents, one unified reply (ADR-131)",
  "problem": "Ένας πελάτης μπορεί να στείλει email με πολλαπλά αιτήματα (π.χ. ραντεβού ΚΑΙ αναζήτηση ακινήτου), αλλά η pipeline αναγνώριζε μόνο ένα intent και αγνοούσε τα υπόλοιπα.",
  "cause": "Η αρχική αρχιτεκτονή υποστήριζε μόνο single-intent detection: ένα OpenAI schema, ένας router, ένα module ανά μήνυμα.",
  "filesChanged": [
    "src/config/ai-analysis-config.ts — AI_MULTI_INTENT_SCHEMA + MULTI_INTENT_SYSTEM prompt",
    "src/schemas/ai-analysis.ts — MultiIntentAnalysisSchema + DetectedIntentSchema + isMultiIntentAnalysis()",
    "src/types/ai-pipeline.ts — DetectedIntent, detectedIntents[], multiLookupData, contributingModules",
    "src/services/ai-analysis/providers/OpenAIAnalysisProvider.ts — Uses AI_MULTI_INTENT_SCHEMA",
    "src/services/ai-pipeline/pipeline-orchestrator.ts — Multi-module flow (6 new methods)",
    "src/services/ai-pipeline/module-registry.ts — getModulesForIntents()",
    "src/services/ai-pipeline/intent-router.ts — routeMultiple() + MultiRoutingResult",
    "src/config/ai-pipeline-config.ts — SECONDARY_INTENT_THRESHOLD: 50",
    "src/services/ai-pipeline/shared/ai-reply-generator.ts — generateCompositeReply()",
    "src/components/admin/operator-inbox/ProposalReviewCard.tsx — Multi-intent UI badges",
    "src/i18n/locales/el/admin.json — multiIntent.* keys",
    "src/i18n/locales/en/admin.json — multiIntent.* keys",
    "docs/centralized-systems/reference/adrs/ADR-131-multi-intent-pipeline.md (NEW)",
    "docs/centralized-systems/reference/adr-index.md — Added ADR-131",
    "CLAUDE.md — Updated available ADR IDs"
  ],
  "solution": {
    "phase1_ai_schema": "New AI_MULTI_INTENT_SCHEMA with primaryIntent + secondaryIntents[]. Zod MultiIntentAnalysisSchema. DetectedIntent type. mapAIResultToUnderstanding handles both multi and legacy.",
    "phase2_router": "IntentRouter.routeMultiple() returns MultiRoutingResult with primary + secondary routes. ModuleRegistry.getModulesForIntents() for deduplicated multi-lookup. SECONDARY_INTENT_THRESHOLD: 50.",
    "phase3_orchestrator": "6 new methods: stepMultiLookup, stepMultiPropose, composeProposal, stepApproveMulti, stepMultiExecute, resolveModulesForExecution. Each module gets its own lookup data via multiLookupData[moduleId].",
    "phase4_composite_reply": "generateCompositeReply() merges N partial replies into 1 unified email. Single-reply shortcut: zero overhead. Operator Inbox shows multi-intent badges with primary/secondary labels."
  },
  "testing": {
    "typescript": "npx tsc --noEmit → 0 errors (after each phase)",
    "preCommit": "Pre-commit checks passed",
    "deployment": "Pushed to main, Vercel auto-deployment triggered"
  },
  "notes": [
    "15 files changed: 817 insertions, 113 deletions",
    "1 new file: ADR-131-multi-intent-pipeline.md",
    "Full backward compatibility: single-intent messages follow identical flow",
    "Primary module failure = fatal, secondary module failure = logged and skipped",
    "Thresholds: SECONDARY_INTENT 50, AUTO_APPROVE 90, MANUAL_TRIAGE 60, QUARANTINE 30",
    "ADR-131 documents complete architecture in 9 subsections"
  ],
  "contributors": {
    "user": "Γιώργος Παγώνης",
    "assistant": "Claude Opus 4.6 (Anthropic)",
    "sessionDate": "2026-02-09"
  },
  "relatedBackups": [
    "backup-2026-02-09-personas-ai-pipeline-property-search"
  ],
  "commits": [
    {
      "hash": "038df8cc",
      "message": "feat: multi-intent pipeline — one message, multiple intents, one unified reply (ADR-131)",
      "files": 15,
      "insertions": 817,
      "deletions": 113
    }
  ],
  "statistics": {
    "filesChanged": 15,
    "totalInsertions": 817,
    "totalDeletions": 113,
    "netLinesAdded": 704,
    "newFiles": 1,
    "commitsInBackup": 1
  }
}
