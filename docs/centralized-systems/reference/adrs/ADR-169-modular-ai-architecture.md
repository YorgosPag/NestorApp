# ADR-169: Modular AI Architecture - Enterprise Automation Platform

| Metadata | Value |
|----------|-------|
| **Status** | DRAFT - Requirements Gathering |
| **Date** | 2026-02-07 |
| **Category** | AI Architecture / Enterprise Automation |
| **Author** | Γιώργος Παγώνης + Claude Code (Anthropic AI) |

---

## 1. Context

### Vision

Η εφαρμογή πρέπει να γίνει **enterprise-class**, πλήρως αυτοματοποιημένη και πανέξυπνη. Οι χρήστες πρέπει να κερδίζουν χρόνο - μηδέν χαμένος χρόνος σε γραφειοκρατία. Η εφαρμογή πρέπει να ξεχωρίζει από τις υπόλοιπες εφαρμογές στην Ελλάδα και να είναι σαν τις εφαρμογές μεγάλων παγκόσμιων κατασκευαστριών εταιρειών λογισμικού.

### Αρχιτεκτονική Αρχή

Η AI αρχιτεκτονική πρέπει να είναι **MODULAR (αρθρωτή)**. Κάθε use case είναι ένα ξεχωριστό module που συνδέεται σε μια κεντρική AI pipeline.

### Διαθέσιμα AI Models

OpenAI models (env vars ήδη στο Vercel):
- `gpt-4o-mini` - Γρήγορο, οικονομικό (ήδη ενεργό για email triage)
- `gpt-4o` - Ισχυρότερο, για πολύπλοκες εργασίες
- `gpt-4-turbo` - Εξελιγμένο reasoning
- Μελλοντικά: Νεότερα μοντέλα καθώς κυκλοφορούν

---

## 2. Κοινό Μοτίβο - Universal AI Pipeline

Όλα τα σενάρια ακολουθούν **το ίδιο μοτίβο**:

```
ΕΙΣΕΡΧΟΜΕΝΟ     →  AI ΚΑΤΑΝΟΗΣΗ      →  ΑΝΑΖΗΤΗΣΗ          →  ΠΡΟΤΑΣΗ        →  ΕΓΚΡΙΣΗ       →  ΕΚΤΕΛΕΣΗ
(email/msg)        (intent, entities)    (στο σύστημα)         (ενέργειας)       (ανθρώπου)       (αυτόματη)
```

### Company Detection - Multi-Signal (cross-cutting, αφορά ΟΛΑ τα σενάρια)

Σε κάθε εισερχόμενο μήνυμα, το AI εφαρμόζει **4 σήματα κατά σειρά προτεραιότητας** για να αναγνωρίσει σε ποια εταιρεία/έργο ανήκει:

| Προτεραιότητα | Σήμα | Περιγραφή | Αξιοπιστία |
|---------------|-------|-----------|------------|
| 1 | **Email παραλήπτη** | Κάθε εταιρεία/έργο έχει δικό του email (π.χ. `info@alysida.gr`). Mailgun routing. | Υψηλή |
| 2 | **Γνωστή επαφή** | Ο αποστολέας υπάρχει ως contact στο σύστημα, συνδεδεμένος με εταιρεία/έργο. | Υψηλή |
| 3 | **Περιεχόμενο μηνύματος** | AI αναγνωρίζει αναφορές σε έργο, περιοχή, κτίριο μέσα στο κείμενο. | Μέτρια |
| 4 | **Fallback** | AI ρωτάει ευγενικά τον αποστολέα, ή δρομολογεί σε γενικό υπεύθυνο. | — |

### Escalation Protocol (cross-cutting, αφορά ΟΛΑ τα σενάρια)

Όταν το AI στέλνει πρόταση (Propose) σε υπεύθυνο και **δεν λαμβάνει απάντηση**, ενεργοποιείται αυτόματα:

| Φάση | Χρόνος | Ενέργεια | Αποδέκτης |
|------|--------|----------|-----------|
| **1. Reminder** | +30 λεπτά | 1η υπενθύμιση (notification in-app + email) | Υπεύθυνος |
| **2. Urgent Reminder** | +2 ώρες | 2η υπενθύμιση με ένδειξη **ΕΠΕΙΓΟΝ** | Υπεύθυνος |
| **3. Escalation** | +4 ώρες | Κλιμάκωση → "Ο [υπεύθυνος] δεν απάντησε στο αίτημα του [X] εδώ και 4 ώρες" | Προϊστάμενος / Αναπληρωτής |
| **4. Critical** | +8 ώρες (εργάσιμες) | Κρίσιμη κλιμάκωση, σήμανση **ΕΚΠΡΟΘΕΣΜΟ** | Διαχειριστής / Ιδιοκτήτης εταιρείας |

**Ενημέρωση πελάτη/αποστολέα**:
- Αρχική: Ήδη στάλθηκε μέσω Acknowledge ("Λάβαμε το αίτημά σας")
- +4 ώρες (αν δεν έχει κλείσει): "Εργαζόμαστε στο αίτημά σας, θα σας ενημερώσουμε σύντομα"

**Κανόνες**:
- Μόνο **εργάσιμες ώρες** (Δευ-Παρ, 08:00-20:00) - δεν στέλνει reminders μεσάνυχτα/Σαββατοκύριακο
- **Configurable ανά εταιρεία** - κάθε εταιρεία ρυθμίζει τα χρονικά όρια
- **Priority-based**: Επείγοντα αιτήματα → μισοί χρόνοι (15 λεπτά, 1 ώρα, 2 ώρες, 4 ώρες)

### Pipeline Βήματα:

| Βήμα | Περιγραφή | Module |
|------|-----------|--------|
| **1. Intake** | Λήψη μηνύματος (email, Telegram, κ.λπ.) | `IntakeModule` |
| **2. Understand** | AI αναλύει intent, entities, urgency | `UnderstandingModule` |
| **3. Lookup** | Αναζήτηση σχετικών δεδομένων στο σύστημα | `LookupModule` |
| **4. Propose** | AI προτείνει ενέργεια στον υπεύθυνο | `ProposalModule` |
| **5. Approve** | Ο υπεύθυνος εγκρίνει/τροποποιεί/απορρίπτει | `ApprovalModule` |
| **6. Execute** | Αυτόματη εκτέλεση εγκεκριμένης ενέργειας | `ExecutionModule` |
| **7. Acknowledge** | Ενδιάμεση απάντηση στον αποστολέα ("Λάβαμε το αίτημά σας") | `AcknowledgeModule` |

---

## 3. Σενάρια Χρήσης (Use Cases)

### UC-001: Αίτημα Ραντεβού Πελάτη

**Trigger**: Πελάτης στέλνει μήνυμα ζητώντας ραντεβού

**Ροή**:
1. **Intake**: Email/μήνυμα εισέρχεται στο σύστημα
2. **Acknowledge**: Άμεση απάντηση → "Λάβαμε το αίτημά σας, θα σας απαντήσουμε σύντομα"
3. **Understand**: AI αναγνωρίζει → intent: `appointment_request`
4. **Company Detection** (Multi-Signal - κατά σειρά προτεραιότητας):
   - **Σήμα 1 - Email παραλήπτη** (πιο αξιόπιστο): Κάθε εταιρεία/έργο έχει δικό του email (π.χ. `info@alysida.gr` → ΑΛΥΣΙΔΑ ΑΕ). Δουλεύει ήδη μέσω Mailgun routing.
   - **Σήμα 2 - Γνωστή επαφή**: Αν ο αποστολέας υπάρχει ως contact στο σύστημα, συνδεδεμένος με εταιρεία/έργο.
   - **Σήμα 3 - Περιεχόμενο μηνύματος**: Ο πελάτης αναφέρει έργο, περιοχή, κτίριο → AI αντιστοιχίζει.
   - **Σήμα 4 - Fallback**: AI ρωτάει ευγενικά τον πελάτη για ποιο έργο/περιοχή ενδιαφέρεται, ή δρομολογεί σε γενικό υπεύθυνο.
5. **Lookup**:
   - Βρίσκει τον **υπεύθυνο πωλήσεων** της εταιρείας
   - Ελέγχει το **ημερολόγιο** του υπεύθυνου
   - Εντοπίζει **κενές ώρες/ημέρες**
   - Ελέγχει αν ο αποστολέας υπάρχει ως **Contact** ή **Lead** στο σύστημα
6. **Smart Appointment Matching** (3 υπο-σενάρια):

   **Α. Ζητά συγκεκριμένη ώρα → Υπεύθυνος ΕΙΝΑΙ διαθέσιμος**:
   - Propose → "Ο πελάτης X ζητά ραντεβού Τρίτη 10:00 - είσαι διαθέσιμος. Επιβεβαιώνεις;"

   **Β. Ζητά συγκεκριμένη ώρα → Υπεύθυνος ΔΕΝ είναι διαθέσιμος**:
   - AI βρίσκει **3 πιο κοντινές εναλλακτικές**:
     - Ίδια μέρα, διαφορετική ώρα (π.χ. Τρίτη 11:00 ή 14:00)
     - Επόμενη μέρα, ίδια ώρα (π.χ. Τετάρτη 10:00)
     - Πιο κοντινό κενό γενικά
   - Propose → "Ο πελάτης ζήτησε Τρίτη 10:00 αλλά δεν είσαι διαθέσιμος. Εναλλακτικές: [1, 2, 3]. Ποια προτιμάς;"
   - Μετά την έγκριση → στέλνει στον πελάτη: "Η Τρίτη 10:00 δεν είναι διαθέσιμη. Σας προτείνουμε: [εναλλακτικές]"

   **Γ. Ζητά γενικά (π.χ. "επόμενη εβδομάδα", "κάποιο πρωινό")**:
   - AI φιλτράρει ημερολόγιο βάσει κριτηρίων
   - Propose → Λίστα διαθέσιμων ωρών στον υπεύθυνο

7. **Approve**: Ο υπεύθυνος επιλέγει ώρα ή προτείνει εναλλακτική
   - **ΚΑΝΟΝΑΣ**: Ποτέ δεν κλείνει ραντεβού χωρίς έγκριση υπευθύνου
8. **Lead/Contact Management**:
   - Αν ο αποστολέας είναι **νέος** → δημιουργία Lead (status: `new`)
   - Αν υπάρχει ήδη ως **Lead** → ενημέρωση Lead (status: `contacted`)
   - Αν υπάρχει ως **Contact** → σύνδεση αιτήματος με υπάρχουσα επαφή
9. **Execute**: Αποστολή απάντησης στον πελάτη μέσω email/Telegram/κ.λπ.

**Κανάλια επικοινωνίας**: Email, Telegram, άλλα

---

### UC-002: Τιμολόγιο Προμηθευτή

**Trigger**: Προμηθευτής στέλνει τιμολόγιο μέσω email

**Ροή**:
1. **Intake**: Email με συνημμένο τιμολόγιο εισέρχεται
2. **Understand**: AI διαβάζει το τιμολόγιο (OCR/Vision) και αναγνωρίζει:
   - Ποια **εταιρεία** αφορά
   - Ποιο **έργο** αφορά
   - Τι **εργασία/υλικά** (θεμελίωση, σκυρόδεμα, σίδηρος, πλακίδια, σοβάδες κ.λπ.)
   - Ποσό, ΑΦΜ, ημερομηνία
3. **Lookup**: Αντιστοίχιση εταιρείας/έργου στο σύστημα
4. **Execute - File System**:
   - Καταχώριση στο κεντρικοποιημένο file system
   - Ονοματοδοσία βάσει κεντρικοποιημένων κανόνων
5. **Execute - Λογιστήριο**:
   - Προώθηση τιμολογίου στο λογιστήριο (email)
   - Ενημέρωση "Νέο τιμολόγιο για [εταιρεία]/[έργο]"
6. **Propose**: Ενημέρωση υπευθύνου έργου

---

### UC-003: Αίτημα Συμβολαιογράφου για Έγγραφα

**Trigger**: Συμβολαιογράφος ζητά έγγραφα για σύνταξη συμβολαίου

**Ροή**:
1. **Intake**: Μήνυμα από συμβολαιογράφο
2. **Understand**: AI αναγνωρίζει:
   - Ποιο **διαμέρισμα** αφορά (unit)
   - Ποια **έγγραφα** ζητούνται:
     - ΚΑΕΚ (Κωδικός Αριθμός Εθνικού Κτηματολογίου)
     - Κτηματολογικό φύλλο
     - Βεβαίωση νομιμότητας
     - Ηλεκτρονική ταυτότητα κτιρίου
     - Τοπογραφικό
     - Άδεια (οικοδομική)
     - Στοιχεία αγοραστή
     - Πίνακας ποσοστών (καθαρά, μικτά, χιλιοστά επί οικοπέδου)
3. **Lookup**:
   - Βρίσκει το **διαμέρισμα** στο σύστημα
   - Αναζητά τα **ζητούμενα έγγραφα** στο file system
   - Ελέγχει ποια υπάρχουν ήδη και ποια λείπουν
4. **Propose**: Ενημερώνει τον υπεύθυνο συμβολαίων:
   - "Ο συμβολαιογράφος X ζήτησε τα εξής έγγραφα για το διαμέρισμα Y"
   - "Βρήκα: ΚΑΕΚ, κτηματολογικό, τοπογραφικό, άδεια"
   - "Λείπουν: στοιχεία αγοραστή"
   - "Να τα στείλω στον συμβολαιογράφο;"
5. **Approve**: Ο υπεύθυνος εγκρίνει
6. **Execute**: Αποστολή εγγράφων στον συμβολαιογράφο

---

## 4. Αποφάσεις Αρχιτεκτονικής

### Εκκρεμείς Αποφάσεις (Pending)

| # | Ερώτημα | Απόφαση | Status |
|---|---------|---------|--------|
| D-001 | Ποια κανάλια επικοινωνίας θα υποστηρίξουμε; | **Φάση 1**: Email (ήδη λειτουργικό) + Telegram. **Φάση 2**: Messenger, SMS (θα αποφασιστεί αργότερα). **Φάση 3**: In-app (πελάτες/συνεργάτες μέσω ιστοσελίδας ακινήτων). | **DECIDED** |
| D-002 | Πώς θα γίνεται η αναγνώριση εγγράφων; (OCR/Vision API) | — | PENDING |
| D-003 | Ποιος εγκρίνει κάθε τύπο ενέργειας; (Ρόλοι χρηστών) | — | PENDING |
| D-004 | Πώς θα δομηθεί ο πίνακας ποσοστών στο σύστημα; | — | PENDING |
| D-005 | Ποιο AI model ανά σενάριο; (mini vs full) | — | PENDING |
| D-006 | Templates απαντήσεων - πώς θα τα διαχειριστούμε; | — | PENDING |
| D-007 | Ημερολόγιο - υπάρχει ήδη ή πρέπει να φτιαχτεί; | **Πρέπει να φτιαχτεί από το μηδέν.** Υπάρχει μόνο ένα πολύ πρόχειρο ημερολόγιο στο CRM, εντελώς ανεπαρκές. Το νέο ημερολόγιο πρέπει να περιλαμβάνει: ραντεβού, εργασίες κάθε εργαζομένου/εμπλεκομένου, και να είναι αναγνώσιμο από το AI. | **DECIDED** |
| D-008 | Εξερχόμενα μηνύματα - πώς θα αποστέλλονται; | — | PENDING |

---

## 5. Προαπαιτούμενα Συστήματα (Prerequisites)

### PRE-001: Enterprise Calendar System

**Status**: ΔΕΝ ΥΠΑΡΧΕΙ - Πρέπει να φτιαχτεί

**Τρέχουσα κατάσταση**: Μόνο ένα πολύ πρόχειρο ημερολόγιο στο CRM, εντελώς ανεπαρκές.

**Απαιτήσεις**:
- Ραντεβού χρηστών (εσωτερικά & εξωτερικά)
- Εργασίες ανά εργαζόμενο/εμπλεκόμενο
- AI-readable: Το AI πρέπει να μπορεί να διαβάσει & γράψει στο ημερολόγιο
- Ανά εταιρεία / ανά έργο / ανά χρήστη
- Conflict detection (σύγκρουση ραντεβού)
- Κενά ημερολογίου (availability slots)

**Κρίσιμο για**: UC-001 (Ραντεβού), και κάθε μελλοντικό σενάριο scheduling

---

### PRE-002: Leads System (Ενδιαφερόμενοι / Ευκαιρίες)

**Status**: ΥΠΑΡΧΕΙ ΥΠΟΤΥΠΩΔΗΣ ΚΩΔΙΚΑΣ - Πρέπει να επεκταθεί

**Τρέχουσα κατάσταση**: Στο CRM υπάρχει ήδη μια υποτυπώδης κατηγορία "Ευκαιρίες" (opportunities). Ο κώδικας πρέπει να επεκταθεί σε πλήρες Leads system.

**Αρχιτεκτονική Αρχή - Contacts vs Leads**:

| | **Contacts (Επαφές)** | **Leads (Ενδιαφερόμενοι)** |
|---|---|---|
| **Τι είναι** | Επιβεβαιωμένοι συνεργάτες/πελάτες | Άγνωστοι που απλά ρώτησαν κάτι |
| **Ποιότητα** | Υψηλή - πλήρη στοιχεία, επαληθευμένα | Χαμηλή - ίσως μόνο email ή τηλέφωνο |
| **Παραδείγματα** | Προμηθευτές, συμβολαιογράφοι, αγοραστές | "Ενδιαφέρομαι για γκαρσονιέρα" |
| **Τύποι** | Φυσικά πρόσωπα, Νομικά πρόσωπα, Δημόσιες υπηρεσίες | Νέοι ενδιαφερόμενοι από κάθε κανάλι |
| **Λίστα** | Καθαρή - μόνο πραγματικοί | Δέχεται τα πάντα |

**Ροή Lead → Contact**:
```
Lead (new) → contacted → qualified → negotiation → WON → Μετατροπή σε Contact
                                                  → LOST → Αρχειοθέτηση
```

**Απαιτήσεις επέκτασης**:
- Lead statuses: `new`, `contacted`, `qualified`, `negotiation`, `won`, `lost`
- Σύνδεση με αιτήματα AI pipeline (κάθε εισερχόμενο αίτημα = νέο Lead ή ενημέρωση υπάρχοντος)
- Conversion tracking: πόσοι ρώτησαν → πόσοι έγιναν πελάτες
- Αυτόματη μετατροπή Lead → Contact όταν κλείσει πώληση/συνεργασία
- AI-readable: Το AI πρέπει να ελέγχει αν ο αποστολέας υπάρχει ήδη ως Lead ή Contact

**Κρίσιμο για**: UC-001 (Ραντεβού), UC-005 (Αναζήτηση Ακινήτων), και κάθε εισερχόμενο αίτημα

---

### UC-004: In-App Αιτήματα Πελατών/Συνεργατών (μέσω ιστοσελίδας)

**Trigger**: Πελάτης ή συνεργάτης χρησιμοποιεί απευθείας την εφαρμογή/ιστοσελίδα

**Context**: Η εφαρμογή θα έχει δημόσιο κομμάτι (ιστοσελίδα) που προβάλλει τα διαθέσιμα ακίνητα προς πώληση & ενοικίαση. Πελάτες και συνεργάτες θα μπαίνουν απευθείας και θα ζητούν:
- Πληροφορίες για ακίνητα
- Ραντεβού
- Επικοινωνία με υπεύθυνο

**Ροή**: Ίδια pipeline με UC-001/UC-003 αλλά η πηγή (Intake) είναι η ίδια η εφαρμογή αντί για email/Telegram.

**Σημείωση**: Αυτό σημαίνει ότι το `IntakeModule` πρέπει να υποστηρίζει πολλαπλές πηγές εισόδου:
1. Email (Mailgun webhook)
2. Telegram (Bot API)
3. In-app (direct form/chat στην ιστοσελίδα)
4. Messenger, SMS (μελλοντικά)

---

### UC-005: Αναζήτηση Ακινήτων από Ενδιαφερόμενο

**Trigger**: Ενδιαφερόμενος ζητά πληροφορίες για ακίνητα (μέσω email, Telegram, in-app, κ.λπ.)

**Τύποι αιτημάτων** (AI πρέπει να αναγνωρίζει):
- Συγκεκριμένο ακίνητο: "Ενδιαφέρομαι για το διαμέρισμα Χ"
- Τύπος ακινήτου: στούντιο, γκαρσονιέρα, μεζονέτα, κατάστημα, θέση στάθμευσης
- Εύρος τετραγωνικών: "Διαμέρισμα περίπου 80 τ.μ."
- Εύρος τιμών: "Μέχρι 200.000€" ή "100.000-150.000€"
- Συγκεκριμένος όροφος: "1ος όροφος" ή "ρετιρέ"
- Συγκεκριμένη περιοχή: "στο κέντρο" ή "στη Γλυφάδα"
- Γενική ερώτηση: "Χτίζετε σε κάποια άλλη περιοχή;"

**Ροή**:
1. **Intake**: Μήνυμα εισέρχεται από οποιοδήποτε κανάλι
2. **Acknowledge**: "Λάβαμε το ενδιαφέρον σας, σας απαντάμε αμέσως"
3. **Understand**: AI αναγνωρίζει τα κριτήρια αναζήτησης:
   - `property_type`: στούντιο / γκαρσονιέρα / διαμέρισμα / μεζονέτα / κατάστημα / parking
   - `area_range`: min-max τ.μ.
   - `price_range`: min-max €
   - `floor`: συγκεκριμένος ή εύρος
   - `location`: περιοχή / έργο
   - `purpose`: αγορά / ενοικίαση
4. **Lookup**: Αναζήτηση στο σύστημα:
   - Φιλτράρισμα units βάσει κριτηρίων
   - Έλεγχος διαθεσιμότητας (status: available)
   - Συγκέντρωση πληροφοριών (τ.μ., τιμή, όροφος, χαρακτηριστικά)
5. **Propose**: AI ετοιμάζει απάντηση:
   - Λίστα διαθέσιμων ακινήτων που ταιριάζουν
   - Βασικά στοιχεία κάθε ακινήτου
   - Πρόταση για ραντεβού επίσκεψης
6. **Approve**: Υπεύθυνος πωλήσεων εγκρίνει/τροποποιεί την απάντηση
7. **Execute**: Αποστολή απάντησης στον ενδιαφερόμενο

**Σημείωση**: Σε περίπτωση "χτίζετε αλλού;", το AI αντλεί πληροφορίες από τη λίστα έργων/τοποθεσιών.

---

## 6. Μελλοντικά Σενάρια (Backlog)

> Ο Γιώργος θα προσθέσει επιπλέον σενάρια εδώ.

| UC | Περιγραφή | Status |
|----|-----------|--------|
| UC-006 | — | PENDING |
| UC-007 | — | PENDING |
| UC-008 | — | PENDING |

---

## 7. Τεχνολογικό Stack

| Component | Τεχνολογία |
|-----------|-----------|
| **AI Provider** | OpenAI (gpt-4o-mini, gpt-4o, gpt-4-turbo) |
| **Backend** | Next.js 15 API Routes |
| **Database** | Firebase Firestore |
| **File Storage** | Firebase Storage |
| **Email Inbound** | Mailgun Webhooks (ήδη λειτουργικό) |
| **Email Outbound** | Mailgun API (TBD) |
| **Messaging** | Telegram Bot API (TBD) |
| **Hosting** | Vercel |

---

## 8. Changelog

| Ημερομηνία | Αλλαγή |
|------------|--------|
| 2026-02-07 | Initial draft - 3 use cases καταγράφηκαν (UC-001, UC-002, UC-003) |
| 2026-02-07 | D-007 DECIDED: Calendar system πρέπει να φτιαχτεί από μηδέν. Προστέθηκε PRE-001. |
| 2026-02-07 | D-001 DECIDED: Κανάλια σε 3 φάσεις (Email+Telegram → Messenger/SMS → In-app). Προστέθηκε UC-004 (in-app αιτήματα μέσω ιστοσελίδας ακινήτων). |
| 2026-02-07 | UC-005: Αναζήτηση ακινήτων - AI φιλτράρει βάσει τύπου, τ.μ., τιμής, ορόφου, περιοχής, σκοπού. |
| 2026-02-07 | DECIDED: Multi-Signal Company Detection (4 σήματα κατά προτεραιότητα). Προστέθηκε ως cross-cutting pattern σε pipeline + UC-001. |
| 2026-02-07 | DECIDED: 3-Phase Escalation Protocol (30min → 2h → 4h → 8h). Configurable ανά εταιρεία, μόνο εργάσιμες ώρες, priority-based. |
| 2026-02-07 | DECIDED: Contacts vs Leads separation. Υπάρχει υποτυπώδης κώδικας "Ευκαιρίες" στο CRM - πρέπει επέκταση. Προστέθηκε PRE-002. |
| 2026-02-07 | DECIDED: Smart Appointment Matching (3 σενάρια: διαθέσιμος/μη διαθέσιμος/γενικό αίτημα). Ποτέ αυτόματο κλείσιμο χωρίς έγκριση. UC-001 ενημερώθηκε πλήρως. |
