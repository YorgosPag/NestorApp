# AI Universal Pipeline & Cross-Cutting Patterns

> **Parent ADR**: [ADR-169 - Modular AI Architecture](../reference/adrs/ADR-169-modular-ai-architecture.md)

---

## Universal AI Pipeline

Όλα τα σενάρια ακολουθούν **το ίδιο μοτίβο**:

```
ΕΙΣΕΡΧΟΜΕΝΟ     →  AI ΚΑΤΑΝΟΗΣΗ      →  ΑΝΑΖΗΤΗΣΗ          →  ΠΡΟΤΑΣΗ        →  ΕΓΚΡΙΣΗ       →  ΕΚΤΕΛΕΣΗ
(email/msg)        (intent, entities)    (στο σύστημα)         (ενέργειας)       (ανθρώπου)       (αυτόματη)
```

### Pipeline Βήματα

| Βήμα | Περιγραφή | Module |
|------|-----------|--------|
| **1. Intake** | Λήψη μηνύματος (email, Telegram, κ.λπ.) | `IntakeModule` |
| **2. Understand** | AI αναλύει intent, entities, urgency + sender classification + threat detection | `UnderstandingModule` |
| **3. Lookup** | Αναζήτηση σχετικών δεδομένων στο σύστημα | `LookupModule` |
| **4. Propose** | AI προτείνει ενέργεια στον υπεύθυνο | `ProposalModule` |
| **5. Approve** | Ο υπεύθυνος εγκρίνει/τροποποιεί/απορρίπτει | `ApprovalModule` |
| **6. Execute** | Αυτόματη εκτέλεση εγκεκριμένης ενέργειας | `ExecutionModule` |
| **7. Acknowledge** | Ενδιάμεση απάντηση στον αποστολέα ("Λάβαμε το αίτημά σας") | `AcknowledgeModule` |

Για τα interface contracts κάθε module, βλ. [contracts.md](./contracts.md).

---

## Cross-Cutting Patterns

### Sender Classification & Threat Filtering

Πριν από κάθε άλλη ανάλυση, η AI ταξινομεί τον αποστολέα και ελέγχει για απειλές. Η ταξινόμηση γίνεται στο **UnderstandingModule** και καθορίζει τη ροή:

```
Εισερχόμενο μήνυμα
  │
  ├── Spam / Phishing ──────→ QUARANTINE (δεν φτάνει στον operator)
  │                           Βλ. security.md → Spam & Phishing Detection
  │
  ├── Cold outreach ────────→ LOW PRIORITY queue
  │   (πώληση προϊόντων,       (operator βλέπει αν θέλει)
  │    marketing, newsletter)
  │
  ├── Γνωστός αποστολέας ──→ Κανονική ροή (UC-001~UC-023)
  │   (υπάρχει σε contacts)
  │
  └── Άγνωστος αλλά ───────→ NEW SENDER queue
      legitimate               ├── Πιθανός πελάτης → UC-005 (αναζήτηση) / UC-001 (ραντεβού)
      (ρωτάει κάτι σχετικό)   ├── Πιθανός προμηθευτής → Αρχειοθέτηση "potential supplier"
                               └── Αδιευκρίνιστο → Operator αξιολογεί
```

**Sender Classification πεδία** (προστίθεται στο UnderstandingResult):
- `senderType`: `known_contact` | `unknown_legitimate` | `cold_outreach` | `spam` | `phishing`
- `threatLevel`: `clean` | `low` | `medium` | `high`
- `threatReason`: string (αν threatLevel > clean)

---

### Company Detection - Multi-Signal

Σε κάθε εισερχόμενο μήνυμα, το AI εφαρμόζει **4 σήματα κατά σειρά προτεραιότητας** για να αναγνωρίσει σε ποια εταιρεία/έργο ανήκει:

| Προτεραιότητα | Σήμα | Περιγραφή | Αξιοπιστία |
|---------------|-------|-----------|------------|
| 1 | **Email παραλήπτη** | Αν η εταιρεία έχει δικό της email (π.χ. `info@alysida.gr`). Mailgun routing. | Υψηλή |
| 2 | **Γνωστή επαφή** | Ο αποστολέας υπάρχει ως contact στο σύστημα, συνδεδεμένος με εταιρεία/έργο. | Υψηλή |
| 3 | **Περιεχόμενο μηνύματος** | AI αναγνωρίζει αναφορές σε έργο, περιοχή, κτίριο μέσα στο κείμενο. | Μέτρια |
| 4 | **Fallback** | AI ρωτάει ευγενικά τον αποστολέα, ή δρομολογεί σε γενικό υπεύθυνο. | — |

**Υβριδικό μοντέλο (DECIDED)**: Κάθε εταιρεία μπορεί **προαιρετικά** να έχει δικό της inbound email ή όχι. Αν δεν έχει, το σύστημα προχωράει στα Σήματα 2, 3, 4. Αυτό επιτρέπει:
- Εταιρείες ΜΕ δικό τους email → Σήμα 1 πιάνει αμέσως (100% βεβαιότητα)
- Εταιρείες ΧΩΡΙΣ δικό τους email → Fallback στα υπόλοιπα σήματα
- Σταδιακή προσθήκη emails ανά εταιρεία, χωρίς να σπάει τίποτα

---

### Company-Level Configuration (Tenant Settings)

Κάθε εταιρεία στο σύστημα έχει τις **δικές της ρυθμίσεις**:

```
Company: "ΠΑΓΩΝΗΣ ΟΕ"
  └─ settings:
       └─ inboundEmail: "info@pagonis-oe.gr"  ← (προαιρετικό)
       └─ accounting:
            └─ email: "logistirio-b@example.gr"
            └─ contactName: "Κος Χ"
       └─ roles:  ← (ένα άτομο μπορεί να έχει πολλαπλούς ρόλους)
            └─ architect: "userId_100"           ← Αρχιτέκτονας
            └─ civilEngineer: "userId_101"       ← Πολιτικός μηχανικός
            └─ mechanicalEngineer: "userId_103"  ← Μηχανολόγος μηχανικός
            └─ siteManager: "userId_102"         ← Εργοταξιάρχης
            └─ salesManager: "userId_123"        ← Υπεύθυνος πωλήσεων
            └─ procurementManager: "userId_130"  ← Υπεύθυνος προμηθειών
            └─ secretary: "userId_140"           ← Γραμματέας
            └─ accountant: "userId_150"          ← Λογιστής
            └─ owner: "userId_001"               ← Ιδιοκτήτης εταιρείας
            └─ defaultResponsible: "userId_001"  ← Γενικός υπεύθυνος (fallback)
       └─ escalation:
            └─ reminderMinutes: 30
            └─ urgentMinutes: 120
            └─ timezone: "Europe/Athens"
            └─ businessHoursStart: "08:00"
            └─ businessHoursEnd: "20:00"
            └─ weekendDays: ["Saturday", "Sunday"]
            └─ holidays: ["2026-01-01", "2026-01-06", ...]
       └─ ai:
            └─ autoApproveThreshold: 90
            └─ learningMode: false
       └─ sales:
            └─ priceDisclosure: "full"  ← ("full" | "range" | "hidden") - ανά project configurable
```

**Πραγματικό παράδειγμα (δομή Γιώργου)**:

| Οντότητα | Τύπος | Λογιστήριο | inboundEmail | Έργα |
|----------|-------|------------|--------------|------|
| **Γ. Παγώνης** (ελ. επαγγελματίας) | Ατομική | Λογιστής Α | _(κενό - fallback σε Σήμα 2,3,4)_ | Μελέτες, άδειες, ΠΕΑ |
| **Ν.Χ.Γ. ΠΑΓΩΝΗΣ & ΣΙΑ Ο.Ε.** | ΟΕ | Λογιστήριο Β | `info@pagonis-oe.gr` | Έργο Κορδελιού Θεσ/νίκης |
| **[Ανώνυμη Εταιρεία]** | ΑΕ | Λογιστήριο Γ | `info@pagonis-ae.gr` | Έργο Θέρμη Θεσ/νίκης |

**Αρχή**: Κάθε εταιρεία = αυτόνομη μονάδα με δικές ρυθμίσεις. Αν αύριο η εφαρμογή πουληθεί, ο νέος χρήστης βάζει τις δικές του εταιρείες.

---

### Role-Based Routing

Κάθε τύπος αιτήματος δρομολογείται στον κατάλληλο ρόλο. **Ένα άτομο μπορεί να έχει πολλαπλούς ρόλους** (π.χ. ιδιοκτήτης = αρχιτέκτονας + υπ. πωλήσεων + γεν. υπεύθυνος).

| Τύπος Αιτήματος | Πρωτεύων Ρόλος | Fallback |
|------------------|----------------|----------|
| Ραντεβού πελάτη (UC-001) | `salesManager` | `defaultResponsible` |
| Τιμολόγιο προμηθευτή (UC-002) | `procurementManager` | `accountant` → `defaultResponsible` |
| Έγγραφα για συμβόλαιο (UC-003) | `secretary` | `salesManager` → `defaultResponsible` |
| Αναζήτηση ακινήτου (UC-005) | `salesManager` | `defaultResponsible` |
| Τεχνικό θέμα / μελέτη | `architect` ή `civilEngineer` | `defaultResponsible` |
| Η/Μ εγκαταστάσεις / θέρμανση / ψύξη | `mechanicalEngineer` | `defaultResponsible` |
| Θέμα εργοταξίου | `siteManager` | `defaultResponsible` |
| Λογιστικό / φορολογικό | `accountant` | `defaultResponsible` |
| Γενικό / ασαφές | `secretary` | `defaultResponsible` |
| Escalation φάση 4 (κρίσιμο) | `owner` | — |

**Κανόνας**: Αν ο ρόλος δεν έχει ανατεθεί σε κάποιον → πάντα fallback στον `defaultResponsible`.

---

### Escalation Protocol

Όταν το AI στέλνει πρόταση (Propose) σε υπεύθυνο και **δεν λαμβάνει απάντηση**, ενεργοποιείται αυτόματα:

| Φάση | Χρόνος | Ενέργεια | Αποδέκτης |
|------|--------|----------|-----------|
| **1. Reminder** | +30 λεπτά | 1η υπενθύμιση (notification in-app + email) | Υπεύθυνος |
| **2. Urgent Reminder** | +2 ώρες | 2η υπενθύμιση με ένδειξη **ΕΠΕΙΓΟΝ** | Υπεύθυνος |
| **3. Escalation** | +4 ώρες | Κλιμάκωση → "Ο [υπεύθυνος] δεν απάντησε στο αίτημα του [X] εδώ και 4 ώρες" | Προϊστάμενος / Αναπληρωτής |
| **4. Critical** | +8 ώρες (εργάσιμες) | Κρίσιμη κλιμάκωση, σήμανση **ΕΚΠΡΟΘΕΣΜΟ** | Διαχειριστής / Ιδιοκτήτης εταιρείας |

**Ενημέρωση πελάτη/αποστολέα**:
- Αρχική: Ήδη στάλθηκε μέσω Acknowledge ("Λάβαμε το αίτημά σας")
- +4 ώρες (αν δεν έχει κλείσει): "Εργαζόμαστε στο αίτημά σας, θα σας ενημερώσουμε σύντομα"

**Κανόνες**:
- Μόνο **εργάσιμες ώρες** (Δευ-Παρ, 08:00-20:00) - δεν στέλνει reminders μεσάνυχτα/Σαββατοκύριακο
- **Configurable ανά εταιρεία** - κάθε εταιρεία ρυθμίζει τα χρονικά όρια
- **Priority-based**: Επείγοντα αιτήματα → μισοί χρόνοι (15 λεπτά, 1 ώρα, 2 ώρες, 4 ώρες)

### Escalation Precision - Timezone & Pause-the-Clock

Κάθε εταιρεία ορίζει timezone στο Company-Level Configuration:
```
└─ escalation:
     └─ timezone: "Europe/Athens"
     └─ businessHoursStart: "08:00"
     └─ businessHoursEnd: "20:00"
     └─ weekendDays: ["Saturday", "Sunday"]
     └─ holidays: ["2026-01-01", "2026-01-06", "2026-03-25", ...]
```

**Pause-the-Clock Semantics**:
- Αν ένα escalation timer λήγει **εκτός εργάσιμων ωρών** (π.χ. 20:00), ο χρόνος **παγώνει**
- Συνεχίζει στις 08:00 της **επόμενης εργάσιμης ημέρας**
- Παράδειγμα: Reminder στις 19:45 Παρασκευή → urgent reminder μετράει από 08:00 Δευτέρα
- Αργίες: Ίδια λογική - pause-the-clock

---

### Γενικός Κανόνας Διευκρινίσεων

**ΚΑΝΟΝΑΣ**: Σε **οποιαδήποτε περίπτωση** το AI δεν μπορεί να ταυτοποιήσει πλήρως ένα αίτημα (ποιος, τι, για ποιον, ποιο έργο), **πάντοτε ζητάει ευγενικά διευκρινίσεις**:

> "Λάβαμε το αίτημά σας. Παρακαλούμε δώστε μας περισσότερες πληροφορίες:
> - Ποιος είναι ο σκοπός του αιτήματός σας;
> - Ποιον πελάτη/εταιρεία αφορά;
> - Ποιο έργο αφορά;
> Ευχαριστούμε!"

Αυτός ο κανόνας εφαρμόζεται **παντού** - email, Telegram, in-app, κ.λπ. Το AI **ποτέ δεν μαντεύει** - αν δεν είναι σίγουρο, ρωτάει.

---

### Γλώσσα Απάντησης

**ΚΑΝΟΝΑΣ**: Το AI απαντάει **πάντα στη γλώσσα του αποστολέα**. Αναγνωρίζει αυτόματα τη γλώσσα του εισερχομένου μηνύματος και απαντάει στην ίδια γλώσσα:
- Ελληνικά → απάντηση στα ελληνικά
- Αγγλικά → απάντηση στα αγγλικά
- Ιταλικά → απάντηση στα ιταλικά
- Οποιαδήποτε γλώσσα → απάντηση στην ίδια γλώσσα

---

### Διαχείριση Ελλιπών Εγγράφων

Όταν το AI αναζητά έγγραφα στο file system και **δεν βρίσκει όλα τα ζητούμενα**:

| Βήμα | Ενέργεια |
|------|----------|
| **1. Αναφορά ευρημάτων** | Ενημερώνει τον υπεύθυνο (βάσει company role settings): "Βρέθηκαν 3/5 έγγραφα" |
| **2. Λίστα ευρεθέντων** | Εμφανίζει τα ονόματα + τις διαδρομές (file paths) των εγγράφων που βρήκε |
| **3. Λίστα ελλειπόντων** | Εμφανίζει ποια έγγραφα λείπουν |
| **4. Δημιουργία Task** | Ανοίγει αυτόματα Task/Εργασία: "Αναζήτηση/Δημιουργία εγγράφων: [λίστα ελλειπόντων]" |
| **5. Ανάθεση** | Ο υπεύθυνος αποφασίζει ποιος θα τα συγκεντρώσει (βάσει ρόλων εταιρείας) |

**Ποιος ειδοποιείται** (βάσει Company-Level Configuration):
- Εξαρτάται από τον τύπο αιτήματος (π.χ. πώληση → `salesManager`)
- Αν δεν υπάρχει ειδικός ρόλος → `defaultResponsible` της εταιρείας
- Αν η εταιρεία δεν έχει γραμματέα → ο ιδιοκτήτης/συνιδιοκτήτης/μέτοχος αποφασίζει

---

### Audit Trail

**ΚΑΝΟΝΑΣ**: Κάθε ενέργεια του AI καταγράφεται σε **πλήρες audit trail** με δυνατότητα αναζήτησης, φιλτραρίσματος και αναφορών.

**Τι καταγράφεται** (κάθε εγγραφή):

| Πεδίο | Περιγραφή |
|-------|-----------|
| `timestamp` | Πότε έγινε η ενέργεια |
| `actionType` | Τύπος (email_received, invoice_processed, appointment_proposed, document_sent, κ.λπ.) |
| `useCase` | Ποιο σενάριο (UC-001, UC-002, UC-003, UC-005, κ.λπ.) |
| `company` | Ποια εταιρεία αφορά |
| `project` | Ποιο έργο αφορά |
| `initiatedBy` | Ποιος ξεκίνησε (αποστολέας email, ενδιαφερόμενος, κ.λπ.) |
| `handledBy` | Ποιος υπεύθυνος ενεπλάκη (ή "AI-auto" αν ήταν αυτόματο) |
| `aiConfidence` | Βαθμός βεβαιότητας AI (%) |
| `aiModel` | Ποιο model χρησιμοποιήθηκε (tier + specific model) |
| `decision` | Τι αποφασίστηκε (approved, rejected, modified, auto-processed) |
| `details` | Λεπτομέρειες (ποσό τιμολογίου, ημερομηνία ραντεβού, έγγραφα που στάλθηκαν, κ.λπ.) |
| `duration` | Χρόνος επεξεργασίας (ms) |

**Δυνατότητες UI**:
- **Αναζήτηση**: Ελεύθερο κείμενο (π.χ. "τιμολόγιο ΑΛΥΣΙΔΑ")
- **Φιλτράρισμα**: Ανά εταιρεία, έργο, τύπο ενέργειας, χρονικό διάστημα, υπεύθυνο
- **Αναφορές (Reports)**:
  - "Τι τιμολόγια επεξεργάστηκε το AI τον Φεβρουάριο;"
  - "Πόσοι ενδιαφερόμενοι ρώτησαν για ακίνητα αυτή την εβδομάδα;"
  - "Ποια αιτήματα εκκρεμούν;"
  - "Πόσα αιτήματα χειρίστηκε αυτόματα vs με έγκριση;"
  - Στατιστικά: conversion rate (leads → contacts), μέσος χρόνος απόκρισης, κ.λπ.
