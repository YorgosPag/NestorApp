# UC-030: Μικροέξοδα Εργοταξίου (Petty Cash Management)

> **Parent ADR**: [ADR-169 - Modular AI Architecture](../../reference/adrs/ADR-169-modular-ai-architecture.md)
> **Pipeline**: [pipeline.md](../pipeline.md)
> **Σχετικά UCs**: [UC-025](./UC-025-project-costing.md) (κοστολόγηση), [UC-026](./UC-026-cash-flow.md) (ταμειακές ροές), [UC-002](./UC-002-invoice.md) (τιμολόγια), [UC-024](./UC-024-labor-compliance.md) (εργατικά)

---

## Trigger

Ο `siteManager` ή άλλος εξουσιοδοτημένος χρήστης καταγράφει μικροέξοδο εργοταξίου μέσω app (φωτογραφία απόδειξης + ποσό + σκοπός).

---

## Επισκόπηση

```
ΤΑΜΕΙΟ ΜΙΚΡΟΕΞΟΔΩΝ → ΕΞΟΔΟ → ΚΑΤΑΓΡΑΦΗ (app) → ΕΓΚΡΙΣΗ (αν >limit) → ΚΟΣΤΟΛΟΓΗΣΗ → REPLENISHMENT
```

**Τι είναι**: Σύστημα διαχείρισης μικροεξόδων εργοταξίου (petty cash) — μικρές, καθημερινές δαπάνες που πληρώνονται σε μετρητά και ΔΕΝ περνούν μέσω τιμολογίου.

**Γιατί χρειάζεται**: Σε κάθε εργοτάξιο υπάρχουν καθημερινά μικροέξοδα (καφέδες εργατών, μικρουλικά από κοντινό μαγαζί, ταξί, φωτοτυπίες, κλπ.) που δεν δικαιολογούν πλήρη διαδικασία τιμολογίου αλλά ΠΡΕΠΕΙ να καταγράφονται.

**Enterprise standard**: SAP (Petty Cash Management), Oracle (Cash Expenses), Procore (Field Expenses) — ΟΛΕΣ οι μεγάλες εταιρείες έχουν petty cash module.

---

## 1. Νομικό Πλαίσιο (Ελλάδα)

### Τι επιτρέπεται

| Κανόνας | Λεπτομέρεια | Πηγή |
|---------|-------------|------|
| **Πληρωμή σε μετρητά** | Επιτρέπεται μέχρι **500€** ανά συναλλαγή | Ν.4446/2016, αρ. 69 |
| **Πάνω από 500€** | ΥΠΟΧΡΕΩΤΙΚΑ μέσω τράπεζας (μεταφορά, κάρτα, επιταγή) | Ν.4446/2016 |
| **Απόδειξη λιανικής** | Αρκεί για μικροέξοδα (δεν χρειάζεται τιμολόγιο) | ΕΛΠ / ΚΦΑΣ |
| **Χωρίς παραστατικό** | Μόνο εξαιρετικά (π.χ. parking meter, φιλοδώρημα) — πρέπει υπεύθυνη δήλωση | Λογιστική πρακτική |
| **ΦΠΑ** | Δεν εκπίπτει χωρίς τιμολόγιο — μόνο λιανική απόδειξη | ΦΠΑ νομοθεσία |

### Τι ΔΕΝ επιτρέπεται

| Απαγόρευση | Λόγος |
|-----------|-------|
| Πληρωμή υπεργολάβου σε μετρητά | Απαιτείται τιμολόγιο + τραπεζική πληρωμή |
| Πληρωμή μισθοδοσίας σε μετρητά | Υποχρεωτικά μέσω τράπεζας (Ν.4254/2014) |
| Συναλλαγή >500€ σε μετρητά | Παράνομη — πρόστιμα |
| Αγορά υλικών >500€ σε μετρητά | Πρέπει τιμολόγιο + τράπεζα |

**ΚΑΝΟΝΑΣ AI**: Κάθε μικροέξοδο >500€ → 🔴 BLOCK + Alert: "Υπέρβαση νόμιμου ορίου μετρητών"

---

## 2. Δομή Ταμείου Μικροεξόδων (Petty Cash Fund)

### 2.1: Δημιουργία Ταμείου

| Πεδίο | Τύπος | Υποχρεωτικό | Σημειώσεις |
|-------|-------|-------------|-----------|
| `fundId` | string | ✅ | Αυτόματο |
| `projectId` | reference | ✅ | Σε ποιο εργοτάξιο |
| `custodian` | reference (contact) | ✅ | Ποιος κρατάει τα χρήματα (συνήθως `siteManager`) |
| `initialAmount` | number | ✅ | Αρχικό ποσό ταμείου (π.χ. 500€) |
| `currentBalance` | number | ✅ | Τρέχον υπόλοιπο (αυτόματα) |
| `maxPerTransaction` | number | ✅ | Μέγιστο ανά συναλλαγή (default: 100€) |
| `maxMonthly` | number | ✅ | Μέγιστο μηνιαίο (default: 2.000€) |
| `approvalThreshold` | number | ✅ | Πάνω από αυτό → χρειάζεται έγκριση (default: 50€) |
| `status` | enum | ✅ | `active` / `suspended` / `closed` |
| `createdAt` | datetime | ✅ | Server timestamp |
| `createdBy` | reference | ✅ | Ποιος δημιούργησε (συνήθως `owner`) |

**ΚΑΝΟΝΑΣ**: Κάθε project μπορεί να έχει **ένα** ταμείο μικροεξόδων. Ο `custodian` είναι υπεύθυνος.

### 2.2: Config-driven limits

```
// Στο system/settings → pettyCash
{
  "maxPerTransaction": 100,       // Μέγιστο ανά συναλλαγή (€)
  "legalCashLimit": 500,          // Νομικό μέγιστο μετρητών (Ν.4446/2016)
  "approvalThreshold": 50,        // Πάνω από αυτό → χρειάζεται έγκριση
  "maxMonthlyPerProject": 2000,   // Μέγιστο μηνιαίο ανά project
  "replenishmentThreshold": 20,   // % υπολοίπου → trigger replenishment
  "requirePhoto": true,           // Υποχρεωτική φωτογραφία απόδειξης
  "categories": [
    "consumables", "transport", "food_beverages",
    "office_supplies", "tools_small", "cleaning",
    "communication", "parking_tolls", "other"
  ]
}
```

---

## 3. Κατηγορίες Μικροεξόδων

| Κατηγορία | Κωδικός | Παραδείγματα | Συνηθισμένο ποσό |
|-----------|---------|-------------|-----------------|
| **Αναλώσιμα εργοταξίου** | `consumables` | Βίδες, σιλικόνη, ταινία, μικρουλικά | 5-50€ |
| **Μεταφορές** | `transport` | Ταξί, βενζίνη αυτοκινήτου, διόδια | 10-80€ |
| **Τρόφιμα & ποτά** | `food_beverages` | Καφέδες εργατών, νερά, φαγητό | 10-50€ |
| **Γραφική ύλη** | `office_supplies` | Φωτοτυπίες, εκτυπώσεις, χαρτικά | 5-30€ |
| **Μικρά εργαλεία** | `tools_small` | Κατσαβίδι, πένσα, μέτρο (αντικατάσταση) | 10-50€ |
| **Καθαριότητα** | `cleaning` | Σακούλες, σκούπες, καθαριστικά | 10-30€ |
| **Επικοινωνίες** | `communication` | Κάρτα κινητού, courier τοπικό | 5-20€ |
| **Parking / Διόδια** | `parking_tolls` | Parking, διόδια | 2-15€ |
| **Άλλο** | `other` | Οτιδήποτε δεν εντάσσεται παραπάνω | — |

---

## 4. Ροή Καταγραφής Μικροεξόδου

### 4.1: Βασική ροή

```
ΕΞΟΔΟ στο εργοτάξιο (π.χ. αγορά βιδών)
     ↓
siteManager → App: "Νέο μικροέξοδο"
     ↓
Φωτογραφία απόδειξης (υποχρεωτική αν requirePhoto: true)
     ↓
Συμπλήρωση: Ποσό + Κατηγορία + Περιγραφή
     ↓
AI ελέγχει:
  → Ποσό < maxPerTransaction? → ✅
  → Ποσό < legalCashLimit (500€)? → ✅
  → Υπόλοιπο ταμείου αρκετό? → ✅
  → Μηνιαίο σύνολο < maxMonthly? → ✅
     ↓
Ποσό < approvalThreshold? → ✅ Αυτόματη έγκριση
Ποσό ≥ approvalThreshold? → 🟡 Αναμονή έγκρισης owner/accountant
     ↓
ΚΑΤΑΓΡΑΦΗ: Immutable record + ενημέρωση υπολοίπου
```

### 4.2: Φόρμα καταγραφής

| Πεδίο | Τύπος | Υποχρεωτικό | Σημειώσεις |
|-------|-------|-------------|-----------|
| `id` | string | ✅ | Αυτόματο |
| `fundId` | reference | ✅ | Ποιο ταμείο |
| `projectId` | reference | ✅ | Ποιο εργοτάξιο |
| `amount` | number | ✅ | Ποσό σε € |
| `category` | enum | ✅ | Βλ. κατηγορίες παραπάνω |
| `description` | string | ✅ | Τι αγοράστηκε |
| `vendor` | string | — | Από πού αγοράστηκε (π.χ. "Κάβα Γιάννης") |
| `receiptPhoto` | attachment | Config-driven | Φωτογραφία απόδειξης |
| `hasReceipt` | boolean | ✅ | Υπάρχει απόδειξη; |
| `paidBy` | reference (contact) | ✅ | Ποιος πλήρωσε |
| `approvedBy` | reference (contact) | Αν > threshold | Ποιος ενέκρινε |
| `status` | enum | ✅ | `pending` / `approved` / `rejected` / `reimbursed` |
| `timestamp` | datetime | ✅ | Server timestamp |
| `costCategory` | enum | — | Mapping σε UC-025 κατηγορία (auto ή χειροκίνητα) |

### 4.3: VISION Analysis (φωτογραφία απόδειξης)

Αν υποβληθεί φωτογραφία, η AI (VISION tier) εξάγει:
- Ποσό (cross-check με αυτό που δήλωσε ο χρήστης)
- Ημερομηνία
- Όνομα καταστήματος
- ΑΦΜ καταστήματος (αν αναγράφεται)

**Alert αν**: Το ποσό στη φωτογραφία ≠ δηλωθέν ποσό → 🟡 Warning

---

## 5. Εγκρίσεις (Approval Workflow)

| Ποσό | Έγκριση | Ποιος |
|------|---------|-------|
| **< approvalThreshold** (π.χ. <50€) | Αυτόματη | — (ο custodian αρκεί) |
| **≥ approvalThreshold & < 200€** | Μονή έγκριση | `owner` ή `accountant` |
| **≥ 200€ & < 500€** | Διπλή έγκριση | `owner` ΚΑΙ `accountant` |
| **≥ 500€** | 🔴 BLOCK | Δεν γίνεται σε μετρητά — πρέπει τιμολόγιο (UC-002/UC-016) |

### Ροή έγκρισης

```
Μικροέξοδο 75€ (> threshold 50€)
     ↓
🟡 NOTIFICATION → owner: "Ο [siteManager] ζητά έγκριση μικροεξόδου 75€ — Βίδες ανοξείδωτες"
     ↓
owner → App: "Εγκρίνω" ή "Απορρίπτω" (+ λόγος αν rejection)
     ↓
✅ Εγκρίθηκε → Καταγραφή + ενημέρωση υπολοίπου
❌ Απορρίφθηκε → Alert custodian + λόγος
```

---

## 6. Replenishment (Ανανέωση Ταμείου)

### 6.1: Αυτόματο trigger

```
Υπόλοιπο ταμείου < replenishmentThreshold (20%)
     ↓
AI → Alert accountant:
  "Το ταμείο μικροεξόδων του [Project] χρειάζεται ανανέωση.
   Αρχικό: 500€ | Υπόλοιπο: 85€ (17%) | Δαπάνες μήνα: 415€
   Δαπάνες ανά κατηγορία: Αναλώσιμα 180€, Μεταφορές 120€, ..."
     ↓
accountant εγκρίνει replenishment
     ↓
Νέα κατάθεση → Ταμείο ανανεώνεται → Ιστορικό καταγράφεται
```

### 6.2: Μηνιαία εκκαθάριση

Κάθε τέλος μήνα:
1. AI δημιουργεί **αναφορά μικροεξόδων** ανά project
2. Αποδείξεις → παραδίδονται στο λογιστήριο (σκαναρισμένες μέσω app)
3. `accountant` αντιστοιχίζει δαπάνες σε λογιστικές κατηγορίες
4. Replenishment ταμείου για τον επόμενο μήνα

---

## 7. Αναφορές (Reports)

| Αναφορά | Συχνότητα | Παραλήπτης | Περιεχόμενο |
|---------|-----------|------------|------------|
| **Ημερήσια σύνοψη** | Ημερήσια | `siteManager` (custodian) | Δαπάνες σήμερα, υπόλοιπο |
| **Εβδομαδιαία αναφορά** | Εβδομαδιαία | `owner` | Top κατηγορίες, trends, anomalies |
| **Μηνιαία εκκαθάριση** | Μηνιαία | `accountant` | Πλήρης λίστα δαπανών + αποδείξεις (για λογιστήριο) |
| **Σύγκριση projects** | Μηνιαία | `owner` | Μικροέξοδα ανά project — ποιο ξοδεύει περισσότερο; |

---

## 8. AI Alerts

| Alert | Trigger | Level | Αρμόδιος |
|-------|---------|-------|----------|
| Ποσό > νόμιμο όριο (500€) | Ποσό ≥ 500€ | 🔴 BLOCK | `custodian` — "Δεν γίνεται σε μετρητά" |
| Ποσό > per-transaction limit | Ποσό > maxPerTransaction | 🔴 BLOCK | `custodian` — "Υπέρβαση ορίου" |
| Μηνιαίο σύνολο > limit | Σύνολο μήνα > maxMonthly | 🟠 High | `owner` + `accountant` |
| Ταμείο χαμηλό | Υπόλοιπο < 20% | 🟡 Medium | `accountant` — replenishment needed |
| Ποσό φωτογραφίας ≠ δηλωθέν | VISION cross-check | 🟡 Medium | `owner` — πιθανό λάθος |
| Χωρίς απόδειξη | hasReceipt: false | 🟡 Medium | `accountant` — "Λείπει απόδειξη" |
| Ασυνήθιστη κατηγορία | Πολλά "other" σε σειρά | 🟡 Low | `owner` — ελεγχος |
| Spike μηνιαίων εξόδων | Μήνας > 150% μέσου όρου | 🟡 Medium | `owner` — "Αύξηση μικροεξόδων" |

---

## 9. Σύνδεση με UC-025 (Κοστολόγηση)

Κάθε μικροέξοδο αντιστοιχίζεται **αυτόματα** στο budget του project:

| Κατηγορία μικροεξόδου | UC-025 Budget Category | Mapping |
|----------------------|----------------------|---------|
| `consumables` | `MATERIALS` | Auto |
| `transport` | `OVERHEAD` | Auto |
| `food_beverages` | `OVERHEAD` | Auto |
| `office_supplies` | `OVERHEAD` | Auto |
| `tools_small` | `EQUIPMENT` | Auto |
| `cleaning` | `OVERHEAD` | Auto |
| `communication` | `OVERHEAD` | Auto |
| `parking_tolls` | `OVERHEAD` | Auto |
| `other` | `CONTINGENCY` | Χειροκίνητο (accountant αντιστοιχίζει) |

**AI auto-categorization**: Αν η κατηγορία δεν ταιριάζει με την περιγραφή → AI προτείνει σωστή κατηγορία (FAST tier).

---

## 10. Σύνδεση με UC-026 (Ταμειακές Ροές)

| Πεδίο Cash Flow | Πηγή UC-030 |
|-----------------|-------------|
| **Εκροές (OVERHEAD)** | Σύνολο μικροεξόδων μήνα ανά project |
| **Forecast** | AI χρησιμοποιεί ιστορικό μικροεξόδων για πρόβλεψη |
| **Replenishment** | Νέα εκροή κάθε φορά που ανανεώνεται το ταμείο |

---

## Data Model — Σύνδεση με Contacts System

### Οντότητες ↔ Contacts

| Οντότητα UC-030 | Contact Type | Relationship | Σημασία |
|-----------------|-------------|--------------|---------|
| **Custodian** (υπεύθυνος ταμείου) | `individual` contact | `employee`/`manager` rel. | Ποιος κρατάει τα χρήματα |
| **Ο κάνει το έξοδο** (paidBy) | `individual` contact | `employee` rel. | Ποιος πλήρωσε στο μαγαζί |
| **Εγκρίνων** (approvedBy) | `individual` contact | `manager`/`executive` rel. | Ποιος ενέκρινε |
| **Κατάστημα** (vendor) | Free text ή `company` contact | Αν επαναλαμβανόμενο → contact | Από πού αγοράστηκε |

### Ροή

```
siteManager (individual contact) = custodian
     ↓
Πληρώνει μικροέξοδο → paidBy = contact.id
     ↓
Αν > threshold → approvedBy = owner (individual contact)
     ↓
Μηνιαία εκκαθάριση → accountant (individual contact)
```

---

## Routing

| Λειτουργία | Κύριος αρμόδιος | Εμπλεκόμενοι |
|-----------|-----------------|-------------|
| Καταγραφή μικροεξόδου | `siteManager` (custodian) | — |
| Έγκριση (>threshold) | `owner` ή `accountant` | `siteManager` (ειδοποίηση) |
| Replenishment | `accountant` | `owner` (έγκριση) |
| Μηνιαία εκκαθάριση | `accountant` | `owner` (αναφορά) |
| Alerts | AI → αρμόδιος | Βλ. πίνακα alerts |

---

## AI Model Tier

- **FAST**: Validation (limits, categories), alerts, υπολογισμός υπολοίπου, auto-categorization
- **VISION**: Ανάγνωση φωτογραφίας απόδειξης → εξαγωγή ποσού, cross-check
- **QUALITY**: Μηνιαίες αναφορές, trend analysis, anomaly detection, σύγκριση projects

---

## Dashboard

| Widget | Περιεχόμενο |
|--------|-------------|
| **Υπόλοιπο ταμείου** | Αρχικό - Δαπάνες = Τρέχον (progress bar) |
| **Δαπάνες σήμερα** | Λίστα σημερινών μικροεξόδων |
| **Top κατηγορίες** | Pie chart κατηγοριών (μήνα) |
| **Εκκρεμείς εγκρίσεις** | Μικροέξοδα που περιμένουν έγκριση |
| **Trend** | Γραμμικό — μικροέξοδα ανά εβδομάδα (3 μήνες) |

---

## Κανόνες

### Νομικοί
- **500€ = απόλυτο όριο**: Καμία πληρωμή σε μετρητά πάνω από 500€ (Ν.4446/2016)
- **Απόδειξη = υποχρεωτική**: Κάθε μικροέξοδο πρέπει να έχει απόδειξη (ή υπεύθυνη δήλωση)
- **Μισθοδοσία εξαιρείται**: Τα μικροέξοδα ΔΕΝ χρησιμοποιούνται για πληρωμή εργατών
- **Υπεργολάβοι εξαιρούνται**: Τα μικροέξοδα ΔΕΝ χρησιμοποιούνται για πληρωμή υπεργολάβων

### Λειτουργικοί
- **Ένα ταμείο ανά project**: Κάθε εργοτάξιο έχει ακριβώς ένα petty cash fund
- **Ένας custodian**: Ένα πρόσωπο υπεύθυνο ανά ταμείο (μεταβιβάσιμο)
- **Config-driven limits**: Όλα τα όρια ρυθμίζονται κεντρικά (δεν είναι hardcoded)
- **Immutable records**: Κανένα μικροέξοδο δεν μπορεί να τροποποιηθεί ή διαγραφεί μετά την καταγραφή
- **Replenishment = audit trail**: Κάθε ανανέωση ταμείου καταγράφεται
- **AI δεν πληρώνει**: Η AI καταγράφει, ελέγχει, ειδοποιεί — ο χρήστης πληρώνει
- **Μηνιαία εκκαθάριση = υποχρεωτική**: Κάθε τέλος μήνα, αποδείξεις στο λογιστήριο

### Σύνδεση με budget
- **Κάθε μικροέξοδο → budget category**: Αυτόματη αντιστοίχιση στο UC-025
- **Κάθε μικροέξοδο → cash flow**: Αυτόματη ενημέρωση εκροών στο UC-026
- **Contacts = SSoT**: Custodian, paidBy, approvedBy = `individual` contacts (ΟΧΙ free text)

---

## Σύνδεση με Υπάρχοντα UCs

| UC | Σύνδεση |
|----|---------|
| **UC-002** (Τιμολόγιο) | Αν ποσό > 500€ → redirect σε τιμολόγιο (UC-002) |
| **UC-016** (Προμήθεια) | Αν αγορά υλικού > limit → redirect σε procurement (UC-016) |
| **UC-024** (Εργατικά) | Μικροέξοδα ΔΕΝ χρησιμοποιούνται για μισθοδοσία |
| **UC-025** (Κοστολόγηση) | Auto-mapping σε budget categories (MATERIALS, OVERHEAD, κλπ.) |
| **UC-026** (Ταμειακές Ροές) | Μικροέξοδα = μικρές εκροές στο forecast |
| **UC-029** (Βάση Γνώσης) | "Πόσα ξοδέψαμε σε αναλώσιμα στο [project];" → AI αντλεί από petty cash records |
