# UC-002: Τιμολόγιο Προμηθευτή

> **Parent ADR**: [ADR-169 - Modular AI Architecture](../../reference/adrs/ADR-169-modular-ai-architecture.md)
> **Pipeline**: [pipeline.md](../pipeline.md)
> **Prerequisites**: [PRE-003](../prerequisites.md#pre-003-procurement-system) (για 3-Way Matching)

---

## Trigger

Προμηθευτής στέλνει τιμολόγιο μέσω email

## Ροή

### 1. Intake

Email με συνημμένο τιμολόγιο εισέρχεται

### 2. Format Detection & Routing (3 διαδρομές)

**Α. PDF ψηφιακό (από λογισμικό)**:
- Εξαγωγή κειμένου χωρίς Vision (χαμηλό κόστος, υψηλή ακρίβεια)
- → Κανονική ροή AI ανάλυσης

**Β. Σκαναρισμένο (PDF εικόνα)**:
- Vision AI αναγνώριση μέσω VISION tier (ίδιο API/infra, αλλά κόστος tokens ανά χρήση - multimodal)
- → Κανονική ροή AI ανάλυσης

**Γ. Φωτογραφία (μπακάλικο)**:
- Κρατάμε ως backup αλλά **ΔΕΝ** επεξεργαζόμαστε αυτόματα
- Αυτόματη απάντηση στον αποστολέα: "Λάβαμε το τιμολόγιο αλλά η εικόνα δεν είναι κατάλληλη για επεξεργασία. Παρακαλούμε επαναστείλτε σε PDF ή σκαναρισμένο."
- Ενημέρωση υπευθύνου: "Λάβαμε τιμολόγιο-φωτογραφία από [X], ζητήθηκε επανααποστολή"

### 3. Understand

AI διαβάζει το τιμολόγιο και αναγνωρίζει:
- **Τύπος παραστατικού**: Τιμολόγιο / Δελτίο Αποστολής / Τιμολόγιο-Δελτίο Αποστολής (ενιαίο)
- Ποια **εταιρεία** αφορά
- Ποιο **έργο** αφορά
- Τι **εργασία/υλικά** (θεμελίωση, σκυρόδεμα, σίδηρος, πλακίδια, σοβάδες κ.λπ.)
- Ποσό, ΑΦΜ, ημερομηνία
- **Confidence score** (βαθμός βεβαιότητας αναγνώρισης)

### 4. Αντιστοίχιση Τιμολογίου ↔ Δελτίου Αποστολής

| Τύπος παραστατικού | Ενέργεια |
|---------------------|----------|
| **Τιμολόγιο-Δελτίο Αποστολής** (ενιαίο 2-σε-1) | Δεν χρειάζεται αντιστοίχιση → κανονική ροή |
| **Τιμολόγιο** (χωριστό) | AI ψάχνει αντίστοιχο Δελτίο Αποστολής (ίδιος προμηθευτής, παρόμοια ημερομηνία, ίδια είδη/ποσά) |
| **Δελτίο Αποστολής** (χωριστό) | AI ψάχνει αντίστοιχο Τιμολόγιο (ίδια κριτήρια αναζήτησης) |

**Αν βρεθεί "αδερφάκι"** → αυτόματη σύνδεση, κανονική ροή

**Αν ΔΕΝ βρεθεί** (σημαντικό - ΔΕΝ ειδοποιούμε αυτόματα τον αποστολέα):
- **Ενημέρωση υπευθύνου** (εσωτερικά): "Τιμολόγιο [Χ] χωρίς αντίστοιχο Δελτίο Αποστολής"
- **Ενημέρωση λογιστηρίου**: Flag ότι λείπει δελτίο αποστολής
- **Ο υπεύθυνος αποφασίζει**:
  - **(α)** Ζήτα δελτίο από τον προμηθευτή
  - **(β)** Μαρκάρισέ το ως "υπηρεσία - χωρίς δελτίο" (συμβουλευτικές, μελέτες κ.λπ.)
  - **(γ)** Περίμενε - θα έρθει (μπορεί να ήρθε σε χαρτί/courier)

**Γιατί ΔΕΝ ειδοποιούμε αυτόματα τον προμηθευτή**:
- Υπηρεσίες (μελέτες, συμβουλευτικά) δεν έχουν δελτίο αποστολής - είναι νόμιμο
- Το δελτίο μπορεί να ήρθε σε άλλο κανάλι (χαρτί, courier)
- Θα ήταν αμήχανο να ζητάμε δελτίο σε παροχή υπηρεσιών

### 5. Lookup

Αντιστοίχιση εταιρείας/έργου/προμηθευτή στο σύστημα

### 6. AI Invoice Validation (5 επίπεδα)

**Επίπεδο 1 - Βασική Αναγνώριση (OCR/Vision)**:
- Στοιχεία εκδότη: Επωνυμία, ΑΦΜ, ΔΟΥ, διεύθυνση
- Στοιχεία λήπτη: Ποια εταιρεία μας (ΑΦΜ λήπτη)
- Αριθμός τιμολογίου & ημερομηνία έκδοσης
- Ποσά: Καθαρή αξία, ΦΠΑ (%), συνολικό
- Περιγραφή: Υλικά, εργασίες, υπηρεσίες

**Επίπεδο 2 - Αντιστοίχιση στο σύστημα**:
- Προμηθευτής γνωστός; → Αντιστοίχιση με υπάρχον Contact
- Εταιρεία: Ποια εταιρεία μας (βάσει ΑΦΜ λήπτη)
- Έργο: Ποιο έργο αφορά (περιγραφή, διεύθυνση, ιστορικό ίδιου προμηθευτή)
- Κατηγορία εργασίας: Σκυρόδεμα, σίδηρος, πλακίδια, σοβάδες κ.λπ.

**Επίπεδο 3 - Έξυπνοι Έλεγχοι**:
- **Διπλότυπο**: Υπάρχει ήδη τιμολόγιο με ίδιο αριθμό από ίδιο προμηθευτή;
- **Ασυνήθιστο ποσό**: Πολύ υψηλότερο/χαμηλότερο από συνηθισμένα αυτού του προμηθευτή;
- **ΦΠΑ σωστό**: Ποσοστό ΦΠΑ ταιριάζει; (24% κανονικό, 13% μειωμένο, κ.λπ.)
- **Μαθηματική ορθότητα**: Καθαρό + ΦΠΑ = Σύνολο;

**Επίπεδο 4 - Flags / Προειδοποιήσεις**:
- "Πρώτο τιμολόγιο από αυτόν τον προμηθευτή"
- "Ποσό 3x μεγαλύτερο από μέσο όρο"
- "Δεν αναγνωρίζω σε ποιο έργο ανήκει"
- "Πιθανό διπλότυπο (ίδιος αριθμός τιμολογίου)"
- "Τιμολόγιο χωρίς αντίστοιχο Δελτίο Αποστολής"

**Επίπεδο 5 - 3-Way Matching (μελλοντικό, απαιτεί PRE-003)**:
```
ΠΡΟΣΦΟΡΑ (Quote) ←→ ΤΙΜΟΛΟΓΙΟ (Invoice) ←→ ΠΑΡΑΛΑΒΗ (Delivery)
Τι συμφωνήσαμε       Τι μας χρεώνει          Τι πραγματικά λάβαμε
```
- **Τιμή μονάδας**: Ταιριάζει με την προσφορά;
- **Ποσότητα**: Ίδια με αυτή που παραγγείλαμε/λάβαμε;
- **Είδη**: Τα υλικά/εργασίες είναι αυτά που συμφωνήθηκαν;
- **Ανοχή παρέκκλισης**: ±5% αποδεκτό (configurable), πάνω από αυτό → flag στον υπεύθυνο
- Παράδειγμα: Προσφορά σκυρόδεμα 85€/m³, Τιμολόγιο 92€/m³ → "Παρέκκλιση +8.2% - ενημέρωση υπευθύνου"

### 7. Confidence-Based Routing (2 διαδρομές)

**Α. Υψηλή βεβαιότητα (confidence > 90%)**
Ο προμηθευτής είναι γνωστός, ΑΦΜ ταιριάζει, εταιρεία/έργο αναγνωρίστηκαν ξεκάθαρα:
- **Αυτόματη** καταχώριση στο file system (ονοματοδοσία βάσει κεντρικοποιημένων κανόνων)
- **Αυτόματη** προώθηση στο λογιστήριο
- **Ενημέρωση υπεύθυνου μετά** (informational): "Καταχωρήθηκε τιμολόγιο [ποσό] από [προμηθευτή] για [έργο]"
- Ο υπεύθυνος μπορεί να **διορθώσει** αν χρειαστεί

**Β. Χαμηλή βεβαιότητα (confidence < 90%)**
Νέος προμηθευτής, ασαφής εταιρεία, δεν αναγνωρίζεται το έργο:
- **Πρώτα έγκριση** από υπεύθυνο
- Propose → "Έλαβα τιμολόγιο [ποσό] από [X]. Νομίζω ανήκει στο [έργο Y] αλλά δεν είμαι σίγουρος (βεβαιότητα: [X]%). Επιβεβαιώνεις;"
- Μετά την έγκριση → καταχώριση στο file system + προώθηση στο λογιστήριο

### 8. Execute - Λογιστήριο

- Προώθηση τιμολογίου στο λογιστήριο (email)
- Ενημέρωση "Νέο τιμολόγιο για [εταιρεία]/[έργο]"

## Μαθησιακή περίοδος

Στην αρχή (πρώτοι 2-3 μήνες) **ΟΛΑ** τα τιμολόγια περνάνε από έγκριση, ανεξαρτήτως confidence. Σταδιακά, καθώς το AI αποδεικνύει αξιοπιστία, αυξάνεται η αυτοματοποίηση.

## Audit trail

Κάθε ενέργεια (αυτόματη ή μη) καταγράφεται πλήρως για λογιστικό/φορολογικό έλεγχο.

## Routing

| Ρόλος | Fallback |
|-------|----------|
| `procurementManager` | `accountant` → `defaultResponsible` |

## AI Model Tier

- **FAST**: Text PDF εξαγωγή, intent detection
- **VISION**: Σκαναρισμένα τιμολόγια
- **QUALITY**: 3-Way Matching, σύνθετη ανάλυση
