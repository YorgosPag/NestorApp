# UC-025: Κοστολόγηση & Παρακολούθηση Προϋπολογισμού Έργου (Project Costing & Budget Tracking)

> **Parent ADR**: [ADR-169 - Modular AI Architecture](../../reference/adrs/ADR-169-modular-ai-architecture.md)
> **Pipeline**: [pipeline.md](../pipeline.md)
> **Σχετικά UCs**: [UC-002](./UC-002-invoice.md) (τιμολόγια), [UC-014](./UC-014-property-sale-process.md) (πωλήσεις), [UC-016](./UC-016-procurement-process.md) (προμήθειες), [UC-024](./UC-024-labor-compliance.md) (εργατικά)

---

## Trigger

Κάθε οικονομική κίνηση (τιμολόγιο, πληρωμή, μισθοδοσία, αγορά υλικών) καταγράφεται στο σύστημα. Η AI συγκεντρώνει αυτόματα όλα τα κόστη ανά project και συγκρίνει με τον αρχικό προϋπολογισμό.

---

## Επισκόπηση

```
ΠΡΟΫΠΟΛΟΓΙΣΜΟΣ → ΠΡΑΓΜΑΤΙΚΑ ΚΟΣΤΗ → ΣΥΓΚΡΙΣΗ → ΑΠΟΚΛΙΣΕΙΣ → PREDICTIONS → ALERTS
```

---

## 1. Δομή Προϋπολογισμού (Budget Structure)

### Κατηγορίες κόστους ανά Project

| Κατηγορία | Κωδικός | Παραδείγματα | Πηγή δεδομένων |
|-----------|---------|-------------|----------------|
| **Γη / Οικόπεδο** | `LAND` | Αγορά, μεσιτικά, συμβολαιογράφος | Manual entry |
| **Μελέτες** | `STUDIES` | Αρχιτεκτονική, στατική, Η/Μ, ενεργειακή, τοπογραφική | UC-015 (αδειοδότηση) |
| **Αδειοδότηση** | `PERMITS` | Τέλη, παράβολα, ΔΕΗ, ΕΥΔΑΠ | UC-015 |
| **Εργασία (ίδιοι)** | `LABOR_OWN` | Μισθοδοσία, ένσημα, εισφορές δικών μας εργατών | UC-024 (ΑΠΔ, παρουσιολόγιο) |
| **Υπεργολάβοι** | `SUBCONTRACT` | Ηλεκτρολόγοι, υδραυλικοί, αλουμινάδες, κ.λπ. | UC-016 (προμήθειες) |
| **Υλικά** | `MATERIALS` | Τσιμέντο, σίδερο, τούβλα, πλακάκια, κ.λπ. | UC-002 (τιμολόγια), UC-016 |
| **Εξοπλισμός** | `EQUIPMENT` | Ενοικίαση γερανών, σκαλωσιές, μηχανήματα | UC-002, UC-016 |
| **Χρηματοοικονομικά** | `FINANCIAL` | Τόκοι δανείου, ασφάλειες, εγγυητικές | Manual entry |
| **Γενικά έξοδα** | `OVERHEAD` | Ρεύμα εργοταξίου, νερό, φύλαξη, καθαριότητα | UC-002 |
| **Διάφορα / Απρόβλεπτα** | `CONTINGENCY` | Buffer 5-10% του συνολικού budget | Αυτόματο |

### Επίπεδα ανάλυσης (Drill-down)

```
PROJECT (σύνολο)
  └── ΚΑΤΗΓΟΡΙΑ (π.χ. MATERIALS)
        └── ΥΠΟΚΑΤΗΓΟΡΙΑ (π.χ. δομικά υλικά)
              └── ΓΡΑΜΜΗ (π.χ. Τσιμέντο Portland — 500 σάκοι × 8€ = 4.000€)
```

---

## 2. Αυτόματη Συλλογή Πραγματικών Κοστών

Η AI δεν βασίζεται σε χειροκίνητη καταχώρηση. **Αντλεί αυτόματα** από τα υπόλοιπα UCs:

| Πηγή | Τι αντλεί | Πώς συνδέεται |
|------|-----------|---------------|
| **UC-002** (Τιμολόγια) | Κάθε τιμολόγιο που αντιστοιχεί σε project → ποσό + κατηγορία | Μέσω `projectId` στο invoice record |
| **UC-016** (Προμήθειες) | Κάθε PO/συμφωνία → αναμενόμενο κόστος | Μέσω procurement → project σύνδεση |
| **UC-024** (Εργατικά) | Παρουσιολόγιο × κλάση ενσήμων → κόστος εργασίας | Μέσω attendance records ανά project |
| **UC-014** (Πωλήσεις) | Αν υπάρχουν αλλαγές σε specifications → extra κόστος | Μέσω change orders |

**AI Categorization**: Αν ένα τιμολόγιο δεν έχει κατηγορία → η AI προτείνει βάσει περιγραφής/προμηθευτή (FAST tier).

---

## 3. Σύγκριση Budget vs Actual

### Real-time dashboard

| Μέτρηση | Τύπος | Παράδειγμα |
|---------|-------|-----------|
| **Budget** | Αρχικός προϋπολογισμός | 1.200.000€ |
| **Committed** | Συμφωνίες/PO που εκκρεμούν | 350.000€ |
| **Spent** | Πραγματικά πληρωμένα | 520.000€ |
| **Remaining** | Budget - Committed - Spent | 330.000€ |
| **% Progress** | Spent / Budget | 43,3% |
| **Variance** | Actual vs Budget ανά κατηγορία | +12% υλικά, -5% εργασία |

### Ανάλυση ανά κατηγορία

| Κατηγορία | Budget | Committed | Spent | Remaining | Variance |
|-----------|--------|-----------|-------|-----------|----------|
| MATERIALS | 300.000€ | 80.000€ | 180.000€ | 40.000€ | ⚠️ +12% |
| LABOR_OWN | 200.000€ | — | 95.000€ | 105.000€ | ✅ -5% |
| SUBCONTRACT | 350.000€ | 120.000€ | 150.000€ | 80.000€ | ✅ On track |
| ... | ... | ... | ... | ... | ... |

---

## 4. AI Predictions & Alerts

### 4.1: Predictive Budget Analysis

Η AI αναλύει τα ιστορικά δεδομένα και τα trends:

| Prediction | Πώς | Παράδειγμα |
|-----------|-----|-----------|
| **Budget overrun** | Τρέχων ρυθμός δαπανών × υπολειπόμενος χρόνος | "Με αυτόν τον ρυθμό, ο προϋπολογισμός ΥΛΙΚΩΝ θα ξεπεραστεί κατά 15% σε 2 μήνες" |
| **Category spike** | Ξαφνική αύξηση σε κατηγορία | "Τα MATERIALS αυξήθηκαν 30% τον τελευταίο μήνα σε σχέση με τον μέσο όρο" |
| **Supplier cost drift** | Σύγκριση τιμών προμηθευτή με ιστορικό | "Ο [Προμηθευτής] τιμολόγησε 20% πάνω από τη συμφωνημένη τιμή" |
| **Completion forecast** | Budget remaining ÷ ρυθμός δαπανών | "Εκτιμώμενο συνολικό κόστος: 1.350.000€ (αρχικός: 1.200.000€)" |

### 4.2: Alerts

| Alert | Trigger | Level | Αρμόδιος |
|-------|---------|-------|----------|
| Κατηγορία ξεπέρασε budget | Spent > Budget ανά κατηγορία | 🔴 Critical | `owner` + `accountant` |
| Κατηγορία πλησιάζει budget | Spent + Committed > 80% Budget | 🟠 High | `accountant` |
| Συνολικό budget πλησιάζει | Total (Spent + Committed) > 85% Total Budget | 🟠 High | `owner` |
| Απρόβλεπτα εξαντλήθηκαν | CONTINGENCY remaining < 20% | 🟠 High | `owner` |
| Τιμή προμηθευτή αυξήθηκε | Τιμή > συμφωνημένη + 10% | 🟡 Medium | `procurementManager` |
| Μηνιαία δαπάνη spike | Μηνιαία δαπάνη > 150% μέσου όρου | 🟡 Medium | `accountant` |

---

## 5. Αναφορές (Reports)

| Αναφορά | Συχνότητα | Παραλήπτης | Περιεχόμενο |
|---------|-----------|------------|------------|
| **Μηνιαία κοστολόγηση** | Μηνιαία | `owner`, `accountant` | Budget vs Actual, variances, trends, predictions |
| **Κατηγορία drill-down** | On-demand | `accountant` | Αναλυτικά τιμολόγια/πληρωμές ανά κατηγορία |
| **Σύγκριση projects** | Τριμηνιαία | `owner` | Κόστος/τ.μ., κόστος/μονάδα σε σχέση με άλλα projects |
| **Ολοκλήρωση project** | Στη λήξη | `owner`, `accountant` | Τελικό κόστος vs budget, lessons learned |

---

## Routing

| Λειτουργία | Κύριος αρμόδιος | Εμπλεκόμενοι |
|-----------|-----------------|-------------|
| Αρχικός προϋπολογισμός | `owner` | `architect`, `civilEngineer` |
| Παρακολούθηση κόστους | `accountant` | `owner` |
| Alerts budget overrun | AI → `owner` | `accountant` |
| Μηνιαία αναφορά | AI → `accountant` | `owner` |
| Αλλαγές budget | `owner` | `accountant` |

---

## AI Model Tier

- **FAST**: Αυτόματη κατηγοριοποίηση τιμολογίων, υπολογισμοί, alerts
- **QUALITY**: Predictive analysis, μηνιαίες αναφορές, σύγκριση projects, trend analysis

---

## Data Model — Σύνδεση με Contacts System

Η κοστολόγηση αξιοποιεί τα **contacts** για αντιστοίχιση κόστους σε οντότητες:

### Πηγές κόστους ↔ Contacts

| Κατηγορία κόστους | Contact Type | Relationship | Πώς αντλείται |
|-------------------|-------------|--------------|---------------|
| **LABOR_OWN** (ίδιοι εργάτες) | `individual` contacts | `employee` relationship με δική μας `company` | UC-024 παρουσιολόγιο × `financialInfo.billingRate` |
| **SUBCONTRACT** (υπεργολάβοι) | `company` contacts | `vendor`/`contractor` relationship | UC-016 PO/τιμολόγια ανά `company` contact |
| **MATERIALS** (υλικά) | `company` contacts (προμηθευτές) | `vendor` relationship | UC-002 τιμολόγια ανά `company` contact |
| **STUDIES** (μελέτες) | `individual`/`company` contacts (μελετητές) | `consultant` relationship | Τιμολόγια μελετών |

### Drill-down ανά συνεργείο

Το σύστημα μπορεί να κάνει drill-down μέχρι τον εργάτη:

```
PROJECT κόστος
  └── SUBCONTRACT: 350.000€
        └── "Παπαδόπουλος ΙΚΕ" (company contact): 120.000€
        │     └── 3 εργάτες × ώρες × κλάση (μέσω contact_relationships)
        └── "Ηλεκτρο-Κατασκευές ΟΕ" (company contact): 95.000€
        │     └── 2 εργάτες × ώρες × κλάση
        └── ...
```

### Κρίσιμα πεδία Contacts

| Πεδίο κοστολόγησης | Πηγή στο Contacts System |
|--------------------|-------------------------|
| Κόστος εργασίας ανά εργάτη | `relationship.financialInfo.billingRate` × ώρες (UC-024) |
| Αξία συμβολαίου υπεργολάβου | `relationship.financialInfo.contractValue` |
| Κόστος ανά κατηγορία | Aggregation τιμολογίων ανά `company` contact type |
| Σύγκριση τιμών προμηθευτών | Ιστορικό τιμολογίων ανά `company` contact |

---

## Κανόνες

- **Αυτόματη σύνδεση**: Κάθε τιμολόγιο/πληρωμή ΠΡΕΠΕΙ να συνδέεται με project + κατηγορία + contact
- **Budget = baseline**: Ο αρχικός προϋπολογισμός δεν αλλάζει — οι αλλαγές γίνονται ως "budget revisions" (audit trail)
- **Committed = δεσμευμένα**: PO/συμφωνίες που δεν πληρώθηκαν ακόμα ΜΕΤΡΑΝΕ στο remaining
- **CONTINGENCY υποχρεωτικό**: Κάθε project πρέπει να έχει buffer 5-10%
- **AI δεν αλλάζει budget**: Η AI ενημερώνει και προτείνει — ο `owner` αποφασίζει
- **Ιστορικό = ανεξίτηλο**: Κάθε αλλαγή budget καταγράφεται με ημερομηνία + αιτιολογία
- **Κόστος ↔ Contact**: Κάθε γραμμή κόστους πρέπει να συνδέεται με `contact` (ποιος πληρώθηκε)
