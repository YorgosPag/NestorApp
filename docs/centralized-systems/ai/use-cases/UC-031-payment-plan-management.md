# UC-031: Πρόγραμμα Πληρωμών Αγοραστή (Payment Plan Management)

> **Parent ADR**: [ADR-169 - Modular AI Architecture](../../reference/adrs/ADR-169-modular-ai-architecture.md)
> **Pipeline**: [pipeline.md](../pipeline.md)
> **Σχετικά UCs**: [UC-014](./UC-014-property-sale-process.md) (πώληση), [UC-026](./UC-026-cash-flow.md) (ταμειακές ροές), [UC-025](./UC-025-project-costing.md) (κοστολόγηση), [UC-013](./UC-013-external-entity.md) (τράπεζες)

---

## Trigger

Μετά την υπογραφή προσυμφώνου ή συμβολαίου αγοραπωλησίας (UC-014, Στάδιο 3-7), δημιουργείται πρόγραμμα πληρωμών για τον αγοραστή. Η AI παρακολουθεί κάθε δόση, μέθοδο πληρωμής και καθυστέρηση.

---

## Επισκόπηση

```
ΣΥΜΒΟΛΑΙΟ → PAYMENT PLAN → MILESTONES → ΔΟΣΕΙΣ → ΕΙΣΠΡΑΞΕΙΣ → ΕΞΟΦΛΗΣΗ
                ↓                           ↓
         ΜΕΘΟΔΟΙ ΠΛΗΡΩΜΗΣ          AI TRACKING & ALERTS
         (μετρητά, δάνειο,
          επιταγές, μεταφορά)
```

**Σχέση με UC-014**: Το UC-014 καλύπτει τη **διαδικασία πώλησης** (9 στάδια). Το UC-031 εμβαθύνει στο **Στάδιο 8** (Πληρωμές) και το μετατρέπει σε πλήρες σύστημα διαχείρισης πληρωμών.

---

## 1. Μέθοδοι Πληρωμής

### 1.1: Υποστηριζόμενες Μέθοδοι (Ελληνικό Δίκαιο)

| Μέθοδος | Κωδικός | Νομικό Πλαίσιο | Όριο | Συχνότητα Χρήσης |
|---------|---------|----------------|------|------------------|
| **Τραπεζική μεταφορά** | `bank_transfer` | Υποχρεωτική >500€ (Ν.4446/2016) | Χωρίς | **Κύρια** (~70-80%) |
| **Στεγαστικό δάνειο** | `mortgage` | Τραπεζική σύμβαση | Συνήθως 70-80% αξίας | **Πολύ συχνή** |
| **Μεταχρονολογημένη επιταγή** | `post_dated_check` | Ν.5960/1933 | Χωρίς | Μέτρια |
| **Συναλλαγματική** | `promissory_note` | Ν.5325/1932 | Χωρίς | Σπάνια |
| **Μετρητά** | `cash` | Ν.4446/2016 | Max **500€** ανά συναλλαγή | Μόνο μικρά ποσά |
| **Escrow account** | `escrow` | Τραπεζική σύμβαση | Χωρίς | Μεγάλες συναλλαγές |

### 1.2: Κανόνες Μεθόδων Πληρωμής

| Κανόνας | Περιγραφή | AI Enforcement |
|---------|-----------|----------------|
| **AML Compliance** | Μετρητά >500€ = ΑΠΑΓΟΡΕΥΕΤΑΙ (Ν.4446/2016) | 🔴 BLOCK — δεν καταχωρεί |
| **Τραπεζική υποχρέωση** | Πληρωμές >500€ ΠΡΕΠΕΙ μέσω τράπεζας | ✅ AI ελέγχει |
| **Στοιχεία μεταφοράς** | Κάθε τραπεζική μεταφορά πρέπει αιτιολογία + αποδεικτικό | ✅ AI ζητάει |
| **Επιταγή tracking** | Αριθμός επιταγής, τράπεζα, ημ/νία, ποσό | ✅ AI καταγράφει |
| **Δάνειο εκταμίευση** | Εκταμίευση δανείου → ενημέρωση plan αυτόματα | ✅ AI ενημερώνει |
| **Συναλλαγματική** | Αριθμός, ημ/νία λήξης, ποσό, αποδέκτης | ✅ AI καταγράφει |

---

## 2. Construction-Linked Payments (CLP)

### 2.1: Milestones Κατασκευής

Οι δόσεις συνδέονται με **φάσεις κατασκευής** — industry standard (Yardi, SAP RE-FX, Procore):

| # | Milestone | Τυπικό % | Config | Σύνδεση |
|---|-----------|----------|--------|---------|
| M1 | **Κράτηση / Προσύμφωνο** | 2-5% | ✅ | UC-014 Στάδιο 3 |
| M2 | **Υπογραφή Συμβολαίου** | 10-15% | ✅ | UC-014 Στάδιο 7 |
| M3 | **Θεμελίωση** | 10-15% | ✅ | UC-017 (φάσεις κατασκευής) |
| M4 | **Σκελετός (φέρων οργανισμός)** | 20-25% | ✅ | UC-017 |
| M5 | **Εξωτερικά (κουφώματα, μόνωση, σοβάδες)** | 15-20% | ✅ | UC-017 |
| M6 | **Εσωτερικά (ηλεκτρικά, υδραυλικά, δάπεδα)** | 15-20% | ✅ | UC-017 |
| M7 | **Παράδοση κλειδιών** | 10-15% | ✅ | UC-023 |
| M8 | **Μεταγραφή / Υπόλοιπο** | Balance | ✅ | UC-014 Στάδιο 7 |

### 2.2: Configurable Payment Plans

| Τύπος Plan | Περιγραφή | Χρήση |
|------------|-----------|-------|
| **CLP (Construction-Linked)** | Δόσεις συνδεδεμένες με milestones κατασκευής | **Default** — υπό κατασκευή |
| **Fixed Schedule** | Σταθερές μηνιαίες/τριμηνιαίες δόσεις | Έτοιμα ακίνητα |
| **Custom** | Ελεύθερη διαμόρφωση δόσεων | Ειδικές συμφωνίες |
| **Balloon** | Μικρές δόσεις + μεγάλο τελικό ποσό | Αναμονή δανείου |

**ΚΑΝΟΝΑΣ**: Ο τύπος plan ορίζεται στο **project level** (default) αλλά μπορεί να τροποποιηθεί ανά αγοραστή με `owner` approval.

---

## 3. Κύκλος Ζωής Δόσης

### 3.1: Καταστάσεις

```
SCHEDULED → DUE → PAID / OVERDUE → OVERDUE_30D → OVERDUE_90D → LEGAL
                          ↓
                  PARTIALLY_PAID (μερική πληρωμή)
```

| Κατάσταση | Χρώμα | Περιγραφή | AI Action |
|-----------|-------|-----------|-----------|
| `scheduled` | ⚪ Γκρι | Μελλοντική δόση | Μετράει στο forecast (UC-026) |
| `due` | 🔵 Μπλε | Ληξιπρόθεσμη εντός 7 ημερών | Alert αγοραστή + accountant |
| `paid` | 🟢 Πράσινο | Εξοφλήθηκε πλήρως | Ενημέρωση forecast + UC-026 |
| `partially_paid` | 🟡 Κίτρινο | Μερική πληρωμή | Alert — υπόλοιπο = X€ |
| `overdue` | 🟠 Πορτοκαλί | 1-30 μέρες καθυστέρηση | Alert accountant + salesManager |
| `overdue_30d` | 🔴 Κόκκινο | >30 μέρες καθυστέρηση | Alert owner + αφαιρείται από forecast |
| `overdue_90d` | 🔴🔴 Κόκκινο | >90 μέρες καθυστέρηση | Escalation → νομικό τμήμα |
| `cancelled` | ⚫ Μαύρο | Ακυρώθηκε (αλλαγή plan) | Ιστορικό μόνο |

### 3.2: Multi-Method Payment (μία δόση, πολλές μέθοδοι)

Μία δόση μπορεί να πληρωθεί με **συνδυασμό μεθόδων**:

```
Δόση M4: 50.000€ (Σκελετός)
├── bank_transfer:  30.000€  (εισπράχθηκε 15/03)
├── post_dated_check: 15.000€  (επιταγή #4521, 01/04)
└── mortgage:       5.000€  (εκταμίευση τράπεζας, 10/04)
                    ─────────
                    50.000€  ✅ ΠΛΗΡΕΣ
```

**AI**: Ελέγχει ότι `Σύνολο μεθόδων = Ποσό δόσης` πριν σημάνει `paid`.

---

## 4. Στεγαστικό Δάνειο (Mortgage Tracking)

### 4.1: Lifecycle Δανείου

```
ΑΙΤΗΣΗ → ΕΚΤΙΜΗΣΗ → ΕΓΚΡΙΣΗ → ΕΚΤΑΜΙΕΥΣΕΙΣ → ΟΛΟΚΛΗΡΩΣΗ
                                    ↓
                            (μία ή πολλές δόσεις εκταμίευσης)
```

| Φάση | Status | AI Action |
|------|--------|-----------|
| Αίτηση κατατέθηκε | `loan_applied` | Tracking SLA (~15-30 μέρες) |
| Εκτίμηση ακινήτου | `loan_appraised` | Alert αν >20 μέρες |
| Έγκριση δανείου | `loan_approved` | Ενημέρωση plan — ποσό, τράπεζα, επιτόκιο |
| Απόρριψη | `loan_rejected` | 🔴 Alert owner + salesManager — εναλλακτικές |
| Εκταμίευση #1 | `loan_disbursement` | Αυτόματη καταχώρηση στη δόση |
| Εκταμίευση #2+ | `loan_disbursement` | Αυτόματη καταχώρηση — πολλαπλές εκταμιεύσεις OK |

### 4.2: Σύνδεση Δάνειο ↔ Δόσεις

| Πεδίο | Περιγραφή |
|-------|-----------|
| `loanBank` | Τράπεζα (Εθνική, Πειραιώς, Eurobank, Alpha, κ.λπ.) |
| `loanApprovalAmount` | Εγκεκριμένο ποσό δανείου |
| `loanDisbursements[]` | Array εκταμιεύσεων (ποσό, ημ/νία, σύνδεση με milestone) |
| `loanInterestRate` | Επιτόκιο (πληροφοριακά) |
| `loanContactPerson` | Υπεύθυνος τράπεζας (service contact) |

**ΚΑΝΟΝΑΣ**: Κάθε εκταμίευση δανείου αυτόματα:
1. Καταγράφεται ως payment method `mortgage` στη σχετική δόση
2. Ενημερώνει το forecast (UC-026)
3. Ενημερώνει τον accountant

---

## 5. Επιταγές & Συναλλαγματικές

### 5.1: Tracking Επιταγών

| Πεδίο | Τύπος | Περιγραφή |
|-------|-------|-----------|
| `checkNumber` | string | Αριθμός επιταγής |
| `checkBank` | string | Τράπεζα εκδότη |
| `checkDate` | date | Ημερομηνία εξαργύρωσης |
| `checkAmount` | number | Ποσό |
| `checkStatus` | enum | `pending` → `deposited` → `cleared` / `bounced` |

### 5.2: Ακάλυπτη Επιταγή (Bounced Check)

```
Επιταγή #4521 → Κατάθεση 01/04 → BOUNCED ❌
     ↓
AI: 🔴 CRITICAL Alert:
     "Ακάλυπτη επιταγή #4521 αγοραστή [Χ] — ποσό 15.000€
      Αντικατάσταση ή νομική ενέργεια;"
     ↓
→ Ειδοποίηση: owner + accountant + salesManager
→ Δόση: επιστρέφει σε `overdue`
→ Νομική σημείωση: Ν.5960/1933, Ν.1325/1972 (ποινική ευθύνη)
```

### 5.3: Tracking Συναλλαγματικών

| Πεδίο | Τύπος | Περιγραφή |
|-------|-------|-----------|
| `noteNumber` | string | Αριθμός συναλλαγματικής |
| `noteIssueDate` | date | Ημερομηνία έκδοσης |
| `noteMaturityDate` | date | Ημερομηνία λήξης |
| `noteAmount` | number | Ποσό |
| `noteStatus` | enum | `active` → `matured` → `paid` / `protested` |

---

## 6. Φορολογικά & Νομικά

### 6.1: ΦΠΑ Νεόδμητων

| Κανόνας | Περιγραφή |
|---------|-----------|
| **Κανονικός ΦΠΑ** | 24% σε νεόδμητα (Ν.2859/2000, Άρθρο 6) |
| **Αναστολή ΦΠΑ** | Σε ισχύ μέχρι **31/12/2026** (Ν.5246/2025) — αντί ΦΠΑ καταβάλλεται **ΦΜΑ 3,09%** |
| **AI handling** | Config-driven: `vatSuspended: true/false` + `vatRate` + `transferTaxRate` |
| **Αλλαγή καθεστώτος** | Αν λήξει η αναστολή → AI ενημερώνει αυτόματα τα plans |

### 6.2: Συμβολαιογραφικά Έξοδα

| Έξοδο | Ποσοστό | Αρμόδιος |
|-------|---------|----------|
| Συμβολαιογραφικά | ~0,80-1,00% | Αγοραστής |
| Μεταγραφή/Κτηματολόγιο | ~0,475-0,575% | Αγοραστής |
| ΦΜΑ (αν εφαρμόζεται) | 3,09% | Αγοραστής |
| Μεσιτική αμοιβή (αν υπάρχει) | ~2% | Πωλητής ή αγοραστής |

**AI**: Κατά τη δημιουργία plan, υπολογίζει αυτόματα τα συνολικά κόστη και ενημερώνει τον αγοραστή.

---

## 7. AI Alerts & Automations

### 7.1: Alert Timeline

| Χρόνος | Level | Alert | Παραλήπτες |
|--------|-------|-------|------------|
| **7 μέρες πριν τη δόση** | 🔵 Info | "Υπενθύμιση: Δόση [X]€ στις [ημ/νία]" | Αγοραστής (αν consent) |
| **Ημέρα δόσης** | 🟡 Low | "Σήμερα λήγει η δόση [X]€" | `accountant` |
| **+7 μέρες** | 🟠 Medium | "Καθυστέρηση 7 ημερών — δόση [X]€" | `accountant` + `salesManager` |
| **+30 μέρες** | 🔴 High | "Καθυστέρηση 30 ημερών — αφαίρεση από forecast" | `owner` + `accountant` |
| **+90 μέρες** | 🔴 Critical | "Σοβαρή καθυστέρηση — νομική ενέργεια;" | `owner` |
| **Ακάλυπτη επιταγή** | 🔴 Critical | "Bounced check #[X] — ποσό [Y]€" | `owner` + `accountant` |
| **Εκταμίευση δανείου** | 🟢 Info | "Εκταμίευση [X]€ από [τράπεζα] — δόση [M] ενημερώθηκε" | `accountant` |
| **Εξόφληση 100%** | 🟢 Success | "Ο αγοραστής [Χ] ολοκλήρωσε τις πληρωμές — έτοιμος για παράδοση" | `salesManager` + `owner` |

### 7.2: Αυτοματισμοί

| Automation | Trigger | Action |
|-----------|---------|--------|
| **Milestone → Due** | Κατασκευή φτάνει milestone (UC-017) | Δόση γίνεται `due`, ειδοποίηση αγοραστή |
| **Payment → Forecast** | Πληρωμή καταχωρείται | Αυτόματη ενημέρωση UC-026 forecast |
| **Loan Disbursement** | Τράπεζα εκταμιεύει | Αυτόματη καταχώρηση payment + ενημέρωση plan |
| **Check Deposit** | Ημ/νία επιταγής φτάνει | Reminder accountant: "Κατάθεσε επιταγή #[X]" |
| **Full Payment** | Σύνολο πληρωμών = τιμή ακινήτου | Status → `payments_complete`, trigger UC-023 handover |
| **VAT Change** | Config αλλαγή `vatSuspended` | Αυτόματη ενημέρωση σε όλα τα ανοιχτά plans |

---

## 8. Dashboard

### 8.1: Payment Plan Overview (ανά αγοραστή)

| Widget | Περιεχόμενο |
|--------|-------------|
| **Timeline** | Gantt-style timeline δόσεων — paid (🟢), due (🔵), overdue (🔴), scheduled (⚪) |
| **Σύνοψη** | Τιμή ακινήτου, πληρωμένο %, υπόλοιπο, επόμενη δόση |
| **Μέθοδοι** | Breakdown ανά μέθοδο πληρωμής (bank transfer: X€, mortgage: Y€, checks: Z€) |
| **Ιστορικό** | Χρονολογική λίστα πληρωμών με αποδεικτικά |

### 8.2: Portfolio View (ανά project)

| Widget | Περιεχόμενο |
|--------|-------------|
| **Αγοραστές** | Πίνακας όλων των αγοραστών με % εξόφλησης |
| **Εισπράξεις μήνα** | Πόσα εισπράχθηκαν τον τρέχοντα μήνα |
| **Overdue** | Αγοραστές με καθυστερήσεις (🔴) |
| **Forecast** | Αναμενόμενες εισπράξεις επόμενων 3 μηνών |
| **Επιταγές** | Επιταγές προς κατάθεση (ημ/νίες, ποσά) |

### 8.3: Executive Summary (ανά εταιρεία)

| Widget | Περιεχόμενο |
|--------|-------------|
| **Συνολικές πωλήσεις** | Τιμολόγηση vs εισπράξεις vs υπόλοιπο |
| **Collection ratio** | % εισπράξεων vs προγραμματισμένων |
| **Aging report** | Ανάλυση υπολοίπων ανά ηλικία (0-30, 30-60, 60-90, 90+ μέρες) |
| **Top overdue** | Οι μεγαλύτερες καθυστερήσεις |

---

## 9. Σύνδεση με Υπάρχοντα UCs

| UC | Σχέση |
|----|-------|
| **UC-014** | Πώληση Ακινήτου → Στάδιο 8 δίνει trigger στο UC-031 |
| **UC-017** | Φάσεις Κατασκευής → milestones ενεργοποιούν δόσεις |
| **UC-023** | Παράδοση → trigger στο 100% εξόφληση |
| **UC-025** | Κοστολόγηση → εισπράξεις vs budget |
| **UC-026** | Cash Flow → forecast τροφοδοτείται από payment plan data |
| **UC-013** | Τράπεζες → loan tracking, εκταμιεύσεις |
| **UC-030** | Petty Cash → ΔΕΝ αφορά τον αγοραστή (μόνο εσωτερικά) |

---

## Routing

| Λειτουργία | Κύριος αρμόδιος | Εμπλεκόμενοι |
|-----------|-----------------|-------------|
| Δημιουργία payment plan | `salesManager` | `accountant`, `owner` |
| Καταχώρηση πληρωμής | `accountant` | `salesManager` |
| Tracking δανείου | `secretary` | `accountant`, `salesManager` |
| Tracking επιταγών | `accountant` | — |
| Alerts καθυστερήσεων | AI → `accountant` | `salesManager`, `owner` (escalation) |
| Αλλαγή plan | `owner` (approval) | `salesManager`, `accountant` |
| Νομική ενέργεια (90+ μέρες) | `owner` | Νομικός σύμβουλος |

---

## AI Model Tier

- **FAST**: Status tracking, alerts, δόσεις, reminders, forecast calculations
- **QUALITY**: Σύνθεση αναφοράς πληρωμών, aging analysis, risk assessment

---

## Data Model — Σύνδεση με Contacts System

### Αγοραστής = Client Contact

| Entity UC-031 | Contacts System | Τοποθεσία |
|---------------|-----------------|-----------|
| Αγοραστής | `individual` contact (type) | `contacts/{id}` |
| Εταιρεία αγοραστή (αν νομικό πρόσωπο) | `company` contact | `contacts/{id}` |
| Σχέση αγοραστή↔εταιρεία μας | `ContactRelationship` (type: `client`) | `contact_relationships/{id}` |
| Σύνδεση αγοραστή↔unit | `ContactLink` (entity: `unit`) | `contact_links/{id}` |

### Τράπεζα = Service Contact

| Entity UC-031 | Contacts System | Τοποθεσία |
|---------------|-----------------|-----------|
| Τράπεζα | `company` contact | `contacts/{id}` |
| Υπεύθυνος τράπεζας | `individual` contact | `contacts/{id}` |
| Σχέση τράπεζα↔εμάς | `ContactRelationship` (type: `vendor` ή `service`) | `contact_relationships/{id}` |

### Ροή δημιουργίας Payment Plan

```
ΥΠΟΓΡΑΦΗ ΣΥΜΒΟΛΑΙΟΥ (UC-014 Στάδιο 7)
     ↓
buyerId = contact.id (individual/company contact — client relationship)
     ↓
unitId = unit (από contact_links)
     ↓
AI → Δημιουργία payment_plan:
     - buyer: contactId
     - unit: unitId
     - plan_type: CLP / Fixed / Custom / Balloon
     - milestones: array δόσεων
     - payment_methods: configured ανά αγοραστή
     ↓
AI → Ενημέρωση UC-026: νέες αναμενόμενες εισροές
```

### Ροή καταχώρησης πληρωμής

```
ΠΛΗΡΩΜΗ εισπράχθηκε
     ↓
AI → Ταυτοποίηση αγοραστή (μέσω bank reference ή χειροκίνητα)
     ↓
AI → Αντιστοίχιση με milestone/δόση
     ↓
AI → Ενημέρωση: payment_plan, UC-026 forecast, contact financial history
     ↓
ΜΕΡΙΚΗ? → remaining = ποσό δόσης - πληρωμές → status: `partially_paid`
ΠΛΗΡΕΣ? → status: `paid` → check αν 100% → trigger UC-023
```

---

## Κανόνες

- **Multi-method = OK**: Μία δόση μπορεί να πληρωθεί με πολλαπλές μεθόδους
- **Cash ≤500€**: AI BLOCK αν καταχωρηθεί μετρητά >500€ (νόμος)
- **Δάνειο = ξεχωριστό tracking**: Η εκταμίευση δανείου είναι payment method, όχι ξεχωριστή πληρωμή
- **Milestone = trigger**: Δόση γίνεται `due` μόνο όταν η κατασκευή φτάσει στο αντίστοιχο milestone
- **Plan αλλαγή = owner approval**: Καμία αλλαγή στο πρόγραμμα πληρωμών χωρίς `owner` έγκριση
- **Ακάλυπτη επιταγή = CRITICAL**: Αμέσως escalation + νομική σημείωση
- **90+ overdue = νομική ενέργεια**: AI προτείνει εξώδικο ή νομικά μέτρα
- **VAT config-driven**: Αναστολή ΦΠΑ, ΦΜΑ, συντελεστές — configurable, αλλάζουν χωρίς code
- **Contacts = SSoT**: Ο αγοραστής είναι ΠΑΝΤΑ contact στο Contacts System — ΔΕΝ δημιουργούμε duplicate
- **Forecast = αυτόματο**: Κάθε πληρωμή/καθυστέρηση ενημερώνει αυτόματα το UC-026
