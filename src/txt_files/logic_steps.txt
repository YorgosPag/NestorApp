# CONTEXT REFACTORING - Î Î»Î®ÏÎ·Ï‚ Î‘Î½Î¬Î»Ï…ÏƒÎ· ÎºÎ±Î¹ Î’Î·Î¼Î±Ï„Î¹ÏƒÎ¼ÏŒÏ‚

## ğŸ“‹ Î¤Î¡Î•Î§ÎŸÎ¥Î£Î‘ ÎšÎ‘Î¤Î‘Î£Î¤Î‘Î£Î— (CURRENT STATE ANALYSIS)

### ğŸ” CONTEXTS INVENTORY

#### Î’Î±ÏƒÎ¹ÎºÎ¬ CONTEXTS (Global Settings)
1. **LineSettingsContext.tsx** - Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î³ÏÎ±Î¼Î¼ÏÎ½ Î³ÎµÎ½Î¹ÎºÎ­Ï‚
   - Interface: LineSettings (enabled, lineType, lineWidth, color, opacity, dashScale, etc.)
   - Hook: useLineSettings()
   - Î§ÏÎ®ÏƒÎ·: Î“Î»Î¿Î²Î±Î» ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î³ÏÎ±Î¼Î¼ÏÎ½ ÏƒÏ„Î· ÎµÏ†Î±ÏÎ¼Î¿Î³Î®

2. **TextSettingsContext.tsx** - Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎºÎµÎ¹Î¼Î­Î½Î¿Ï… Î³ÎµÎ½Î¹ÎºÎ­Ï‚
   - Interface: TextSettings (enabled, fontFamily, fontSize, color, isBold, etc.)
   - Hook: useTextSettings()
   - Î§ÏÎ®ÏƒÎ·: Î“Î»Î¿Î²Î±Î» ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎºÎµÎ¹Î¼Î­Î½Î¿Ï… ÏƒÏ„Î· ÎµÏ†Î±ÏÎ¼Î¿Î³Î®

3. **GripProvider.tsx** - Î¡Ï…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Ï‡ÎµÎ¹ÏÎ¿Î»Î±Î²ÏÎ½ grips
   - Interface: GripSettings (gripSize, colors: {cold, warm, hot, contour}, etc.)
   - Hook: useGripContext()
   - Î§ÏÎ®ÏƒÎ·: Î“Î»Î¿Î²Î±Î» ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Ï‡ÎµÎ¹ÏÎ¿Î»Î±Î²ÏÎ½ Grips

#### Î•Î¹Î´Î¹ÎºÎ¬ CONTEXTS (Entity-Specific Overrides)
4. **SpecificLinePreviewContext.tsx** - Î•Î¹Î´Î¹ÎºÎ­Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·
   - Interface: SpecificLinePreviewSettings (overrideGlobalSettings + LineSettings)
   - Hook: useSpecificLinePreview()
   - Î§ÏÎ®ÏƒÎ·: Î•Î¹Î´Î¹ÎºÎ­Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î³ÏÎ±Î¼Î¼ÏÎ½ Î¼ÏŒÎ½Î¿ Î³Î¹Î± Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·

5. **SpecificLineCompletionContext.tsx** - Î•Î¹Î´Î¹ÎºÎ­Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·
   - Interface: SpecificLineCompletionSettings (overrideGlobalSettings + LineSettings)
   - Hook: useSpecificLineCompletion()
   - Î§ÏÎ®ÏƒÎ·: Î•Î¹Î´Î¹ÎºÎ­Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î³ÏÎ±Î¼Î¼ÏÎ½ Î¼ÏŒÎ½Î¿ Î³Î¹Î± Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·

6. **SpecificTextPreviewContext.tsx** - Î•Î¹Î´Î¹ÎºÎ­Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î³Î¹Î± Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·
   - Interface: SpecificTextPreviewSettings (overrideGlobalSettings + TextSettings)
   - Hook: useSpecificTextPreview()
   - Î§ÏÎ®ÏƒÎ·: Î•Î¹Î´Î¹ÎºÎ­Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎºÎµÎ¹Î¼Î­Î½Î¿Ï… Î³Î¹Î± Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·

#### INTERMEDIATE CONTEXTS (Possibly Redundant)
7. **LinePreviewSettingsContext.tsx** - Intermediate Î³Î¹Î± Ï€ÏÎ¿ÎµÏ€Î¹ÏƒÎºÏŒÏ€Î·ÏƒÎ·
8. **LineCompletionSettingsContext.tsx** - Intermediate Î³Î¹Î± Î¿Î»Î¿ÎºÎ»Î®ÏÏ‰ÏƒÎ·
9. **TextPreviewSettingsContext.tsx** - Intermediate Î³Î¹Î± ÎºÎµÎ¯Î¼ÎµÎ½Î¿

### âš ï¸ Î ÏÎ¿Î²Î»Î®Î¼Î±Ï„Î± Ï„Î·Ï‚ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎ±Ï‚ Î±ÏÏ‡Î¹Ï„ÎµÎºÏ„Î¿Î½Î¹ÎºÎ®Ï‚

#### A. Î”Î¹Ï€Î»Î±ÏƒÎ¹Î±ÏƒÎ¼ÏŒÏ‚ (Code Duplication)
- Î¤Î¿ Î¯Î´Î¹Î¿ interface (LineSettings) Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ ÏƒÎµ Ï€Î¿Î»Î»Î±Ï€Î»Î¬ contexts
- Î¤Î± Î¯Î´Î¹Î± components (LineSettings, TextSettings, GripSettings) ÎµÏ€Î±Î½Î±Î»Î±Î¼Î²Î¬Î½Î¿Ï…Î½ Ï€Î±ÏÏŒÎ¼Î¿Î¹Î± Î»Î¿Î³Î¹ÎºÎ® ÏƒÎµ ÎºÎ¬Î¸Îµ context
- Î Î¿Î»Î»Î±Ï€Î»Î¬ intermediate contexts Ï€Î¿Ï… Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î¼Î·Î½ ÎµÎ¯Î½Î±Î¹ Î±Ï€Î±ÏÎ±Î¯Ï„Î·Ï„Î±

#### B. Î Î¿Î»ÏÏ€Î»Î¿ÎºÎ· Î»Î¿Î³Î¹ÎºÎ® (Complex Logic)
- Î¤Î± LineSettings component Î­Ï‡Î¿Ï…Î½ try-catch blocks Î³Î¹Î± context detection
- Î¤Î± component Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± ÎµÎ»Î­Î³Ï‡Î¿Ï…Î½ Ï€Î¿Î¹Î¿ Î±Ï€ÏŒ Ï„Î± 3+ contexts Î¸Î± Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î®ÏƒÎ¿Ï…Î½
- Î£ÎµÎ¹ÏÎ¬ Ï€ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„Î±Ï‚: completion > preview > general

#### C. Î”ÏÏƒÎºÎ¿Î»Î· ÏƒÏ…Î½Ï„Î®ÏÎ·ÏƒÎ· (Maintenance Issues)
- Î‘Î½ Î¸Î­Î»Î¿Ï…Î¼Îµ Î½Î± Ï€ÏÎ¿ÏƒÎ¸Î­ÏƒÎ¿Ï…Î¼Îµ Î½Î­Î¿ entity (Ï€.Ï‡ Circle), Ï€ÏÎ­Ï€ÎµÎ¹ Î½Î± Î´Î·Î¼Î¹Î¿Ï…ÏÎ³Î®ÏƒÎ¿Ï…Î¼Îµ 3+ Î½Î­Î± contexts
- Changes ÏƒÎµ Î­Î½Î± interface ÎµÏ€Î·ÏÎµÎ¬Î¶Î¿Ï…Î½ Ï€Î¿Î»Î»Î¬ Î±ÏÏ‡ÎµÎ¯Î±
- Hard to debug - Î´ÏÏƒÎºÎ¿Î»Î¿ Î½Î± ÎµÎ½Ï„Î¿Ï€Î¯ÏƒÎ¿Ï…Î¼Îµ Ï€Î¿Î¹Î¿ context Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯Ï„Î±Î¹

## ğŸ¯ Î£Î¤ÎŸÎ§ÎŸÎ£ REFACTORING

### âœ… Î¤Î¹ Î¸Î± Î´Î¹Î±Ï„Î·ÏÎ®ÏƒÎ¿Ï…Î¼Îµ
- 100% Î¯Î´Î¹Î¿ UI/UX - ÎºÎ±Î¼Î¯Î± Î±Î»Î»Î±Î³Î® ÏƒÏ„Î·Î½ ÎµÎ¼Ï†Î¬Î½Î¹ÏƒÎ·
- ÎŠÎ´Î¹Î± Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³Î¹ÎºÏŒÏ„Î·Ï„Î± - ÏŒÎ»ÎµÏ‚ Î¿Î¹ Ï„ÏÎ­Ï‡Î¿Ï…ÏƒÎµÏ‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚
- Backward compatibility Î¼Îµ Ï…Ï€Î¬ÏÏ‡Î¿Î½Ï„Î± hooks (ÏŒÏƒÏ‰Î½ Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ½Ï„Î±Î¹ Î®Î´Î·)

### ğŸš€ Î¤Î¹ Î¸Î± Î²ÎµÎ»Ï„Î¹ÏÏƒÎ¿Ï…Î¼Îµ
- Î•Î½Î¿Ï€Î¿Î¯Î·ÏƒÎ· contexts ÏƒÎµ unified architecture
- Î‘Ï€Î»Î¿Ï€Î¿Î¯Î·ÏƒÎ· component logic
- ÎœÎµÎ¯Ï‰ÏƒÎ· code duplication ÎºÎ±Ï„Î¬ ~50%
- Cleaner inheritance pattern

## ğŸ“ Î•ÎšÎ¤Î•Î›Î•Î£Î¤Î•ÎŸÎ£ REFACTORING

### Î¦Î¬ÏƒÎ· 1: Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± UNIFIED SETTINGS SYSTEM

#### Î’Î®Î¼Î± 1.1: Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± UnifiedSettingsContext
**Î‘ÏÏ‡ÎµÎ¯Î¿:** `contexts/UnifiedSettingsContext.tsx`
**Î£ÎºÎ¿Ï€ÏŒÏ‚:** ÎˆÎ½Î± context Ï€Î¿Ï… Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÏŒÎ»Î± global + entity-specific settings
**Î”Î¿Î¼Î®:**
```typescript
interface UnifiedSettings {
  // Global settings
  global: {
    line: LineSettings;
    text: TextSettings;
    grip: GripSettings;
  };

  // Entity-specific overrides
  entities: {
    [entityType: string]: {
      [phase: string]: {
        line?: Partial<LineSettings> & { override: boolean };
        text?: Partial<TextSettings> & { override: boolean };
        grip?: Partial<GripSettings> & { override: boolean };
      }
    }
  }
}
```

#### Î’Î®Î¼Î± 1.2: Helper Functions
**Î£ÎºÎ¿Ï€ÏŒÏ‚:** Functions Ï€Î¿Ï… Î¸Î± ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†Î¿Ï…Î½ effective settings
```typescript
getEffectiveLineSettings(entityType?: string, phase?: string): LineSettings
getEffectiveTextSettings(entityType?: string, phase?: string): TextSettings
getEffectiveGripSettings(entityType?: string, phase?: string): GripSettings
```

### Î¦Î¬ÏƒÎ· 2: Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± COMPATIBILITY LAYER

#### Î’Î®Î¼Î± 2.1: Legacy Hook Wrappers
**Î£ÎºÎ¿Ï€ÏŒÏ‚:** Î”Î¹Î±Ï„Î®ÏÎ·ÏƒÎ· backward compatibility
**Î‘ÏÏ‡ÎµÎ¯Î±:**
- `contexts/LineSettingsContext.legacy.tsx` - Wrapper Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹ÎµÎ¯ Ï„Î¿ UnifiedContext
- `contexts/TextSettingsContext.legacy.tsx`
- `providers/GripProvider.legacy.tsx`

#### Î’Î®Î¼Î± 2.2: Smart Context Detection
**Î£ÎºÎ¿Ï€ÏŒÏ‚:** Î‘Ï…Ï„ÏŒÎ¼Î±Ï„Î· ÎµÏÏÎµÏƒÎ· Ï„Î¿Ï… ÏƒÏ‰ÏƒÏ„Î¿Ï context Î±Î½Î¬Î»Î¿Î³Î± Î¼Îµ Ï„Î¿ component
- React Context Î³Î¹Î± entity type detection
- Automatic phase detection (preview/completion/hover/selection)

### Î¦Î¬ÏƒÎ· 3: Î‘Ï€Î»Î¿Ï€Î¿Î¯Î·ÏƒÎ· COMPONENTS

#### Î’Î®Î¼Î± 3.1: Simplified LineSettings Component
**Î‘ÏÏ‡ÎµÎ¯Î¿:** `settings/LineSettings.simplified.tsx`
**Î’ÎµÎ»Ï„Î¹ÏÏƒÎµÎ¹Ï‚:**
- Î‘Ï†Î±Î¯ÏÎµÏƒÎ· try-catch logic
- Î§ÏÎ®ÏƒÎ· ÎµÎ½ÏŒÏ‚ hook: `useEffectiveLineSettings()`
- Cleaner code

#### Î’Î®Î¼Î± 3.2: Component Context Provider
**Î£ÎºÎ¿Ï€ÏŒÏ‚:** Component Ï€Î¿Ï… ÎµÎ¾Î·Î³ÎµÎ¯ ÏƒÏ„Î¿ child setting type Ï€Î¿Ï… Ï‡ÏÎµÎ¹Î¬Î¶ÎµÏ„Î±Î¹
```typescript
<SettingsProvider entityType="line" phase="preview">
  <LineSettings />
</SettingsProvider>
```

### Î¦Î¬ÏƒÎ· 4: MIGRATION STRATEGY

#### Î’Î®Î¼Î± 4.1: Parallel Implementation
- Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± ÎºÎ±Î¹Î½Î¿ÏÏÎ¹Î± components Ï€Î±ÏÎ¬Î»Î»Î·Î»Î± Î¼Îµ Ï„Î± Ï€Î±Î»Î¹Î¬
- Gradual replacement - Î­Î½Î±-Î­Î½Î± Ï„Î± places Ï€Î¿Ï… Ï‡ÏÎ·ÏƒÎ¹Î¼Î¿Ï€Î¿Î¹Î¿ÏÎ½Ï„Î±Î¹

#### Î’Î®Î¼Î± 4.2: Testing Phase
- Î•Ï€Î±Î»Î®Î¸ÎµÏ…ÏƒÎ· ÏŒÏ„Î¹ ÎºÎ¬Î¸Îµ replacement Î»ÎµÎ¹Ï„Î¿Ï…ÏÎ³ÎµÎ¯ identically
- UI tests Î³Î¹Î± ÎºÎ¬Î¸Îµ path

#### Î’Î®Î¼Î± 4.3: Cleanup Phase
- Î‘Ï†Î±Î¯ÏÎµÏƒÎ· Ï€Î±Î»Î¹ÏÎ½ contexts Î¼ÎµÏ„Î¬ Ï„Î¿ migration
- Code cleanup

### Î¦Î¬ÏƒÎ· 5: Î•Ï€Î±Î»Î®Î¸ÎµÏ…ÏƒÎ·

#### Î’Î®Î¼Î± 5.1: Functionality Verification
- Î“Î»Î¿Î²Î±Î» ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î³ÏÎ±Î¼Î¼ÏÎ½/ÎºÎµÎ¹Î¼Î­Î½Î¿Ï…/Grips working
- Î•Î¹Î´Î¹ÎºÎ­Ï‚ ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ Î³Î¹Î± ÏŒÎ»Î± Ï„Î± entities/phases working
- Preview updates working
- Settings persistence working

#### Î’Î®Î¼Î± 5.2: Performance Check
- Î›Î¹Î³ÏŒÏ„ÎµÏÎ± re-renders
- Î›Î¹Î³ÏŒÏ„ÎµÏÎ· memory usage
- Faster component mounting

## ğŸ”„ EXECUTION PLAN

### Î ÏÎ¿Ï„ÎµÏÎ±Î¹ÏŒÏ„Î·Ï„ÎµÏ‚
1. **HIGH PRIORITY:** Phases 1-2 (Core architecture)
2. **MEDIUM PRIORITY:** Phase 3 (Component simplification)
3. **LOW PRIORITY:** Phases 4-5 (Migration & cleanup)

### ÎšÎ¯Î½Î´Ï…Î½Î¿Î¹ & MITIGATION
- **ÎšÎ¯Î½Î´Ï…Î½Î¿Ï‚:** Breaking existing functionality
- **Mitigation:** Parallel implementation + comprehensive testing

- **ÎšÎ¯Î½Î´Ï…Î½Î¿Ï‚:** UI glitches during migration
- **Mitigation:** Component-by-component replacement Î¼Îµ testing

### ÎœÎµÏ„ÏÎ®ÏƒÎ¹Î¼Î± Î±Ï€Î¿Ï„ÎµÎ»Î­ÏƒÎ¼Î±Ï„Î±
- [ ] 50% Î¼ÎµÎ¯Ï‰ÏƒÎ· lines of code ÏƒÏ„Î± contexts
- [ ] 0 UI changes
- [ ] 0 functionality changes
- [ ] Î¤Î±Ï‡ÏÏ„ÎµÏÎ· Î±Î½Î¬Ï€Ï„Ï…Î¾Î· Î½Î­Ï‰Î½ components
- [ ] Faster development Î³Î¹Î± Î½Î­Î± entities

## âœ… EXECUTION CHECKLIST

### Î ÏÎ¿ÎµÏ„Î¿Î¹Î¼Î±ÏƒÎ¯Î±
- [x] Backup Ï…Ï€Î¬ÏÏ‡Î¿Î½Ï„Î± Î±ÏÏ‡ÎµÎ¯Î±
- [x] Create feature branch
- [x] Set up testing environment

### Phase 1 Execution
- [x] Create UnifiedSettingsContext
- [x] Implement helper functions
- [x] Basic testing

### Phase 2 Execution
- [x] Create legacy wrappers
- [x] Implement context detection
- [x] Compatibility testing

### Phase 3 Execution
- [x] Simplify components
- [x] Create SettingsProvider
- [x] Component testing

### Phase 4 Execution
- [x] Start migration
- [ ] UI verification Î³Î¹Î± ÎºÎ¬Î¸Îµ replacement
- [ ] Progressive cleanup

### Phase 5 Execution
- [ ] Final functionality verification
- [ ] Performance testing
- [ ] Documentation update

---

**Î£Î—ÎœÎ•Î™Î©Î£Î—:** Î‘Ï…Ï„ÏŒÏ‚ Î¿ refactoring Î¸Î± Î³Î¯Î½ÎµÎ¹ step-by-step. ÎšÎ¬Î¸Îµ Î²Î®Î¼Î± Î¸Î± ÎµÎ»ÎµÎ³Ï‡Î¸ÎµÎ¯ Î¾ÎµÏ‡Ï‰ÏÎ¹ÏƒÏ„Î¬ Ï€ÏÎ¹Î½ Ï€ÏÎ¿Ï‡Ï‰ÏÎ®ÏƒÎ¿Ï…Î¼Îµ ÏƒÏ„Î¿ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿. Î£Ï„ÏŒÏ‡Î¿Ï‚ Î¼Î±Ï‚ ÎµÎ¯Î½Î±Î¹ ÎºÎ±Î¼Î¯Î± UI/UX Î±Î»Î»Î±Î³Î® ÎºÎ±Î¹ Ï€Î»Î®ÏÎ·Ï‚ ÏƒÏ…Î¼Î²Î±Ï„ÏŒÏ„Î·Ï„Î±.