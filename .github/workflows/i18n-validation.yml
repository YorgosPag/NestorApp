name: ðŸŒ i18n Validation

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'src/i18n/**'
      - 'src/components/**'
      - 'scripts/validate-translations.js'
  pull_request:
    branches: [ main, develop ]
    paths:
      - 'src/i18n/**'
      - 'src/components/**'
      - 'scripts/validate-translations.js'

jobs:
  validate-translations:
    name: ðŸ” Validate Translations
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: ðŸ” Validate translation completeness
        run: node scripts/validate-translations.js
        
      - name: ðŸ“Š Generate i18n types
        run: pnpm run generate:i18n-types
        
      - name: âœ… Type check with generated types
        run: pnpm run typecheck
        
      - name: ðŸ” Check for hardcoded strings
        run: |
          echo "ðŸ” Scanning for hardcoded Greek strings..."
          # Search for potential hardcoded Greek strings in components
          if grep -r --include="*.tsx" --include="*.ts" '[Î‘-Î©][Î±-Ï‰Î¬Î­Î®Î¯ÏŒÏÏŽ]*' src/components/ | grep -v 'test' | grep -v '.stories.' > hardcoded_strings.txt; then
            echo "âš ï¸  Found potential hardcoded Greek strings:"
            cat hardcoded_strings.txt
            echo "::warning::Found potential hardcoded Greek strings. Consider using i18n."
          else
            echo "âœ… No hardcoded Greek strings found!"
          fi
          
      - name: ðŸ“ Comment PR with validation results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## ðŸŒ i18n Validation Results\n\n';
            
            // Check if hardcoded strings file exists
            if (fs.existsSync('hardcoded_strings.txt')) {
              const hardcodedStrings = fs.readFileSync('hardcoded_strings.txt', 'utf8');
              if (hardcodedStrings.trim()) {
                comment += 'âš ï¸ **Potential hardcoded strings found:**\n\n';
                comment += '```\n' + hardcodedStrings + '\n```\n\n';
                comment += 'Consider moving these strings to translation files.\n\n';
              }
            } else {
              comment += 'âœ… No hardcoded Greek strings detected!\n\n';
            }
            
            comment += '### ðŸ“Š Translation Status\n';
            comment += '- âœ… Translation completeness validated\n';
            comment += '- âœ… TypeScript types generated successfully\n';
            comment += '- âœ… Type checking passed\n\n';
            comment += '_Generated by i18n validation workflow_';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  check-translation-coverage:
    name: ðŸ“Š Translation Coverage
    runs-on: ubuntu-latest
    needs: validate-translations
    
    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'pnpm'

      - name: ðŸ“¦ Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: ðŸ“¦ Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: ðŸ“Š Generate coverage report
        run: |
          echo "ðŸ” Generating translation coverage report..."
          
          # Count total keys in primary locale (Greek)
          TOTAL_KEYS=$(find src/i18n/locales/el -name "*.json" -exec cat {} \; | jq -r '. as $root | paths(scalars) as $p | $p | join(".")' | wc -l)
          
          # Count keys in English
          EN_KEYS=$(find src/i18n/locales/en -name "*.json" -exec cat {} \; 2>/dev/null | jq -r '. as $root | paths(scalars) as $p | $p | join(".")' | wc -l || echo "0")
          
          # Calculate coverage
          if [ "$TOTAL_KEYS" -gt 0 ]; then
            COVERAGE=$(echo "scale=2; $EN_KEYS * 100 / $TOTAL_KEYS" | bc -l)
          else
            COVERAGE="0"
          fi
          
          echo "ðŸ“Š Translation Coverage Report:"
          echo "Total keys (Greek): $TOTAL_KEYS"
          echo "Translated keys (English): $EN_KEYS"
          echo "Coverage: ${COVERAGE}%"
          
          # Create coverage badge
          echo "COVERAGE=${COVERAGE}" >> $GITHUB_ENV
          echo "TOTAL_KEYS=${TOTAL_KEYS}" >> $GITHUB_ENV
          echo "EN_KEYS=${EN_KEYS}" >> $GITHUB_ENV
          
      - name: ðŸ“ Update README with coverage
        if: github.ref == 'refs/heads/main'
        run: |
          echo "ðŸ”„ Updating README with translation coverage..."
          
          # Create or update translation status section in README
          COVERAGE_BADGE="![Translation Coverage](https://img.shields.io/badge/Translation%20Coverage-${COVERAGE}%25-brightgreen)"
          
          if [ -f README.md ]; then
            # Update existing badge or add new one
            if grep -q "Translation Coverage" README.md; then
              sed -i "s/!\[Translation Coverage\][^)]*/![Translation Coverage](https:\/\/img.shields.io\/badge\/Translation%20Coverage-${COVERAGE}%25-brightgreen)/" README.md
            else
              echo -e "\n## ðŸŒ Internationalization\n\n${COVERAGE_BADGE}\n" >> README.md
            fi
          fi