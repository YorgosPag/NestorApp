rules_version = '2';

// =============================================================================
// ğŸ”’ PRODUCTION-GRADE FIRESTORE SECURITY RULES
// =============================================================================
//
// ğŸ¯ Î£Î¤Î¡Î‘Î¤Î—Î“Î™ÎšÎ—: Deny-all by default, explicit allow per collection
// ğŸ›¡ï¸ Î‘Î¡Î§Î—: Zero Trust - ÎºÎ±Î¼Î¯Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Ï‡Ï‰ÏÎ¯Ï‚ authentication & authorization
// âš ï¸ ÎšÎ¡Î™Î£Î™ÎœÎŸ: Î‘Ï…Ï„Î­Ï‚ Î¿Î¹ rules Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÎ¿Ï…Î½ Ï„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î±Ï€ÏŒ unauthorized access
//
// =============================================================================

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // ğŸš« DEFAULT DENY-ALL RULE
    // =========================================================================
    // ÎŸÏ€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ ÏƒÏ…Î»Î»Î¿Î³Î® Ï€Î¿Ï… Î”Î•Î Î­Ï‡ÎµÎ¹ explicit rule â†’ Î‘Î¡ÎÎ—Î£Î—
    match /{document=**} {
      allow read, write: if false;
    }

    // =========================================================================
    // ğŸ“ PROJECTS COLLECTION - DEV-FRIENDLY ACCESS
    // =========================================================================
    match /projects/{projectId} {

      // ğŸ“– READ: Dev-friendly access - public Î³Î¹Î± development, preparatory Î³Î¹Î± ownership
      allow read: if isDevMode() || isAuthenticated();

      // âœï¸ CREATE: ÎœÏŒÎ½Î¿ authenticated users Î¼Îµ validated data
      allow create: if request.auth != null
                    && isValidProjectData(request.resource.data)
                    && resource == null; // Ensure document doesn't exist

      // ğŸ“ UPDATE: ÎœÏŒÎ½Î¿ authenticated users Î¼Îµ validation
      allow update: if request.auth != null
                    && isValidProjectData(request.resource.data)
                    && resource != null  // Ensure document exists
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ğŸ—‘ï¸ DELETE: ÎœÏŒÎ½Î¿ authenticated users
      allow delete: if request.auth != null
                    && resource != null; // Ensure document exists
    }

    // =========================================================================
    // ğŸ‘¥ CONTACT_RELATIONSHIPS COLLECTION - STRICT OWNERSHIP
    // =========================================================================
    match /contact_relationships/{relationshipId} {

      // ğŸ“– READ: ÎœÏŒÎ½Î¿ authenticated users Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ source Î® target
      allow read: if request.auth != null
                  && (resource.data.sourceContactId == request.auth.uid
                      || resource.data.targetContactId == request.auth.uid);

      // âœï¸ CREATE: ÎœÏŒÎ½Î¿ authenticated users Î³Î¹Î± Î´Î¹ÎºÎ­Ï‚ Ï„Î¿Ï…Ï‚ relationships
      allow create: if request.auth != null
                    && isValidRelationshipData(request.resource.data)
                    && (request.resource.data.sourceContactId == request.auth.uid
                        || request.resource.data.targetContactId == request.auth.uid)
                    && resource == null;

      // ğŸ“ UPDATE: ÎœÏŒÎ½Î¿ owners Î¼Îµ system field protection
      allow update: if request.auth != null
                    && isValidRelationshipData(request.resource.data)
                    && (resource.data.sourceContactId == request.auth.uid
                        || resource.data.targetContactId == request.auth.uid)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ğŸ—‘ï¸ DELETE: ÎœÏŒÎ½Î¿ owners
      allow delete: if request.auth != null
                    && (resource.data.sourceContactId == request.auth.uid
                        || resource.data.targetContactId == request.auth.uid);
    }

    // =========================================================================
    // ğŸ¨ CAD_FILES COLLECTION - ENTERPRISE DXF STORAGE (Firebase Storage + Metadata)
    // =========================================================================
    match /cadFiles/{fileId} {

      // ğŸ“– READ: Dev-friendly access Î¼Îµ ownership support Î³Î¹Î± production
      allow read: if isDevMode()
                  || (request.auth != null
                      && (resource.data.keys().hasAny(['ownerId']) == false
                          || resource.data.ownerId == request.auth.uid));

      // âœï¸ CREATE: Authenticated users Î¼Îµ enterprise validation
      allow create: if request.auth != null
                    && isValidCadFileData(request.resource.data)
                    && (request.resource.data.keys().hasAny(['ownerId']) == false
                        || request.resource.data.ownerId == request.auth.uid)
                    && resource == null;

      // ğŸ“ UPDATE: Enterprise Î¼Îµ system field protection ÎºÎ±Î¹ Storage URL validation
      allow update: if request.auth != null
                    && isValidCadFileData(request.resource.data)
                    && (resource.data.keys().hasAny(['ownerId']) == false
                        || resource.data.ownerId == request.auth.uid)
                    && (request.resource.data.keys().hasAny(['ownerId']) == false
                        || request.resource.data.ownerId == request.auth.uid)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ğŸ—‘ï¸ DELETE: Owner Î¼Îµ development access
      allow delete: if isDevMode()
                    || (request.auth != null
                        && (resource.data.keys().hasAny(['ownerId']) == false
                            || resource.data.ownerId == request.auth.uid));
    }

    // =========================================================================
    // ğŸ¢ COMPANIES COLLECTION - READ-ONLY FOR AUTHENTICATED
    // =========================================================================
    match /companies/{companyId} {

      // ğŸ“– READ: ÎœÏŒÎ½Î¿ authenticated users
      allow read: if request.auth != null;

      // âœï¸ CREATE/UPDATE/DELETE: ÎŒÎ§Î™ Î±Ï€ÏŒ client - Î¼ÏŒÎ½Î¿ admin/server
      allow write: if false;
    }

    // =========================================================================
    // ğŸ  BUILDINGS, FLOORS & UNITS - PUBLIC READ ACCESS
    // =========================================================================
    match /buildings/{buildingId} {
      allow read: if isDevMode() || isAuthenticated(); // Dev-friendly access
      allow write: if false; // Admin/server only
    }

    // ğŸ¢ FLOORS: ÎŸÏÏŒÏ†Î¿Î¹ ÎºÏ„Î¹ÏÎ¯Ï‰Î½ - Navigation hierarchy support
    match /floors/{floorId} {
      allow read: if isDevMode() || isAuthenticated(); // Dev-friendly access
      allow write: if false; // Admin/server only
    }

    match /units/{unitId} {
      allow read: if isDevMode() || isAuthenticated(); // Dev-friendly access
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸ“¦ STORAGE_UNITS COLLECTION - PARALLEL CATEGORY (local_4.log)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Storage units are a PARALLEL category to Units, not nested
    // Architecture: Building â†’ [Units | Storage | Parking] (parallel)
    match /storage_units/{storageId} {
      allow read: if isDevMode() || isAuthenticated(); // Dev-friendly access
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸš— PARKING_SPOTS COLLECTION - PARALLEL CATEGORY (local_4.log)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Parking spaces are a PARALLEL category to Units, not nested
    // Architecture: Building â†’ [Units | Storage | Parking] (parallel)
    // ğŸ“ Collection name: parking_spots (Î¼Îµ underscore - ÏŒÏ€Ï‰Ï‚ ÏƒÏ„Î· Firestore)
    match /parking_spots/{parkingId} {
      allow read: if isDevMode() || isAuthenticated(); // Dev-friendly access
      allow write: if isDevMode(); // Dev-friendly write access for seeding
    }

    // =========================================================================
    // ğŸ§­ NAVIGATION_COMPANIES COLLECTION - DEV-FRIENDLY READ ACCESS
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Î•Ï„Î±Î¹ÏÎµÎ¯ÎµÏ‚ Ï€Î¿Ï… ÎµÎ¼Ï†Î±Î½Î¯Î¶Î¿Î½Ï„Î±Î¹ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î± ÏƒÏ„Î·Î½ Ï€Î»Î¿Î®Î³Î·ÏƒÎ·
    // Î ÎµÏÎ¹Î­Ï‡ÎµÎ¹ contactIds Ï€Î¿Ï… Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡Î¿ÏÎ½ ÏƒÎµ ÎµÏ„Î±Î¹ÏÎµÎ¯ÎµÏ‚ ÏƒÏ„Î· contacts collection
    match /navigation_companies/{navCompanyId} {
      allow read: if isDevMode() || isAuthenticated(); // Dev-friendly access
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸ”” NOTIFICATIONS COLLECTION - PUBLIC READ ACCESS
    // =========================================================================
    match /notifications/{notificationId} {
      allow read: if true; // Public read access for notifications
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸ“ CONTACTS COLLECTION - PUBLIC READ ACCESS
    // =========================================================================
    match /contacts/{contactId} {

      // ğŸ“– READ: Dev-friendly access, preparatory Î³Î¹Î± ownership
      allow read: if isDevMode() || (request.auth != null && request.auth.uid == contactId);

      // âœï¸ CREATE: ÎœÏŒÎ½Î¿ Î³Î¹Î± Ï„Î¿Î½ ÎµÎ±Ï…Ï„ÏŒ Ï„Î¿Ï…
      allow create: if request.auth != null
                    && request.auth.uid == contactId
                    && isValidContactData(request.resource.data)
                    && resource == null;

      // ğŸ“ UPDATE: ÎœÏŒÎ½Î¿ Î¿ Î¯Î´Î¹Î¿Ï‚ Î¼Îµ system field protection
      allow update: if request.auth != null
                    && request.auth.uid == contactId
                    && isValidContactData(request.resource.data)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ğŸ—‘ï¸ DELETE: ÎœÏŒÎ½Î¿ Î¿ Î¯Î´Î¹Î¿Ï‚
      allow delete: if request.auth != null
                    && request.auth.uid == contactId;
    }

    // =========================================================================
    // ğŸ”’ HELPER FUNCTIONS - VALIDATION & SECURITY
    // =========================================================================

    // Project Data Validation
    function isValidProjectData(data) {
      return data.keys().hasAll(['name', 'status', 'company'])
             && data.name is string && data.name.size() > 0
             && data.status in ['planning', 'in_progress', 'completed', 'on_hold', 'cancelled']
             && data.company is string && data.company.size() > 0;
    }

    // Relationship Data Validation
    function isValidRelationshipData(data) {
      return data.keys().hasAll(['sourceContactId', 'targetContactId', 'relationshipType', 'status'])
             && data.sourceContactId is string && data.sourceContactId.size() > 0
             && data.targetContactId is string && data.targetContactId.size() > 0
             && data.relationshipType in ['employee', 'manager', 'partner', 'client', 'vendor']
             && data.status in ['active', 'inactive', 'pending', 'deleted'];
    }

    // ğŸ¨ Enterprise CAD File Data Validation (Firebase Storage + Metadata Only)
    function isValidCadFileData(data) {
      return data.keys().hasAll(['fileName'])
             && data.fileName is string && data.fileName.size() > 0
             // ğŸš¨ ÎšÎ¡Î™Î£Î™ÎœÎŸ: Î”Î•Î ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î¼Îµ scene object ÏƒÏ„Î¿ Firestore! (ÎœÏ€Î±ÎºÎ¬Î»Î¹ÎºÎ¿ Î³ÎµÎ¹Ï„Î¿Î½Î¹Î¬Ï‚)
             && !data.keys().hasAny(['scene'])
             // âœ… ENTERPRISE: Firebase Storage-based validation
             && (
               // Legacy format (Firestore-based data)
               !data.keys().hasAny(['storageUrl']) ||
               // ğŸ¢ ENTERPRISE FORMAT: Firebase Storage Î¼Îµ metadata
               (data.keys().hasAll(['storageUrl'])
                && data.storageUrl is string
                && data.storageUrl.size() > 0
                // âœ… Validate Firebase Storage URL format
                && data.storageUrl.matches('https://firebasestorage.googleapis.com/.*'))
             )
             // âœ… Enterprise metadata validation
             && (!data.keys().hasAny(['version']) || (data.version is number && data.version > 0))
             && (!data.keys().hasAny(['sizeBytes']) || (data.sizeBytes is number && data.sizeBytes > 0))
             && (!data.keys().hasAny(['entityCount']) || (data.entityCount is number && data.entityCount >= 0))
             && (!data.keys().hasAny(['checksum']) || (data.checksum is string && data.checksum.size() > 0));
    }

    // Contact Data Validation
    function isValidContactData(data) {
      return data.keys().hasAll(['email'])
             && data.email is string
             && data.email.matches('.*@.*\\..*'); // Basic email validation
    }

    // System Fields Protection
    function isAttemptingToModifySystemFields(newData, existingData) {
      let systemFields = ['createdAt', 'createdBy', 'ownerId', 'id'];
      return systemFields.hasAny(
        newData.diff(existingData).affectedKeys()
      );
    }

    // Relationship checking helper
    function hasRelationshipWithContact(userId, contactId) {
      // This would need to be implemented based on your relationship logic
      // For now, allowing basic access - you can refine this later
      return true;
    }

    // =========================================================================
    // ğŸ—ï¸ DEVELOPMENT MODE HELPERS
    // =========================================================================

    // Dev mode helper - ÎµÏ€Î¹Ï„ÏÎ­Ï€ÎµÎ¹ public access Î³Î¹Î± development
    function isDevMode() {
      // ğŸš¨ DEV FLAG: Î˜Î± Î±Î»Î»Î¬Î¾ÎµÎ¹ ÏŒÏ„Î±Î½ Ï€Î¬Î¼Îµ ÏƒÎµ production
      return true; // Currently in development mode
    }

    // Authentication helper
    function isAuthenticated() {
      return request.auth != null;
    }

    // User ownership helper
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
  }
}