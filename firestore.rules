rules_version = '2';

// =============================================================================
// üîí PRODUCTION-GRADE FIRESTORE SECURITY RULES
// =============================================================================
//
// üéØ Œ£Œ§Œ°ŒëŒ§ŒóŒìŒôŒöŒó: Deny-all by default, explicit allow per collection
// üõ°Ô∏è ŒëŒ°ŒßŒó: Zero Trust - Œ∫Œ±ŒºŒØŒ± œÄœÅœåœÉŒ≤Œ±œÉŒ∑ œáœâœÅŒØœÇ authentication & authorization
// ‚ö†Ô∏è ŒöŒ°ŒôŒ£ŒôŒúŒü: ŒëœÖœÑŒ≠œÇ ŒøŒπ rules œÄœÅŒøœÉœÑŒ±œÑŒµœçŒøœÖŒΩ œÑŒ∑ŒΩ ŒµœÜŒ±œÅŒºŒøŒ≥ŒÆ Œ±œÄœå unauthorized access
//
// =============================================================================

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // üö´ DEFAULT DENY-ALL RULE
    // =========================================================================
    // ŒüœÄŒøŒπŒ±Œ¥ŒÆœÄŒøœÑŒµ œÉœÖŒªŒªŒøŒ≥ŒÆ œÄŒøœÖ ŒîŒïŒù Œ≠œáŒµŒπ explicit rule ‚Üí ŒëŒ°ŒùŒóŒ£Œó
    match /{document=**} {
      allow read, write: if false;
    }

    // =========================================================================
    // üìÅ PROJECTS COLLECTION - DEV-FRIENDLY ACCESS
    // =========================================================================
    match /projects/{projectId} {

      // üìñ READ: Authenticated users only (Production mode)
      allow read: if isAuthenticated();

      // ‚úçÔ∏è CREATE: ŒúœåŒΩŒø authenticated users ŒºŒµ validated data
      allow create: if request.auth != null
                    && isValidProjectData(request.resource.data)
                    && resource == null; // Ensure document doesn't exist

      // üìù UPDATE: ŒúœåŒΩŒø authenticated users ŒºŒµ validation
      allow update: if request.auth != null
                    && isValidProjectData(request.resource.data)
                    && resource != null  // Ensure document exists
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // üóëÔ∏è DELETE: ŒúœåŒΩŒø authenticated users
      allow delete: if request.auth != null
                    && resource != null; // Ensure document exists
    }

    // =========================================================================
    // üë• CONTACT_RELATIONSHIPS COLLECTION - STRICT OWNERSHIP
    // =========================================================================
    match /contact_relationships/{relationshipId} {

      // üìñ READ: ŒúœåŒΩŒø authenticated users œÄŒøœÖ ŒµŒØŒΩŒ±Œπ source ŒÆ target
      allow read: if request.auth != null
                  && (resource.data.sourceContactId == request.auth.uid
                      || resource.data.targetContactId == request.auth.uid);

      // ‚úçÔ∏è CREATE: ŒúœåŒΩŒø authenticated users Œ≥ŒπŒ± Œ¥ŒπŒ∫Œ≠œÇ œÑŒøœÖœÇ relationships
      allow create: if request.auth != null
                    && isValidRelationshipData(request.resource.data)
                    && (request.resource.data.sourceContactId == request.auth.uid
                        || request.resource.data.targetContactId == request.auth.uid)
                    && resource == null;

      // üìù UPDATE: ŒúœåŒΩŒø owners ŒºŒµ system field protection
      allow update: if request.auth != null
                    && isValidRelationshipData(request.resource.data)
                    && (resource.data.sourceContactId == request.auth.uid
                        || resource.data.targetContactId == request.auth.uid)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // üóëÔ∏è DELETE: ŒúœåŒΩŒø owners
      allow delete: if request.auth != null
                    && (resource.data.sourceContactId == request.auth.uid
                        || resource.data.targetContactId == request.auth.uid);
    }

    // =========================================================================
    // üé® CAD_FILES COLLECTION - ENTERPRISE DXF STORAGE (Firebase Storage + Metadata)
    // =========================================================================
    match /cadFiles/{fileId} {

      // üìñ READ: Authenticated with ownership support (Production mode)
      allow read: if request.auth != null
                  && (resource.data.keys().hasAny(['ownerId']) == false
                      || resource.data.ownerId == request.auth.uid);

      // ‚úçÔ∏è CREATE: Authenticated users ŒºŒµ enterprise validation
      allow create: if request.auth != null
                    && isValidCadFileData(request.resource.data)
                    && (request.resource.data.keys().hasAny(['ownerId']) == false
                        || request.resource.data.ownerId == request.auth.uid)
                    && resource == null;

      // üìù UPDATE: Enterprise ŒºŒµ system field protection Œ∫Œ±Œπ Storage URL validation
      allow update: if request.auth != null
                    && isValidCadFileData(request.resource.data)
                    && (resource.data.keys().hasAny(['ownerId']) == false
                        || resource.data.ownerId == request.auth.uid)
                    && (request.resource.data.keys().hasAny(['ownerId']) == false
                        || request.resource.data.ownerId == request.auth.uid)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // üóëÔ∏è DELETE: Owner only (Production mode)
      allow delete: if request.auth != null
                    && (resource.data.keys().hasAny(['ownerId']) == false
                        || resource.data.ownerId == request.auth.uid);
    }

    // =========================================================================
    // üè¢ COMPANIES COLLECTION - READ-ONLY FOR AUTHENTICATED
    // =========================================================================
    match /companies/{companyId} {

      // üìñ READ: ŒúœåŒΩŒø authenticated users
      allow read: if request.auth != null;

      // ‚úçÔ∏è CREATE/UPDATE/DELETE: ŒåŒßŒô Œ±œÄœå client - ŒºœåŒΩŒø admin/server
      allow write: if false;
    }

    // =========================================================================
    // üè† BUILDINGS, FLOORS & UNITS - PUBLIC READ ACCESS
    // =========================================================================
    match /buildings/{buildingId} {
      allow read: if true; // Public read for API routes (server-side)
      allow write: if false; // Admin/server only
    }

    // üè¢ FLOORS: ŒüœÅœåœÜŒøŒπ Œ∫œÑŒπœÅŒØœâŒΩ - Navigation hierarchy support
    match /floors/{floorId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    match /units/{unitId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // üì¶ STORAGE_UNITS COLLECTION - PARALLEL CATEGORY (local_4.log)
    // =========================================================================
    // üè¢ ENTERPRISE: Storage units are a PARALLEL category to Units, not nested
    // Architecture: Building ‚Üí [Units | Storage | Parking] (parallel)
    match /storage_units/{storageId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // üöó PARKING_SPOTS COLLECTION - PARALLEL CATEGORY (local_4.log)
    // =========================================================================
    // üè¢ ENTERPRISE: Parking spaces are a PARALLEL category to Units, not nested
    // Architecture: Building ‚Üí [Units | Storage | Parking] (parallel)
    // üìç Collection name: parking_spots (ŒºŒµ underscore - œåœÄœâœÇ œÉœÑŒ∑ Firestore)
    match /parking_spots/{parkingId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only (use Firebase Admin SDK for seeding)
    }

    // =========================================================================
    // üß≠ NAVIGATION_COMPANIES COLLECTION - DEV-FRIENDLY READ ACCESS
    // =========================================================================
    // üè¢ ENTERPRISE: ŒïœÑŒ±ŒπœÅŒµŒØŒµœÇ œÄŒøœÖ ŒµŒºœÜŒ±ŒΩŒØŒ∂ŒøŒΩœÑŒ±Œπ œáŒµŒπœÅŒøŒ∫ŒØŒΩŒ∑œÑŒ± œÉœÑŒ∑ŒΩ œÄŒªŒøŒÆŒ≥Œ∑œÉŒ∑
    // Œ†ŒµœÅŒπŒ≠œáŒµŒπ contactIds œÄŒøœÖ Œ±ŒΩœÑŒπœÉœÑŒøŒπœáŒøœçŒΩ œÉŒµ ŒµœÑŒ±ŒπœÅŒµŒØŒµœÇ œÉœÑŒ∑ contacts collection
    match /navigation_companies/{navCompanyId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // üîî NOTIFICATIONS COLLECTION - USER-SCOPED ACCESS
    // =========================================================================
    // üè¢ ENTERPRISE: Secure notification access per user
    // üîí AUTHENTICATED: User can only access their own notifications
    // üìã ADR-027: CRM Notifications Integration - Updated 2026-01-13
    // ‚ö†Ô∏è NOTE: For list queries, the userId filter must be in the query itself
    //          (where userId == auth.uid). Rules validate single doc reads.
    match /notifications/{notificationId} {
      // üìñ READ: Authenticated users can read notifications
      // Query MUST include: where('userId', '==', currentUserId) for security
      // Single doc reads verify ownership
      allow read: if isAuthenticated()
                  && (resource == null || resource.data.userId == request.auth.uid);

      // üìù UPDATE: Users can mark their own notifications as read
      // Only allows updating delivery state and seen timestamp
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && isValidNotificationUpdate(request.resource.data, resource.data);

      // ‚úÖ CREATE: Authenticated users can create notifications for themselves
      // üè¢ ENTERPRISE: In production, this should be server-only
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;

      // üóëÔ∏è DELETE: Users can delete their own notifications
      // üè¢ ENTERPRISE: Allows cleanup of test notifications
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }

    // =========================================================================
    // ‚úÖ TASKS COLLECTION - CRM TASK MANAGEMENT
    // =========================================================================
    // üè¢ ENTERPRISE: Task management Œ≥ŒπŒ± CRM leads, projects, Œ∫Œ±Œπ users
    // üîí AUTHENTICATED: ŒúœåŒΩŒø authenticated users Œ≠œáŒøœÖŒΩ œÄœÅœåœÉŒ≤Œ±œÉŒ∑
    // üìã ADR-026: CRM Tasks Backend Fix - Added 2026-01-13
    match /tasks/{taskId} {

      // üìñ READ: Authenticated users can read tasks
      // TODO: Future enhancement - filter by assignedTo or leadId ownership
      allow read: if isAuthenticated();

      // ‚úçÔ∏è CREATE: Authenticated users can create tasks
      allow create: if isAuthenticated()
                    && isValidTaskData(request.resource.data)
                    && resource == null;

      // üìù UPDATE: Authenticated users can update tasks
      allow update: if isAuthenticated()
                    && isValidTaskData(request.resource.data)
                    && resource != null;

      // üóëÔ∏è DELETE: Authenticated users can delete tasks
      allow delete: if isAuthenticated()
                    && resource != null;
    }

    // =========================================================================
    // üìê PROJECT_FLOORPLANS COLLECTION - DXF/PDF FLOORPLAN STORAGE
    // =========================================================================
    // üè¢ ENTERPRISE: Floorplans for projects, buildings, units
    match /project_floorplans/{floorplanId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Authenticated users can manage floorplans
    }

    // =========================================================================
    // üìê BUILDING_FLOORPLANS COLLECTION - BUILDING-LEVEL FLOORPLANS
    // =========================================================================
    match /building_floorplans/{floorplanId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // üìê UNIT_FLOORPLANS COLLECTION - UNIT-LEVEL FLOORPLANS
    // =========================================================================
    match /unit_floorplans/{floorplanId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // üéöÔ∏è DXF-VIEWER-LEVELS COLLECTION - DXF VIEWER LAYER/LEVEL SYSTEM
    // =========================================================================
    // üè¢ ENTERPRISE: Levels for DXF viewer layer management
    match /dxf-viewer-levels/{levelId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // üîê SECURITY_ROLES COLLECTION - ŒöŒ°ŒôŒ£ŒôŒúŒü ŒìŒôŒë LOGIN!
    // =========================================================================
    // üè¢ ENTERPRISE: Role-based access control Œ≥ŒπŒ± EnterpriseSecurityService
    match /security_roles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // üë§ USERS COLLECTION & SESSIONS SUBCOLLECTION
    // =========================================================================
    // üè¢ ENTERPRISE: User profile Œ∫Œ±Œπ active sessions management
    // üîí OWNERSHIP-BASED: ŒöŒ¨Œ∏Œµ œáœÅŒÆœÉœÑŒ∑œÇ ŒºœÄŒøœÅŒµŒØ ŒΩŒ± Œ¥ŒπŒ±œáŒµŒπœÅŒØŒ∂ŒµœÑŒ±Œπ ŒúŒüŒùŒü œÑŒ± Œ¥ŒπŒ∫Œ¨ œÑŒøœÖ
    match /users/{userId} {
      // üìñ READ/WRITE: ŒúœåŒΩŒø Œø ŒØŒ¥ŒπŒøœÇ Œø œáœÅŒÆœÉœÑŒ∑œÇ
      allow read, write: if isOwner(userId);

      // üîê SESSIONS SUBCOLLECTION - Enterprise Active Sessions Management
      match /sessions/{sessionId} {
        // Œü œáœÅŒÆœÉœÑŒ∑œÇ ŒºœÄŒøœÅŒµŒØ ŒΩŒ± Œ¥ŒπŒ±Œ≤Œ¨Œ∂ŒµŒπ Œ∫Œ±Œπ ŒΩŒ± Œ≥œÅŒ¨œÜŒµŒπ ŒúŒüŒùŒü œÑŒ± Œ¥ŒπŒ∫Œ¨ œÑŒøœÖ sessions
        allow read, write: if isOwner(userId);
      }
    }

    // =========================================================================
    // üîê USER_2FA_SETTINGS COLLECTION - Two-Factor Authentication
    // =========================================================================
    // üè¢ ENTERPRISE: 2FA settings Œ∫Œ±Œπ backup codes storage
    // üîí OWNERSHIP-BASED: ŒöŒ¨Œ∏Œµ œáœÅŒÆœÉœÑŒ∑œÇ ŒºœÄŒøœÅŒµŒØ ŒΩŒ± Œ¥ŒπŒ±œáŒµŒπœÅŒØŒ∂ŒµœÑŒ±Œπ ŒúŒüŒùŒü œÑŒ± Œ¥ŒπŒ∫Œ¨ œÑŒøœÖ 2FA settings
    match /user_2fa_settings/{userId} {
      // Œü œáœÅŒÆœÉœÑŒ∑œÇ ŒºœÄŒøœÅŒµŒØ ŒΩŒ± Œ¥ŒπŒ±Œ≤Œ¨Œ∂ŒµŒπ Œ∫Œ±Œπ ŒΩŒ± Œ≥œÅŒ¨œÜŒµŒπ ŒúŒüŒùŒü œÑŒ± Œ¥ŒπŒ∫Œ¨ œÑŒøœÖ 2FA settings
      allow read, write: if isOwner(userId);
    }

    // =========================================================================
    // üîî USER_NOTIFICATION_SETTINGS COLLECTION - Notification Preferences
    // =========================================================================
    // üè¢ ENTERPRISE: User notification preferences management
    // üîí OWNERSHIP-BASED: ŒöŒ¨Œ∏Œµ œáœÅŒÆœÉœÑŒ∑œÇ ŒºœÄŒøœÅŒµŒØ ŒΩŒ± Œ¥ŒπŒ±œáŒµŒπœÅŒØŒ∂ŒµœÑŒ±Œπ ŒúŒüŒùŒü œÑŒπœÇ Œ¥ŒπŒ∫Œ≠œÇ œÑŒøœÖ œÅœÖŒ∏ŒºŒØœÉŒµŒπœÇ
    match /user_notification_settings/{userId} {
      // Œü œáœÅŒÆœÉœÑŒ∑œÇ ŒºœÄŒøœÅŒµŒØ ŒΩŒ± Œ¥ŒπŒ±Œ≤Œ¨Œ∂ŒµŒπ Œ∫Œ±Œπ ŒΩŒ± Œ≥œÅŒ¨œÜŒµŒπ ŒúŒüŒùŒü œÑŒπœÇ Œ¥ŒπŒ∫Œ≠œÇ œÑŒøœÖ œÅœÖŒ∏ŒºŒØœÉŒµŒπœÇ ŒµŒπŒ¥ŒøœÄŒøŒπŒÆœÉŒµœâŒΩ
      allow read, write: if isOwner(userId);
    }

    // =========================================================================
    // üìû CONTACTS COLLECTION - PUBLIC READ ACCESS
    // =========================================================================
    match /contacts/{contactId} {

      // üìñ READ: Authenticated users can read contacts (for business operations)
      // TODO: Refine to project-based access when relationships are implemented
      allow read: if isAuthenticated();

      // ‚úçÔ∏è CREATE: ŒúœåŒΩŒø Œ≥ŒπŒ± œÑŒøŒΩ ŒµŒ±œÖœÑœå œÑŒøœÖ
      allow create: if request.auth != null
                    && request.auth.uid == contactId
                    && isValidContactData(request.resource.data)
                    && resource == null;

      // üìù UPDATE: ŒúœåŒΩŒø Œø ŒØŒ¥ŒπŒøœÇ ŒºŒµ system field protection
      allow update: if request.auth != null
                    && request.auth.uid == contactId
                    && isValidContactData(request.resource.data)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // üóëÔ∏è DELETE: ŒúœåŒΩŒø Œø ŒØŒ¥ŒπŒøœÇ
      allow delete: if request.auth != null
                    && request.auth.uid == contactId;
    }

    // =========================================================================
    // üîí HELPER FUNCTIONS - VALIDATION & SECURITY
    // =========================================================================

    // Project Data Validation
    function isValidProjectData(data) {
      return data.keys().hasAll(['name', 'status', 'company'])
             && data.name is string && data.name.size() > 0
             && data.status in ['planning', 'in_progress', 'completed', 'on_hold', 'cancelled']
             && data.company is string && data.company.size() > 0;
    }

    // Relationship Data Validation
    function isValidRelationshipData(data) {
      return data.keys().hasAll(['sourceContactId', 'targetContactId', 'relationshipType', 'status'])
             && data.sourceContactId is string && data.sourceContactId.size() > 0
             && data.targetContactId is string && data.targetContactId.size() > 0
             && data.relationshipType in ['employee', 'manager', 'partner', 'client', 'vendor']
             && data.status in ['active', 'inactive', 'pending', 'deleted'];
    }

    // üé® Enterprise CAD File Data Validation (Firebase Storage + Metadata Only)
    function isValidCadFileData(data) {
      return data.keys().hasAll(['fileName'])
             && data.fileName is string && data.fileName.size() > 0
             // üö® ŒöŒ°ŒôŒ£ŒôŒúŒü: ŒîŒïŒù ŒµœÄŒπœÑœÅŒ≠œÄŒøœÖŒºŒµ scene object œÉœÑŒø Firestore! (ŒúœÄŒ±Œ∫Œ¨ŒªŒπŒ∫Œø Œ≥ŒµŒπœÑŒøŒΩŒπŒ¨œÇ)
             && !data.keys().hasAny(['scene'])
             // ‚úÖ ENTERPRISE: Firebase Storage-based validation
             && (
               // Legacy format (Firestore-based data)
               !data.keys().hasAny(['storageUrl']) ||
               // üè¢ ENTERPRISE FORMAT: Firebase Storage ŒºŒµ metadata
               (data.keys().hasAll(['storageUrl'])
                && data.storageUrl is string
                && data.storageUrl.size() > 0
                // ‚úÖ Validate Firebase Storage URL format
                && data.storageUrl.matches('https://firebasestorage.googleapis.com/.*'))
             )
             // ‚úÖ Enterprise metadata validation
             && (!data.keys().hasAny(['version']) || (data.version is number && data.version > 0))
             && (!data.keys().hasAny(['sizeBytes']) || (data.sizeBytes is number && data.sizeBytes > 0))
             && (!data.keys().hasAny(['entityCount']) || (data.entityCount is number && data.entityCount >= 0))
             && (!data.keys().hasAny(['checksum']) || (data.checksum is string && data.checksum.size() > 0));
    }

    // Contact Data Validation
    function isValidContactData(data) {
      return data.keys().hasAll(['email'])
             && data.email is string
             && data.email.matches('.*@.*\\..*'); // Basic email validation
    }

    // ‚úÖ Task Data Validation (ADR-026: CRM Tasks Backend Fix)
    // üè¢ ENTERPRISE: Validates CrmTask structure for Firestore operations
    function isValidTaskData(data) {
      return data.keys().hasAll(['title', 'type', 'assignedTo', 'status', 'priority'])
             // üìù Title validation
             && data.title is string && data.title.size() > 0
             // üìã Type validation (enum)
             && data.type in ['call', 'email', 'meeting', 'viewing', 'document', 'follow_up', 'other']
             // üë§ AssignedTo validation (User ID)
             && data.assignedTo is string && data.assignedTo.size() > 0
             // üìä Status validation (enum)
             && data.status in ['pending', 'in_progress', 'completed', 'cancelled']
             // ‚ö° Priority validation (enum)
             && data.priority in ['low', 'medium', 'high', 'urgent']
             // üîó Optional leadId validation
             && (!data.keys().hasAny(['leadId']) || (data.leadId is string))
             // üîó Optional contactId validation
             && (!data.keys().hasAny(['contactId']) || (data.contactId is string))
             // üîó Optional projectId validation
             && (!data.keys().hasAny(['projectId']) || (data.projectId is string))
             // üìù Optional description validation
             && (!data.keys().hasAny(['description']) || (data.description is string));
    }

    // =========================================================================
    // üîî NOTIFICATION UPDATE VALIDATION
    // =========================================================================
    // üìã ADR-027: CRM Notifications Integration - Added 2026-01-13
    // üîí ENTERPRISE: Only allows updating delivery state fields
    function isValidNotificationUpdate(newData, existingData) {
      // List of fields that users are allowed to modify
      let allowedFields = ['delivery', 'seenAt', 'actedAt', 'actionId'];

      // Get the fields that changed
      let changedKeys = newData.diff(existingData).affectedKeys();

      // All changed fields must be in the allowed list
      return changedKeys.hasOnly(allowedFields)
             // Ensure delivery state is valid if being updated
             && (!changedKeys.hasAny(['delivery'])
                 || newData.delivery.state in ['queued', 'sent', 'delivered', 'seen', 'acted', 'failed', 'expired'])
             // Ensure userId is never changed
             && newData.userId == existingData.userId
             // Ensure title is never changed
             && newData.title == existingData.title;
    }

    // System Fields Protection
    function isAttemptingToModifySystemFields(newData, existingData) {
      let systemFields = ['createdAt', 'createdBy', 'ownerId', 'id'];
      return systemFields.hasAny(
        newData.diff(existingData).affectedKeys()
      );
    }

    // Relationship checking helper
    function hasRelationshipWithContact(userId, contactId) {
      // This would need to be implemented based on your relationship logic
      // For now, allowing basic access - you can refine this later
      return true;
    }

    // =========================================================================
    // üèóÔ∏è DEVELOPMENT MODE HELPERS
    // =========================================================================

    // Dev mode helper - PRODUCTION MODE ENABLED
    function isDevMode() {
      // üîí PRODUCTION: Dev mode disabled for security
      // Changed from true ‚Üí false on 2026-01-11 (Security Audit Fix)
      return false;
    }

    // Authentication helper
    function isAuthenticated() {
      return request.auth != null;
    }

    // User ownership helper
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // =========================================================================
    // üîê RFC v6 AUTHORIZATION HELPERS (PHASE 1 PREPARATION)
    // =========================================================================
    // These helpers enable future tenant-scoped access control.
    // Path migration: /collection/{id} ‚Üí /companies/{companyId}/collection/{id}
    //
    // @see docs/rfc/authorization-rbac.md

    // Get user's companyId from custom claims
    function getUserCompanyId() {
      return request.auth.token.companyId;
    }

    // Get user's globalRole from custom claims
    function getGlobalRole() {
      return request.auth.token.globalRole;
    }

    // Check if user is super_admin (system-wide access)
    function isSuperAdminOnly() {
      return isAuthenticated() && getGlobalRole() == 'super_admin';
    }

    // Check if user is company_admin or higher
    function isCompanyAdmin() {
      return isAuthenticated() && getGlobalRole() in ['super_admin', 'company_admin'];
    }

    // Check if user is internal_user or higher
    function isInternalUser() {
      return isAuthenticated() && getGlobalRole() in ['super_admin', 'company_admin', 'internal_user'];
    }

    // Check if user belongs to a specific company (tenant isolation)
    function belongsToCompany(companyId) {
      return isAuthenticated() && getUserCompanyId() == companyId;
    }

    // P0-B FIX: Tenant-bound company admin (prevents cross-tenant writes)
    function isCompanyAdminOfCompany(companyId) {
      return isSuperAdminOnly() ||
             (getGlobalRole() == 'company_admin' && belongsToCompany(companyId));
    }

    // P0-B FIX: Tenant-bound internal user (prevents cross-tenant reads)
    function isInternalUserOfCompany(companyId) {
      return isSuperAdminOnly() ||
             (isInternalUser() && belongsToCompany(companyId));
    }

    // Validate parent document exists (for subcollections - prevents injection)
    function parentExists(path) {
      return exists(path);
    }
  }
}
