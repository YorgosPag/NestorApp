rules_version = '2';

// =============================================================================
// ğŸ”’ PRODUCTION-GRADE FIRESTORE SECURITY RULES
// =============================================================================
//
// ğŸ¯ Î£Î¤Î¡Î‘Î¤Î—Î“Î™ÎšÎ—: Deny-all by default, explicit allow per collection
// ğŸ›¡ï¸ Î‘Î¡Î§Î—: Zero Trust - ÎºÎ±Î¼Î¯Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Ï‡Ï‰ÏÎ¯Ï‚ authentication & authorization
// âš ï¸ ÎšÎ¡Î™Î£Î™ÎœÎŸ: Î‘Ï…Ï„Î­Ï‚ Î¿Î¹ rules Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÎ¿Ï…Î½ Ï„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î±Ï€ÏŒ unauthorized access
//
// =============================================================================

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // ğŸš« DEFAULT DENY-ALL RULE
    // =========================================================================
    // ÎŸÏ€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ ÏƒÏ…Î»Î»Î¿Î³Î® Ï€Î¿Ï… Î”Î•Î Î­Ï‡ÎµÎ¹ explicit rule â†’ Î‘Î¡ÎÎ—Î£Î—
    match /{document=**} {
      allow read, write: if false;
    }

    // =========================================================================
    // ğŸ“ PROJECTS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1B)
    // =========================================================================
    // ğŸ”’ SECURITY: Tenant-scoped access via companyId field
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1B)
    // ğŸ¢ ENTERPRISE: Follows /files pattern (lines 121-226)
    //
    // Security Model:
    //   - READ: Only users from the project's company (tenant-scoped)
    //   - CREATE: companyId must match user's company claim
    //   - UPDATE: Creator or company admin, companyId immutable
    //   - DELETE: Creator or company admin
    // =========================================================================
    match /projects/{projectId} {

      // ğŸ“– READ: Tenant-scoped - only users from the project's company
      // ğŸ”’ SECURITY: Prevents cross-tenant data leak
      allow read: if isAuthenticated()
                  && (
                       // Super admin can read all projects
                       isSuperAdminOnly()
                       // OR user belongs to the project's company
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // LEGACY FALLBACK (TRANSITIONAL - STRICT):
                       // Projects without companyId - creator-only get access
                       // âš ï¸ NOTE: Requires data migration
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.keys().hasAny(['createdBy'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: Authenticated users with companyId from claims
      // ğŸ” SECURITY: companyId MUST match user's company claim (no cross-tenant creation)
      // ğŸ¢ EXCEPTION: Super Admin can create projects for any company
      allow create: if isAuthenticated()
                    && isValidProjectData(request.resource.data)
                    && resource == null
                    && (
                         // Super Admin can create for any company
                         isSuperAdminOnly()
                         // OR user creates for their own company
                         || request.resource.data.companyId == getUserCompanyId()
                       );

      // ğŸ“ UPDATE: Creator or company admin with tenant check
      // ğŸ” SECURITY: companyId is immutable (no re-tenanting)
      allow update: if isAuthenticated()
                    && isValidProjectData(request.resource.data)
                    && resource != null
                    && (
                         // Creator can always update
                         resource.data.createdBy == request.auth.uid
                         // OR company admin of project's company
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         // OR super admin
                         || isSuperAdminOnly()
                       )
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data)
                    // Prevent changing companyId (no re-tenanting)
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ‘¥ CONTACT_RELATIONSHIPS COLLECTION - STRICT OWNERSHIP
    // =========================================================================
    match /contact_relationships/{relationshipId} {

      // ğŸ“– READ: ÎœÏŒÎ½Î¿ authenticated users Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ source Î® target
      allow read: if request.auth != null
                  && (resource.data.sourceContactId == request.auth.uid
                      || resource.data.targetContactId == request.auth.uid);

      // âœï¸ CREATE: ÎœÏŒÎ½Î¿ authenticated users Î³Î¹Î± Î´Î¹ÎºÎ­Ï‚ Ï„Î¿Ï…Ï‚ relationships
      allow create: if request.auth != null
                    && isValidRelationshipData(request.resource.data)
                    && (request.resource.data.sourceContactId == request.auth.uid
                        || request.resource.data.targetContactId == request.auth.uid)
                    && resource == null;

      // ğŸ“ UPDATE: ÎœÏŒÎ½Î¿ owners Î¼Îµ system field protection
      allow update: if request.auth != null
                    && isValidRelationshipData(request.resource.data)
                    && (resource.data.sourceContactId == request.auth.uid
                        || resource.data.targetContactId == request.auth.uid)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ğŸ—‘ï¸ DELETE: ÎœÏŒÎ½Î¿ owners
      allow delete: if request.auth != null
                    && (resource.data.sourceContactId == request.auth.uid
                        || resource.data.targetContactId == request.auth.uid);
    }

    // =========================================================================
    // ğŸ¨ CAD_FILES COLLECTION - ENTERPRISE DXF STORAGE (Firebase Storage + Metadata)
    // =========================================================================
    // Internal storage for DXF scene metadata (actual scene data in Firebase Storage)
    // Used by: DxfFirestoreService, BuildingFloorplanService, FloorFloorplanService
    // =========================================================================
    match /cadFiles/{fileId} {

      // ğŸ“– READ: Any authenticated user (internal DXF storage)
      allow read: if request.auth != null;

      // âœï¸ CREATE/UPDATE: Authenticated users with basic validation
      // Note: Scene data is stored in Firebase Storage, not Firestore
      // This collection only contains metadata (fileName, storageUrl, etc.)
      allow create, update: if request.auth != null
                            && request.resource.data.keys().hasAll(['fileName'])
                            && request.resource.data.fileName is string
                            && request.resource.data.fileName.size() > 0;

      // ğŸ—‘ï¸ DELETE: Authenticated users
      allow delete: if request.auth != null;
    }

    // =========================================================================
    // ğŸ“ FILES COLLECTION - ENTERPRISE CANONICAL FILE STORAGE (ADR-031)
    // =========================================================================
    // This collection stores FileRecord metadata (Source of Truth for file uploads)
    // Binary files are stored in Firebase Storage, metadata in Firestore
    //
    // Flow:
    // 1. CREATE: Client creates pending record (status: pending)
    // 2. Storage Upload: Binary uploaded to canonical path (Storage rules verify FileRecord)
    // 3. UPDATE: Client finalizes record (status: ready)
    // =========================================================================
    match /files/{fileId} {

      // ğŸ“– READ: Users belonging to file's company (tenant isolation)
      // ğŸ¢ ENTERPRISE: Allow company members OR creator (for pending files during upload)
      // This enables both:
      // - Storage Rules to validate uploads via firestore.get() (pending files)
      // - Users to list/view ready files from their company
      allow read: if isAuthenticated()
                  && resource.data.keys().hasAny(['companyId'])
                  && (
                       // Company members can read all files from their company
                       belongsToCompany(resource.data.companyId)
                       // OR super_admin can read everything
                       || isSuperAdminOnly()
                     );

      // âœï¸ CREATE: Users can create pending FileRecord for their company
      // ğŸ” SECURITY: createdBy must match request.auth.uid
      // ğŸ” SECURITY: companyId must match user's company claim
      // ğŸ” SECURITY: status must be 'pending' (no direct 'ready' creation)
      allow create: if isAuthenticated()
                    && request.resource.data.createdBy == request.auth.uid
                    && request.resource.data.companyId == getUserCompanyId()
                    && request.resource.data.status == 'pending'
                    && resource == null; // Ensure document doesn't exist

      // ğŸ“ UPDATE: Only creator or company admin can finalize
      // ğŸ” SECURITY: Limited to specific fields for finalization
      // ğŸ” SECURITY: Can only transition pending â†’ ready (or â†’ failed)
      allow update: if isAuthenticated()
                    && resource.data.companyId == getUserCompanyId()
                    && (
                         // Creator can finalize
                         resource.data.createdBy == request.auth.uid
                         // OR company admin can finalize
                         || isCompanyAdminOfCompany(resource.data.companyId)
                       )
                    // Status transitions: pending â†’ ready OR pending â†’ failed
                    && (
                         (resource.data.status == 'pending' && request.resource.data.status == 'ready')
                         || (resource.data.status == 'pending' && request.resource.data.status == 'failed')
                       )
                    // Prevent modification of immutable fields
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.companyId == resource.data.companyId
                    && request.resource.data.createdBy == resource.data.createdBy
                    && request.resource.data.storagePath == resource.data.storagePath;

      // ğŸ—‘ï¸ MOVE TO TRASH: Creator or company admin can trash ready files
      // ğŸ¢ ENTERPRISE: Ownership Principle (SAP/Salesforce/Google Drive pattern)
      //    - Creator can ALWAYS manage their own files (no claims required)
      //    - Admins need proper company claims for cross-user operations
      // ğŸ” SECURITY: Only allows setting isDeleted flag, preserves all other immutable fields
      allow update: if isAuthenticated()
                    && (
                         // OWNERSHIP PRINCIPLE: Creator can ALWAYS trash their own files
                         resource.data.createdBy == request.auth.uid
                         // OR company admin can trash any file in their company (requires claims)
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         // OR super_admin can trash anything
                         || isSuperAdminOnly()
                       )
                    // Only for ready files (soft delete)
                    && resource.data.status == 'ready'
                    // Must be setting isDeleted to true
                    && request.resource.data.isDeleted == true
                    // Preserve immutable fields
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.companyId == resource.data.companyId
                    && request.resource.data.createdBy == resource.data.createdBy
                    && request.resource.data.storagePath == resource.data.storagePath
                    && request.resource.data.status == resource.data.status;

      // â™»ï¸ RESTORE FROM TRASH: Creator or company admin can restore trashed files
      // ğŸ¢ ENTERPRISE: Ownership Principle (SAP/Salesforce/Google Drive pattern)
      //    - Creator can ALWAYS restore their own files (no claims required)
      //    - Admins need proper company claims for cross-user operations
      // ğŸ“… Added: 2026-01-20 (ADR-032 - Enterprise Trash System)
      allow update: if isAuthenticated()
                    && (
                         // OWNERSHIP PRINCIPLE: Creator can ALWAYS restore their own files
                         resource.data.createdBy == request.auth.uid
                         // OR company admin can restore any file in their company (requires claims)
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         // OR super_admin can restore anything
                         || isSuperAdminOnly()
                       )
                    // Only for trashed files (isDeleted == true)
                    && resource.data.isDeleted == true
                    // Must be setting isDeleted to false (restoring)
                    && request.resource.data.isDeleted == false
                    // Preserve immutable fields
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.companyId == resource.data.companyId
                    && request.resource.data.createdBy == resource.data.createdBy
                    && request.resource.data.storagePath == resource.data.storagePath
                    && request.resource.data.status == resource.data.status;

      // ğŸ—‘ï¸ HARD DELETE: Only creator or company admin
      allow delete: if isAuthenticated()
                    && resource.data.companyId == getUserCompanyId()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                       );
    }

    // =========================================================================
    // ğŸ¢ COMPANIES COLLECTION - READ-ONLY FOR AUTHENTICATED
    // =========================================================================
    match /companies/{companyId} {

      // ğŸ“– READ: ÎœÏŒÎ½Î¿ authenticated users
      allow read: if request.auth != null;

      // âœï¸ CREATE/UPDATE/DELETE: ÎŒÎ§Î™ Î±Ï€ÏŒ client - Î¼ÏŒÎ½Î¿ admin/server
      allow write: if false;

      // =========================================================================
      // ğŸ“‹ AUDIT_LOGS SUBCOLLECTION - COMPANY-SCOPED AUDIT TRAIL
      // =========================================================================
      // ğŸ¢ ENTERPRISE: Audit logs for company operations (ADR-029 Global Search)
      // ğŸ“… Added: 2026-01-26
      // ğŸ”’ SECURITY: Only users from the same company can read/write audit logs
      match /audit_logs/{logId} {
        // ğŸ“– READ: Company members and super_admin
        allow read: if isAuthenticated()
                    && (belongsToCompany(companyId) || isSuperAdminOnly());

        // âœï¸ CREATE: Company members can create audit entries
        // ğŸ” SECURITY: Used by API routes for audit logging
        allow create: if isAuthenticated()
                      && belongsToCompany(companyId);

        // ğŸ“ UPDATE/DELETE: Not allowed - audit logs are immutable
        allow update, delete: if false;
      }
    }

    // =========================================================================
    // ğŸ  BUILDINGS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1A Critical Hotfix)
    // =========================================================================
    // ğŸ”’ SECURITY: Removed public read (was: `allow read: if true;`)
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1A)
    // ğŸ¢ ENTERPRISE: Follows /files pattern (lines 121-226)
    //
    // Security Model:
    //   - READ: Only users from the building's company (tenant-scoped)
    //   - WRITE: Admin/server only (via Firebase Admin SDK)
    // =========================================================================
    match /buildings/{buildingId} {

      // ğŸ“– READ: Tenant-scoped - only users from the building's company
      // ğŸ”’ SECURITY: Prevents cross-tenant data leak
      allow read: if isAuthenticated()
                  && (
                       // Super admin can read all buildings
                       isSuperAdminOnly()
                       // OR user belongs to the building's company (PRIMARY path)
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // LEGACY FALLBACK (TRANSITIONAL - STRICT):
                       // Buildings without companyId but with projectId - lookup via project
                       // âš ï¸ NOTE: Requires data migration - see docs/architecture-review/migration-companyId.md
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.keys().hasAny(['projectId'])
                           && resource.data.projectId is string
                           && belongsToProjectCompany(resource.data.projectId))
                     );

      // ğŸš« WRITE: Admin/server only (via Firebase Admin SDK)
      // ğŸ¢ ENTERPRISE: Building creation/modification requires admin privileges
      allow write: if false;
    }

    // =========================================================================
    // ğŸ¢ FLOORS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1D)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1D)
    // ğŸ¢ ENTERPRISE: Tenant-scoped via buildingâ†’company lookup
    //
    // Security Model:
    //   - READ: Only users from the building's company (tenant-scoped)
    //   - WRITE: Admin/server only (via Firebase Admin SDK)
    // =========================================================================
    match /floors/{floorId} {
      // ğŸ“– READ: Tenant-scoped via building lookup
      // ğŸ”’ SECURITY: Prevents cross-tenant data leak
      allow read: if isAuthenticated()
                  && (
                       // Super admin can read all
                       isSuperAdminOnly()
                       // OR user belongs to the building's company
                       || (resource.data.keys().hasAny(['buildingId'])
                           && resource.data.buildingId is string
                           && belongsToBuildingCompany(resource.data.buildingId))
                       // LEGACY FALLBACK: Creator-only for floors without buildingId
                       || (!resource.data.keys().hasAny(['buildingId'])
                           && resource.data.keys().hasAny(['createdBy'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // ğŸš« WRITE: Admin/server only
      allow write: if false;
    }

    // =========================================================================
    // ğŸ  UNITS COLLECTION - ENTERPRISE TENANT ISOLATION (2026-01-24)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Full tenant isolation via projectâ†’company lookup
    // ğŸ“‹ Security Model:
    //    - READ: Only users belonging to the project's company (tenant-scoped)
    //    - UPDATE: Company admins of project's company + field allowlist + invariants
    //    - CREATE/DELETE: Admin/server only (via Firebase Admin SDK)
    // ğŸ” Invariants: project, buildingId, floorId, name, id cannot be changed by client
    // ğŸ“… Implemented: 2026-01-24
    match /units/{unitId} {
      // ğŸ“– READ: Tenant-scoped - only users from the project's company
      // ğŸ”’ SECURITY: Prevents cross-tenant data leak
      allow read: if isAuthenticated()
                  && (
                       // Super admin can read all
                       isSuperAdminOnly()
                       // OR user belongs to the project's company
                       || belongsToProjectCompany(resource.data.project)
                     );

      // âœï¸ CREATE: Admin/server only
      allow create: if false;

      // ğŸ“ UPDATE: Company admin of project's company + field allowlist + invariants
      // ğŸ”’ SECURITY LAYERS:
      //    1. Role gate: Must be company_admin or super_admin
      //    2. Tenant gate: Must belong to project's company
      //    3. Field allowlist: Only unit fields can be updated (not structural fields)
      //    4. Invariants: Structural fields (project, buildingId, floorId, name, id) unchanged
      allow update: if isAuthenticated()
                    && (
                         // Super admin bypasses all checks
                         isSuperAdminOnly()
                         // OR company admin of project's company with allowlist + invariants
                         || (
                              isCompanyAdminOfProject(resource.data.project)
                              && isAllowedUnitFieldUpdate()
                              && unitStructuralFieldsUnchanged()
                            )
                       );

      // ğŸ—‘ï¸ DELETE: Admin/server only
      allow delete: if false;
    }

    // =========================================================================
    // ğŸ“¦ STORAGE_UNITS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1D)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1D)
    // ğŸ¢ ENTERPRISE: Storage units are a PARALLEL category to Units, not nested
    // Architecture: Building â†’ [Units | Storage | Parking] (parallel)
    //
    // Security Model:
    //   - READ: Only users from the building's company (tenant-scoped)
    //   - WRITE: Admin/server only (via Firebase Admin SDK)
    // =========================================================================
    match /storage_units/{storageId} {
      // ğŸ“– READ: Tenant-scoped via building lookup
      // ğŸ”’ SECURITY: Prevents cross-tenant data leak
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['buildingId'])
                           && resource.data.buildingId is string
                           && belongsToBuildingCompany(resource.data.buildingId))
                       // LEGACY FALLBACK: Creator-only
                       || (!resource.data.keys().hasAny(['buildingId'])
                           && resource.data.keys().hasAny(['createdBy'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // ğŸš« WRITE: Admin/server only
      allow write: if false;
    }

    // =========================================================================
    // ğŸš— PARKING_SPOTS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1D)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1D)
    // ğŸ¢ ENTERPRISE: Parking spaces are a PARALLEL category to Units, not nested
    // Architecture: Building â†’ [Units | Storage | Parking] (parallel)
    // ğŸ“ Collection name: parking_spots (Î¼Îµ underscore - ÏŒÏ€Ï‰Ï‚ ÏƒÏ„Î· Firestore)
    //
    // Security Model:
    //   - READ: Only users from the building's company (tenant-scoped)
    //   - WRITE: Admin/server only (via Firebase Admin SDK)
    // =========================================================================
    match /parking_spots/{parkingId} {
      // ğŸ“– READ: Tenant-scoped via building lookup
      // ğŸ”’ SECURITY: Prevents cross-tenant data leak
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['buildingId'])
                           && resource.data.buildingId is string
                           && belongsToBuildingCompany(resource.data.buildingId))
                       // LEGACY FALLBACK: Creator-only
                       || (!resource.data.keys().hasAny(['buildingId'])
                           && resource.data.keys().hasAny(['createdBy'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // ğŸš« WRITE: Admin/server only
      allow write: if false;
    }

    // =========================================================================
    // ğŸ§­ NAVIGATION_COMPANIES COLLECTION - DEV-FRIENDLY READ ACCESS
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Î•Ï„Î±Î¹ÏÎµÎ¯ÎµÏ‚ Ï€Î¿Ï… ÎµÎ¼Ï†Î±Î½Î¯Î¶Î¿Î½Ï„Î±Î¹ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î± ÏƒÏ„Î·Î½ Ï€Î»Î¿Î®Î³Î·ÏƒÎ·
    // Î ÎµÏÎ¹Î­Ï‡ÎµÎ¹ contactIds Ï€Î¿Ï… Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡Î¿ÏÎ½ ÏƒÎµ ÎµÏ„Î±Î¹ÏÎµÎ¯ÎµÏ‚ ÏƒÏ„Î· contacts collection
    match /navigation_companies/{navCompanyId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸ”” NOTIFICATIONS COLLECTION - USER-SCOPED ACCESS
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Secure notification access per user
    // ğŸ”’ AUTHENTICATED: User can only access their own notifications
    // ğŸ“‹ ADR-027: CRM Notifications Integration - Updated 2026-01-13
    // âš ï¸ NOTE: For list queries, the userId filter must be in the query itself
    //          (where userId == auth.uid). Rules validate single doc reads.
    match /notifications/{notificationId} {
      // ğŸ“– READ: Authenticated users can read notifications
      // Query MUST include: where('userId', '==', currentUserId) for security
      // Single doc reads verify ownership
      allow read: if isAuthenticated()
                  && (resource == null || resource.data.userId == request.auth.uid);

      // ğŸ“ UPDATE: Users can mark their own notifications as read
      // Only allows updating delivery state and seen timestamp
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && isValidNotificationUpdate(request.resource.data, resource.data);

      // âœ… CREATE: Authenticated users can create notifications for themselves
      // ğŸ¢ ENTERPRISE: In production, this should be server-only
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;

      // ğŸ—‘ï¸ DELETE: Users can delete their own notifications
      // ğŸ¢ ENTERPRISE: Allows cleanup of test notifications
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }

    // =========================================================================
    // âœ… TASKS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1B)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Task management Î³Î¹Î± CRM leads, projects, ÎºÎ±Î¹ users
    // ğŸ”’ SECURITY: Tenant-scoped via companyId field
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1B)
    // ğŸ“‹ ADR-026: CRM Tasks Backend Fix - Added 2026-01-13
    //
    // Security Model:
    //   - READ: Only users from the task's company + assignedTo
    //   - CREATE: companyId must match user's company claim
    //   - UPDATE: Creator, assignedTo, or company admin
    //   - DELETE: Creator or company admin
    // =========================================================================
    match /tasks/{taskId} {

      // ğŸ“– READ: Tenant-scoped + assignee access
      // ğŸ”’ SECURITY: Prevents cross-tenant data leak
      allow read: if isAuthenticated()
                  && (
                       // Super admin can read all tasks
                       isSuperAdminOnly()
                       // OR user belongs to the task's company
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // OR user is assigned to this task
                       || (resource.data.keys().hasAny(['assignedTo'])
                           && resource.data.assignedTo == request.auth.uid)
                       // LEGACY FALLBACK: Tasks without companyId - assignee or creator only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && (resource.data.assignedTo == request.auth.uid
                               || resource.data.createdBy == request.auth.uid))
                     );

      // âœï¸ CREATE: Authenticated users with companyId from claims
      // ğŸ” SECURITY: companyId MUST match user's company claim
      allow create: if isAuthenticated()
                    && isValidTaskData(request.resource.data)
                    && request.resource.data.companyId == getUserCompanyId()
                    && resource == null;

      // ğŸ“ UPDATE: Creator, assignee, or company admin
      allow update: if isAuthenticated()
                    && isValidTaskData(request.resource.data)
                    && resource != null
                    && (
                         // Creator can update
                         resource.data.createdBy == request.auth.uid
                         // OR assignee can update
                         || resource.data.assignedTo == request.auth.uid
                         // OR company admin
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         // OR super admin
                         || isSuperAdminOnly()
                       )
                    // Prevent changing companyId
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ“ PROJECT_FLOORPLANS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1C)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Floorplans for projects with tenant isolation
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1C)
    // âš ï¸ NOTE: Requires companyId migration - derive from projectId
    match /project_floorplans/{floorplanId} {
      // ğŸ“– READ: Tenant-scoped via companyId or projectId lookup
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Fallback via projectId lookup
                       || (resource.data.keys().hasAny(['projectId'])
                           && resource.data.projectId is string
                           && belongsToProjectCompany(resource.data.projectId))
                       // Legacy: creator-only
                       || (!resource.data.keys().hasAny(['companyId', 'projectId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ“ BUILDING_FLOORPLANS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1C)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1C)
    match /building_floorplans/{floorplanId} {
      // ğŸ“– READ: Tenant-scoped via companyId or buildingId lookup
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Legacy: creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ“ FLOOR_FLOORPLANS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1C)
    // =========================================================================
    // ğŸ“… Added: 2026-02-01 (Floor-level floorplan storage)
    // ğŸ¢ ENTERPRISE: Floor-level floorplans with tenant isolation
    match /floor_floorplans/{floorplanId} {
      // ğŸ“– READ: Tenant-scoped via companyId or buildingId lookup
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Legacy: creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                       // Fallback: Any authenticated user (development)
                       || !resource.data.keys().hasAny(['companyId', 'createdBy'])
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ“ UNIT_FLOORPLANS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1C)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1C)
    match /unit_floorplans/{floorplanId} {
      // ğŸ“– READ: Tenant-scoped via companyId
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Legacy: creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸšï¸ DXF-VIEWER-LEVELS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1C)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Levels for DXF viewer layer management with tenant isolation
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1C)
    match /dxf-viewer-levels/{levelId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Legacy: creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ¨ DXF OVERLAY LEVELS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1C)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Overlay levels for DXF viewer with tenant isolation
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1C)
    // âš ï¸ BOTH naming conventions supported for backwards compatibility

    // Kebab-case version (used by overlay-store.tsx)
    match /dxf-overlay-levels/{levelId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );

      // ğŸ“ Items subcollection - inherits parent tenant isolation
      match /items/{itemId} {
        allow read: if isAuthenticated()
                    && (
                         isSuperAdminOnly()
                         || belongsToCompany(get(/databases/$(database)/documents/dxf-overlay-levels/$(levelId)).data.companyId)
                       );
        allow create: if isAuthenticated()
                      && request.resource.data.companyId == getUserCompanyId();
        allow update, delete: if isAuthenticated()
                              && (
                                   resource.data.createdBy == request.auth.uid
                                   || isCompanyAdminOfCompany(resource.data.companyId)
                                   || isSuperAdminOnly()
                                 );
      }
    }

    // CamelCase version (legacy support)
    match /dxfOverlayLevels/{levelId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );

      // ğŸ“ Items subcollection - inherits parent tenant isolation
      match /items/{itemId} {
        allow read: if isAuthenticated()
                    && (
                         isSuperAdminOnly()
                         || belongsToCompany(get(/databases/$(database)/documents/dxfOverlayLevels/$(levelId)).data.companyId)
                       );
        allow create: if isAuthenticated()
                      && request.resource.data.companyId == getUserCompanyId();
        allow update, delete: if isAuthenticated()
                              && (
                                   resource.data.createdBy == request.auth.uid
                                   || isCompanyAdminOfCompany(resource.data.companyId)
                                   || isSuperAdminOnly()
                                 );
      }
    }

    // =========================================================================
    // ğŸ¨ LAYERS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1C)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Legacy layers for property visualization with tenant isolation
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1C)
    match /layers/{layerId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ“‹ LAYER EVENTS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1C)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Events for layer synchronization with tenant isolation
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1C)
    match /layer-events/{eventId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ  PROPERTY LAYERS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1C)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Property-specific layers with tenant isolation
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1C)
    match /property-layers/{layerId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ” SECURITY_ROLES COLLECTION - ÎšÎ¡Î™Î£Î™ÎœÎŸ Î“Î™Î‘ LOGIN!
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Role-based access control Î³Î¹Î± EnterpriseSecurityService
    match /security_roles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸ‘¤ USERS COLLECTION & SESSIONS SUBCOLLECTION
    // =========================================================================
    // ğŸ¢ ENTERPRISE: User profile ÎºÎ±Î¹ active sessions management
    // ğŸ”’ OWNERSHIP-BASED: ÎšÎ¬Î¸Îµ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï…
    match /users/{userId} {
      // ğŸ“– READ/WRITE: ÎœÏŒÎ½Î¿ Î¿ Î¯Î´Î¹Î¿Ï‚ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚
      allow read, write: if isOwner(userId);

      // ğŸ” SESSIONS SUBCOLLECTION - Enterprise Active Sessions Management
      match /sessions/{sessionId} {
        // ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î³ÏÎ¬Ï†ÎµÎ¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï… sessions
        allow read, write: if isOwner(userId);
      }
    }

    // =========================================================================
    // ğŸ” USER_2FA_SETTINGS COLLECTION - Two-Factor Authentication
    // =========================================================================
    // ğŸ¢ ENTERPRISE: 2FA settings ÎºÎ±Î¹ backup codes storage
    // ğŸ”’ OWNERSHIP-BASED: ÎšÎ¬Î¸Îµ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï… 2FA settings
    match /user_2fa_settings/{userId} {
      // ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î³ÏÎ¬Ï†ÎµÎ¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï… 2FA settings
      allow read, write: if isOwner(userId);
    }

    // =========================================================================
    // ğŸ”” USER_NOTIFICATION_SETTINGS COLLECTION - Notification Preferences
    // =========================================================================
    // ğŸ¢ ENTERPRISE: User notification preferences management
    // ğŸ”’ OWNERSHIP-BASED: ÎšÎ¬Î¸Îµ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Ï„Î¹Ï‚ Î´Î¹ÎºÎ­Ï‚ Ï„Î¿Ï… ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚
    match /user_notification_settings/{userId} {
      // ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î³ÏÎ¬Ï†ÎµÎ¹ ÎœÎŸÎÎŸ Ï„Î¹Ï‚ Î´Î¹ÎºÎ­Ï‚ Ï„Î¿Ï… ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ‰Î½
      allow read, write: if isOwner(userId);
    }

    // =========================================================================
    // ğŸ¢ WORKSPACES COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1B)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1B)
    // ğŸ¢ ENTERPRISE: Workspaces are company-scoped
    match /workspaces/{workspaceId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Legacy fallback: all authenticated until migration
                       // âš ï¸ NOTE: Remove after companyId migration
                       || !resource.data.keys().hasAny(['companyId'])
                     );

      // âœï¸ WRITE: Admin/server only (via Firebase Admin SDK)
      allow write: if false;
    }

    // =========================================================================
    // ğŸ“ CONTACTS COLLECTION - ENTERPRISE TENANT ISOLATION (ADR-029)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Multi-tenant security via companyId field
    // ğŸ“… Updated: 2026-01-26 (Global Search v1 - Tenant Isolation Fix)
    //
    // Security Model:
    //   - READ: Only users from the same company (tenant-scoped)
    //   - CREATE: Authenticated users, companyId auto-set from claims
    //   - UPDATE: Creator or company admin
    //   - DELETE: Creator or company admin
    // =========================================================================
    match /contacts/{contactId} {

      // ğŸ“– READ: Tenant-scoped - only users from the contact's company
      // ğŸ”’ SECURITY: Prevents cross-tenant data leak
      // ğŸ¢ ENTERPRISE: Follows SAP/Salesforce/Microsoft multi-tenant patterns
      allow read: if isAuthenticated()
                  && (
                       // Super admin can read all contacts
                       isSuperAdminOnly()
                       // OR user belongs to the contact's company
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // LEGACY FALLBACK: Contacts without companyId readable by creator only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: Authenticated users with companyId from claims
      // ğŸ” SECURITY: companyId MUST match user's company claim (no cross-tenant creation)
      allow create: if isAuthenticated()
                    && isValidContactData(request.resource.data)
                    && request.resource.data.companyId == getUserCompanyId()
                    && resource == null;

      // ğŸ“ UPDATE: Creator or company admin of contact's company
      // ğŸ”’ SECURITY: Prevents cross-tenant modification
      allow update: if isAuthenticated()
                    && isValidContactData(request.resource.data)
                    && (
                         // Creator can always update their contacts
                         resource.data.createdBy == request.auth.uid
                         // OR company admin can update contacts in their company
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         // OR super admin can update any contact
                         || isSuperAdminOnly()
                       )
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data)
                    // Prevent changing companyId (no re-tenanting)
                    && request.resource.data.companyId == resource.data.companyId;

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );

      // =====================================================================
      // ğŸ¦ BANK ACCOUNTS SUBCOLLECTION - INHERITS PARENT TENANT ISOLATION
      // =====================================================================
      // ğŸ¢ ENTERPRISE: Bank accounts for contacts (2026-02-01)
      // ğŸ“ Path: contacts/{contactId}/bankAccounts/{accountId}
      // ğŸ”’ SECURITY: Inherits access from parent contact document
      // =====================================================================
      match /bankAccounts/{accountId} {

        // Helper: Check if user can access parent contact
        function canAccessParentContact() {
          let parentContact = get(/databases/$(database)/documents/contacts/$(contactId)).data;
          return isAuthenticated()
                 && (
                      isSuperAdminOnly()
                      || (parentContact.keys().hasAny(['companyId'])
                          && belongsToCompany(parentContact.companyId))
                      || (!parentContact.keys().hasAny(['companyId'])
                          && parentContact.createdBy == request.auth.uid)
                    );
        }

        // ğŸ“– READ: Same access as parent contact
        allow read: if canAccessParentContact();

        // âœï¸ CREATE: Users who can access parent contact
        allow create: if canAccessParentContact()
                      && request.resource.data.keys().hasAll(['bankName', 'iban', 'accountType', 'currency', 'isPrimary', 'isActive'])
                      && request.resource.data.iban is string
                      && request.resource.data.iban.size() >= 15;

        // ğŸ“ UPDATE: Users who can access parent contact
        allow update: if canAccessParentContact()
                      && request.resource.data.keys().hasAll(['bankName', 'iban', 'accountType', 'currency', 'isPrimary', 'isActive']);

        // ğŸ—‘ï¸ DELETE: Users who can access parent contact
        allow delete: if canAccessParentContact();
      }
    }

    // =========================================================================
    // =========================================================================
    // ğŸ’¬ COMMUNICATIONS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1B)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Legacy CRM communications with tenant isolation
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1B)
    // âš ï¸ NOTE: Requires companyId migration for legacy docs
    match /communications/{communicationId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Legacy fallback: creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // âš™ï¸ SYSTEM COLLECTION - SYSTEM CONFIGURATION
    // =========================================================================
    // ğŸ¢ ENTERPRISE: System-wide configuration and templates
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /system/{docId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin/server only

      // ğŸ“ Subcollections (e.g., project-templates)
      match /{subcollection}/{subDocId} {
        allow read: if isAuthenticated();
        allow write: if false; // Admin/server only
      }
    }

    // =========================================================================
    // âš™ï¸ CONFIG COLLECTION - APPLICATION CONFIGURATION
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Application configuration
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /config/{configId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸ¯ LEADS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1B)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: CRM lead management with tenant isolation
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1B)
    match /leads/{leadId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Legacy fallback: creator or assignee
                       || (!resource.data.keys().hasAny(['companyId'])
                           && (resource.data.createdBy == request.auth.uid
                               || resource.data.assignedTo == request.auth.uid))
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator, assignee, or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || resource.data.assignedTo == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ’¼ OPPORTUNITIES COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1B)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: CRM opportunity management with tenant isolation
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1B)
    match /opportunities/{opportunityId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Legacy fallback: creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ“‹ ACTIVITIES COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1B)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: CRM activity tracking with tenant isolation
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1B)
    match /activities/{activityId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Legacy fallback: creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ’¬ CONVERSATIONS - ENTERPRISE TENANT ISOLATION (PR-1B)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Telegram/email conversations Î³Î¹Î± CRM with tenant isolation
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1B)
    // âš ï¸ NOTE: Requires companyId migration for legacy docs
    match /conversations/{conversationId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Legacy fallback: creator or participant
                       || (!resource.data.keys().hasAny(['companyId'])
                           && (resource.data.createdBy == request.auth.uid
                               || resource.data.assignedTo == request.auth.uid))
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && isValidConversationData(request.resource.data)
                    && request.resource.data.companyId == getUserCompanyId()
                    && resource == null;

      // ğŸ“ UPDATE: Creator, assignee, or company admin
      allow update: if isAuthenticated()
                    && isValidConversationData(request.resource.data)
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || resource.data.assignedTo == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ’¬ MESSAGES - ENTERPRISE TENANT ISOLATION (PR-1B)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Messages stored in ROOT collection with tenant isolation
    // Architecture: messages/{messageId} with conversationId field
    // ğŸ“‹ REAL-TIME UPDATES: Supports Firestore onSnapshot Î³Î¹Î± instant message updates
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1B)
    match /messages/{messageId} {
      // ğŸ“– READ: Tenant-scoped via companyId or conversation lookup
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Legacy fallback: sender only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.senderId == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && isValidMessageData(request.resource.data)
                    && request.resource.data.companyId == getUserCompanyId()
                    && resource == null;

      // ğŸ“ UPDATE: Sender or company admin
      allow update: if isAuthenticated()
                    && isValidMessageData(request.resource.data)
                    && resource != null
                    && (
                         resource.data.senderId == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Sender or company admin
      allow delete: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.senderId == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ” EXTERNAL IDENTITIES - ENTERPRISE TENANT ISOLATION (PR-1B)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1B)
    // ğŸ¢ ENTERPRISE: Maps external platform IDs (Telegram chatId) to internal contacts
    // âš ï¸ NOTE: Requires companyId migration for legacy docs
    match /external_identities/{identityId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Legacy fallback: creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId()
                    && resource == null;

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // âš™ï¸ CONFIG - ENTERPRISE SERVICE CONFIGURATIONS
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - CRITICAL collection)
    // ğŸ¢ ENTERPRISE: System-wide configuration (channels, integrations, etc.)
    match /config/{configId} {
      // ğŸ“– READ: Authenticated users (app needs config)
      allow read: if isAuthenticated();

      // âœï¸ CREATE/UPDATE/DELETE: Only admin users
      allow create, update, delete: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ”— RELATIONSHIPS - ENTERPRISE TENANT ISOLATION (PR-1B)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1B)
    // ğŸ¢ ENTERPRISE: General-purpose relationships between entities with tenant isolation
    // âš ï¸ Note: contact_relationships has separate, more strict rules above
    match /relationships/{relationshipId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Legacy fallback: creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId()
                    && resource == null;

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ” SECURITY POLICIES - EMAIL DOMAIN & COUNTRY RESTRICTIONS
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - CRITICAL collection)
    // ğŸ¢ ENTERPRISE: EnterpriseSecurityService policy collections (READ-ONLY for clients)
    match /email_domain_policies/{policyId} {
      // ğŸ“– READ: Authenticated users (security validation needs this)
      allow read: if isAuthenticated();
      // ğŸš« WRITE: Server-side only (via Admin SDK)
      allow write: if false;
    }

    match /country_security_policies/{policyId} {
      // ğŸ“– READ: Authenticated users (security validation needs this)
      allow read: if isAuthenticated();
      // ğŸš« WRITE: Server-side only (via Admin SDK)
      allow write: if false;
    }

    // =========================================================================
    // ğŸ”¢ COUNTERS - PROJECT CODE GENERATION
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - HIGH priority)
    // ğŸ¢ ENTERPRISE: Auto-increment counters for project codes, etc.
    match /counters/{counterId} {
      // ğŸ“– READ: Authenticated users (need to read current counter)
      allow read: if isAuthenticated();
      // âœï¸ WRITE: Authenticated users (increment on create)
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ“Š ANALYTICS - ENTERPRISE TENANT ISOLATION (PR-1B)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1B)
    // ğŸ¢ ENTERPRISE: SendGrid webhook analytics with tenant isolation
    match /analytics/{analyticsId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // Legacy fallback: creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ“‹ OBLIGATIONS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1D)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1D)
    // ğŸ¢ ENTERPRISE: Obligations with tenant isolation via project lookup
    //
    // Security Model:
    //   - READ: Tenant-scoped via projectIdâ†’company or companyId
    //   - CREATE: companyId required from claims
    //   - UPDATE: Creator or company admin, companyId immutable
    //   - DELETE: Creator or company admin
    // =========================================================================
    match /obligations/{obligationId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       // Direct companyId check
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // OR via projectId lookup
                       || (resource.data.keys().hasAny(['projectId'])
                           && resource.data.projectId is string
                           && belongsToProjectCompany(resource.data.projectId))
                       // LEGACY FALLBACK: Creator-only
                       || (!resource.data.keys().hasAny(['companyId', 'projectId'])
                           && resource.data.keys().hasAny(['createdBy'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && resource == null
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin, companyId immutable
      allow update: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ“‹ OBLIGATION_TEMPLATES COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1D)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1D)
    // ğŸ¢ ENTERPRISE: Templates are company-scoped
    // =========================================================================
    match /obligationTemplates/{templateId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // LEGACY FALLBACK: Creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.keys().hasAny(['createdBy'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && resource == null
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin, companyId immutable
      allow update: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ“‹ OBLIGATION-SECTIONS COLLECTION - ENTERPRISE TENANT ISOLATION (PR-1D)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1D)
    // ğŸ¢ ENTERPRISE: Sections are company-scoped (linked to templates)
    // =========================================================================
    match /obligation-sections/{sectionId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // LEGACY FALLBACK: Creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.keys().hasAny(['createdBy'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && resource == null
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin, companyId immutable
      allow update: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ’¼ OPPORTUNITIES - ENTERPRISE TENANT ISOLATION (PR-1D FIX)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1D)
    // ğŸ¢ ENTERPRISE: CRM sales pipeline with tenant isolation
    // =========================================================================
    match /opportunities/{opportunityId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // LEGACY FALLBACK: Creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.keys().hasAny(['createdBy'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && resource == null
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin, companyId immutable
      allow update: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ‘¥ LEADS - ENTERPRISE TENANT ISOLATION (PR-1D FIX)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1D)
    // ğŸ¢ ENTERPRISE: CRM lead management with tenant isolation
    // =========================================================================
    match /leads/{leadId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // LEGACY FALLBACK: Creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.keys().hasAny(['createdBy'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && resource == null
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin, companyId immutable
      allow update: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ“† ACTIVITIES - ENTERPRISE TENANT ISOLATION (PR-1D FIX)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1D)
    // ğŸ¢ ENTERPRISE: CRM activity tracking with tenant isolation
    // =========================================================================
    match /activities/{activityId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // LEGACY FALLBACK: Creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.keys().hasAny(['createdBy'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && resource == null
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin, companyId immutable
      allow update: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && resource != null
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ¤– BOT_CONFIGS - TELEGRAM BOT CONFIGURATIONS
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - MEDIUM priority)
    match /bot_configs/{configId} {
      allow read: if isAuthenticated();
      // ğŸš« WRITE: Server-side only (sensitive bot tokens)
      allow write: if false;
    }

    // =========================================================================
    // ğŸ—‚ï¸ LAYER GROUPS - ENTERPRISE TENANT ISOLATION (PR-1C)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1C)
    // ğŸ¢ ENTERPRISE: DXF layer management with tenant isolation
    match /layerGroups/{groupId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ—ºï¸ FLOORPLANS - ENTERPRISE TENANT ISOLATION (PR-1C)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1C)
    // ğŸ¢ ENTERPRISE: Floor plan storage with tenant isolation
    match /floorplans/{floorplanId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ“ AUDIT COLLECTIONS - SECURITY & COMPLIANCE
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - HIGH priority)
    // ğŸ¢ ENTERPRISE: Audit logs are READ-ONLY for clients (write via Admin SDK)
    match /relationship_audit/{auditId} {
      allow read: if isAuthenticated();
      allow write: if false; // Server-side only
    }

    // =========================================================================
    // ğŸ¢ ADMIN_BUILDING_TEMPLATES - ENTERPRISE TENANT ISOLATION (PR-1D)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1D)
    // ğŸ¢ ENTERPRISE: Building templates with tenant isolation
    // =========================================================================
    match /admin_building_templates/{templateId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // LEGACY FALLBACK: Creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.keys().hasAny(['createdBy'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin, companyId immutable
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    match /audit_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if false; // Server-side only
    }

    match /system_audit_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if false; // Server-side only
    }

    // =========================================================================
    // ğŸ“‹ AUDIT_LOG COLLECTION - CLOUD FUNCTIONS AUDIT TRAIL
    // =========================================================================
    // ğŸ“… Added: 2026-01-20 (ADR-032 - Enterprise Trash System)
    // ğŸ¢ ENTERPRISE: Audit log for file purge operations (written by Cloud Functions)
    // ğŸ”’ READ: Only super_admin can read audit logs
    // ğŸš« WRITE: Server-side only (via Firebase Admin SDK)
    match /audit_log/{logId} {
      allow read: if isSuperAdminOnly();
      allow write: if false; // Server-side only (Cloud Functions use Admin SDK)
    }

    // =========================================================================
    // ğŸ‘¥ TEAMS - ENTERPRISE TENANT ISOLATION (PR-1D)
    // =========================================================================
    // ğŸ“… Updated: 2026-01-29 (Security Gate Phase 1 - PR-1D)
    // ğŸ¢ ENTERPRISE: Team management with tenant isolation
    // =========================================================================
    match /teams/{teamId} {
      // ğŸ“– READ: Tenant-scoped
      allow read: if isAuthenticated()
                  && (
                       isSuperAdminOnly()
                       || (resource.data.keys().hasAny(['companyId'])
                           && belongsToCompany(resource.data.companyId))
                       // LEGACY FALLBACK: Creator-only
                       || (!resource.data.keys().hasAny(['companyId'])
                           && resource.data.keys().hasAny(['createdBy'])
                           && resource.data.createdBy == request.auth.uid)
                     );

      // âœï¸ CREATE: companyId required
      allow create: if isAuthenticated()
                    && request.resource.data.companyId == getUserCompanyId();

      // ğŸ“ UPDATE: Creator or company admin, companyId immutable
      allow update: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       )
                    && (!resource.data.keys().hasAny(['companyId'])
                        || request.resource.data.companyId == resource.data.companyId);

      // ğŸ—‘ï¸ DELETE: Creator or company admin
      allow delete: if isAuthenticated()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         || isSuperAdminOnly()
                       );
    }

    // =========================================================================
    // ğŸ’¼ POSITIONS - ROLE/POSITION MANAGEMENT
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Final 2 collections fix)
    // ğŸ¢ ENTERPRISE: Position management (fallback for COLLECTIONS.ROLES)
    match /positions/{positionId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // âš™ï¸ SYSTEM - SYSTEM CONFIGURATION
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - MEDIUM priority)
    // Note: Already had partial rules, adding subcollection support
    match /system/{docId} {
      allow read: if isAuthenticated();
      allow write: if false; // Server-side only

      // Subcollections (e.g., system/config/channels)
      match /{subcollection}/{subDocId} {
        allow read: if isAuthenticated();
        allow write: if false; // Server-side only
      }
    }

    // =========================================================================
    // ğŸ” SEARCH_DOCUMENTS COLLECTION - GLOBAL SEARCH INDEX (ADR-029)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Denormalized search index with tenant isolation
    // ğŸ“… Added: 2026-01-26 (Global Search v1)
    //
    // Architecture:
    //   - Documents indexed by Cloud Functions triggers
    //   - Tenant-scoped reads via tenantId field
    //   - Write-only for server (Admin SDK)
    // =========================================================================
    match /searchDocuments/{searchDocId} {

      // ğŸ“– READ: Tenant-scoped - only users from the same company
      // ğŸ”’ SECURITY: Search results filtered by tenantId
      allow read: if isAuthenticated()
                  && (
                       // Super admin can search all
                       isSuperAdminOnly()
                       // OR user belongs to the document's tenant
                       || belongsToCompany(resource.data.tenantId)
                     );

      // ğŸš« WRITE: Server-side only (Cloud Functions / Admin SDK)
      // Search index is maintained by triggers, not client writes
      allow create, update, delete: if false;
    }

    // =========================================================================
    // ğŸ”’ HELPER FUNCTIONS - VALIDATION & SECURITY
    // =========================================================================

    // Project Data Validation
    function isValidProjectData(data) {
      return data.keys().hasAll(['name', 'status', 'company'])
             && data.name is string && data.name.size() > 0
             && data.status in ['planning', 'in_progress', 'completed', 'on_hold', 'cancelled']
             && data.company is string && data.company.size() > 0;
    }

    // Relationship Data Validation
    function isValidRelationshipData(data) {
      return data.keys().hasAll(['sourceContactId', 'targetContactId', 'relationshipType', 'status'])
             && data.sourceContactId is string && data.sourceContactId.size() > 0
             && data.targetContactId is string && data.targetContactId.size() > 0
             && data.relationshipType in ['employee', 'manager', 'partner', 'client', 'vendor']
             && data.status in ['active', 'inactive', 'pending', 'deleted'];
    }

    // ğŸ¨ Enterprise CAD File Data Validation (Firebase Storage + Metadata Only)
    function isValidCadFileData(data) {
      return data.keys().hasAll(['fileName'])
             && data.fileName is string && data.fileName.size() > 0
             // ğŸš¨ ÎšÎ¡Î™Î£Î™ÎœÎŸ: Î”Î•Î ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î¼Îµ scene object ÏƒÏ„Î¿ Firestore! (ÎœÏ€Î±ÎºÎ¬Î»Î¹ÎºÎ¿ Î³ÎµÎ¹Ï„Î¿Î½Î¹Î¬Ï‚)
             && !data.keys().hasAny(['scene'])
             // âœ… ENTERPRISE: Firebase Storage-based validation
             && (
               // Legacy format (Firestore-based data)
               !data.keys().hasAny(['storageUrl']) ||
               // ğŸ¢ ENTERPRISE FORMAT: Firebase Storage Î¼Îµ metadata
               (data.keys().hasAll(['storageUrl'])
                && data.storageUrl is string
                && data.storageUrl.size() > 0
                // âœ… Validate Firebase Storage URL format
                && data.storageUrl.matches('https://firebasestorage.googleapis.com/.*'))
             )
             // âœ… Enterprise metadata validation
             && (!data.keys().hasAny(['version']) || (data.version is number && data.version > 0))
             && (!data.keys().hasAny(['sizeBytes']) || (data.sizeBytes is number && data.sizeBytes > 0))
             && (!data.keys().hasAny(['entityCount']) || (data.entityCount is number && data.entityCount >= 0))
             && (!data.keys().hasAny(['checksum']) || (data.checksum is string && data.checksum.size() > 0));
    }

    // Contact Data Validation
    // ğŸ¢ ENTERPRISE: Updated for tenant isolation (ADR-029)
    // companyId is required for new contacts (tenant isolation)
    function isValidContactData(data) {
      return data.keys().hasAll(['companyId'])
             && data.companyId is string
             && data.companyId.size() > 0
             // Email validation (if present)
             && (!data.keys().hasAny(['email']) || (data.email is string && data.email.matches('.*@.*\\..*')))
             // Type validation (if present)
             && (!data.keys().hasAny(['type']) || data.type in ['individual', 'company', 'service'])
             // Status validation (if present)
             && (!data.keys().hasAny(['status']) || data.status in ['active', 'inactive', 'archived']);
    }

    // âœ… Task Data Validation (ADR-026: CRM Tasks Backend Fix)
    // ğŸ¢ ENTERPRISE: Validates CrmTask structure for Firestore operations
    function isValidTaskData(data) {
      return data.keys().hasAll(['title', 'type', 'assignedTo', 'status', 'priority'])
             // ğŸ“ Title validation
             && data.title is string && data.title.size() > 0
             // ğŸ“‹ Type validation (enum)
             && data.type in ['call', 'email', 'meeting', 'viewing', 'document', 'follow_up', 'other']
             // ğŸ‘¤ AssignedTo validation (User ID)
             && data.assignedTo is string && data.assignedTo.size() > 0
             // ğŸ“Š Status validation (enum)
             && data.status in ['pending', 'in_progress', 'completed', 'cancelled']
             // âš¡ Priority validation (enum)
             && data.priority in ['low', 'medium', 'high', 'urgent']
             // ğŸ”— Optional leadId validation
             && (!data.keys().hasAny(['leadId']) || (data.leadId is string))
             // ğŸ”— Optional contactId validation
             && (!data.keys().hasAny(['contactId']) || (data.contactId is string))
             // ğŸ”— Optional projectId validation
             && (!data.keys().hasAny(['projectId']) || (data.projectId is string))
             // ğŸ“ Optional description validation
             && (!data.keys().hasAny(['description']) || (data.description is string));
    }

    // =========================================================================
    // ğŸ’¬ CONVERSATION & MESSAGE DATA VALIDATION
    // =========================================================================
    // ğŸ“‹ CRM Communications - Added 2026-01-15
    // ğŸ¢ ENTERPRISE: Validates Conversation and Message structures for Firestore operations

    // Conversation Data Validation
    function isValidConversationData(data) {
      return data.keys().hasAll(['channel', 'status'])
             // ğŸ“¡ Channel validation (enum: telegram | email | whatsapp | sms)
             && data.channel in ['telegram', 'email', 'whatsapp', 'sms']
             // ğŸ“Š Status validation (enum)
             && data.status in ['active', 'archived', 'closed', 'spam']
             // ğŸ”¢ Optional messageCount validation
             && (!data.keys().hasAny(['messageCount']) || (data.messageCount is int && data.messageCount >= 0))
             // ğŸ”” Optional unreadCount validation
             && (!data.keys().hasAny(['unreadCount']) || (data.unreadCount is int && data.unreadCount >= 0))
             // ğŸ‘¤ Optional assignedTo validation
             && (!data.keys().hasAny(['assignedTo']) || (data.assignedTo == null || data.assignedTo is string));
    }

    // Message Data Validation
    function isValidMessageData(data) {
      return data.keys().hasAll(['conversationId', 'direction', 'channel', 'content'])
             // ğŸ”— ConversationId validation
             && data.conversationId is string && data.conversationId.size() > 0
             // â†”ï¸ Direction validation (enum: inbound | outbound)
             && data.direction in ['inbound', 'outbound']
             // ğŸ“¡ Channel validation (enum)
             && data.channel in ['telegram', 'email', 'whatsapp', 'sms']
             // ğŸ“ Content validation (must have text field)
             && data.content is map
             && data.content.keys().hasAll(['text'])
             && data.content.text is string
             // ğŸ‘¤ Optional sender fields validation
             && (!data.keys().hasAny(['senderId']) || (data.senderId is string))
             && (!data.keys().hasAny(['senderName']) || (data.senderName is string))
             // ğŸ“Š Optional deliveryStatus validation
             && (!data.keys().hasAny(['deliveryStatus'])
                 || data.deliveryStatus in ['queued', 'sent', 'delivered', 'read', 'failed']);
    }

    // =========================================================================
    // ğŸ”” NOTIFICATION UPDATE VALIDATION
    // =========================================================================
    // ğŸ“‹ ADR-027: CRM Notifications Integration - Added 2026-01-13
    // ğŸ”’ ENTERPRISE: Only allows updating delivery state fields
    function isValidNotificationUpdate(newData, existingData) {
      // List of fields that users are allowed to modify
      let allowedFields = ['delivery', 'seenAt', 'actedAt', 'actionId'];

      // Get the fields that changed
      let changedKeys = newData.diff(existingData).affectedKeys();

      // All changed fields must be in the allowed list
      return changedKeys.hasOnly(allowedFields)
             // Ensure delivery state is valid if being updated
             && (!changedKeys.hasAny(['delivery'])
                 || newData.delivery.state in ['queued', 'sent', 'delivered', 'seen', 'acted', 'failed', 'expired'])
             // Ensure userId is never changed
             && newData.userId == existingData.userId
             // Ensure title is never changed
             && newData.title == existingData.title;
    }

    // System Fields Protection
    function isAttemptingToModifySystemFields(newData, existingData) {
      let systemFields = ['createdAt', 'createdBy', 'ownerId', 'id'];
      return systemFields.hasAny(
        newData.diff(existingData).affectedKeys()
      );
    }

    // Relationship checking helper
    function hasRelationshipWithContact(userId, contactId) {
      // This would need to be implemented based on your relationship logic
      // For now, allowing basic access - you can refine this later
      return true;
    }

    // =========================================================================
    // ğŸ—ï¸ DEVELOPMENT MODE HELPERS
    // =========================================================================

    // Dev mode helper - PRODUCTION MODE ENABLED
    function isDevMode() {
      // ğŸ”’ PRODUCTION: Dev mode disabled for security
      // Changed from true â†’ false on 2026-01-11 (Security Audit Fix)
      return false;
    }

    // Authentication helper
    function isAuthenticated() {
      return request.auth != null;
    }

    // User ownership helper
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // =========================================================================
    // ğŸ” RFC v6 AUTHORIZATION HELPERS (PHASE 1 PREPARATION)
    // =========================================================================
    // These helpers enable future tenant-scoped access control.
    // Path migration: /collection/{id} â†’ /companies/{companyId}/collection/{id}
    //
    // @see docs/rfc/authorization-rbac.md

    // Get user's companyId from custom claims
    function getUserCompanyId() {
      return request.auth.token.companyId;
    }

    // Get user's globalRole from custom claims
    function getGlobalRole() {
      return request.auth.token.globalRole;
    }

    // Check if user is super_admin (system-wide access)
    function isSuperAdminOnly() {
      return isAuthenticated() && getGlobalRole() == 'super_admin';
    }

    // Check if user is company_admin or higher
    function isCompanyAdmin() {
      return isAuthenticated() && getGlobalRole() in ['super_admin', 'company_admin'];
    }

    // Check if user is internal_user or higher
    function isInternalUser() {
      return isAuthenticated() && getGlobalRole() in ['super_admin', 'company_admin', 'internal_user'];
    }

    // Check if user belongs to a specific company (tenant isolation)
    function belongsToCompany(companyId) {
      return isAuthenticated() && getUserCompanyId() == companyId;
    }

    // P0-B FIX: Tenant-bound company admin (prevents cross-tenant writes)
    function isCompanyAdminOfCompany(companyId) {
      return isSuperAdminOnly() ||
             (getGlobalRole() == 'company_admin' && belongsToCompany(companyId));
    }

    // P0-B FIX: Tenant-bound internal user (prevents cross-tenant reads)
    function isInternalUserOfCompany(companyId) {
      return isSuperAdminOnly() ||
             (isInternalUser() && belongsToCompany(companyId));
    }

    // =========================================================================
    // ğŸ  UNIT FIELDS SECURITY HELPERS (2026-01-24)
    // =========================================================================
    // These helpers enable tenant-scoped access for units via projectâ†’company lookup
    // Units don't have companyId directly - must lookup via project reference

    // Get companyId from a project document (for tenant isolation)
    // Usage: getProjectCompanyId(resource.data.project) where project is the project ID string
    function getProjectCompanyId(projectId) {
      return get(/databases/$(database)/documents/projects/$(projectId)).data.companyId;
    }

    // Check if user belongs to the company that owns this project
    function belongsToProjectCompany(projectId) {
      return isSuperAdminOnly() || belongsToCompany(getProjectCompanyId(projectId));
    }

    // Check if user is company admin of the project's company
    function isCompanyAdminOfProject(projectId) {
      return isCompanyAdminOfCompany(getProjectCompanyId(projectId));
    }

    // =========================================================================
    // ğŸ¢ BUILDING LOOKUP HELPERS (PR-1D: floors, storage_units, parking_spots)
    // =========================================================================
    // ğŸ“… Added: 2026-01-29 (Security Gate Phase 1 - PR-1D)
    // ğŸ¢ ENTERPRISE: Similar pattern to project lookup, with project fallback
    //
    // Get the companyId from a building document
    // Handles both direct companyId and projectId fallback
    function getBuildingCompanyId(buildingId) {
      let building = get(/databases/$(database)/documents/buildings/$(buildingId)).data;
      // If building has direct companyId, use it
      // Otherwise, fall back to project lookup
      return building.keys().hasAny(['companyId'])
             ? building.companyId
             : getProjectCompanyId(building.projectId);
    }

    // Check if user belongs to the company that owns this building
    function belongsToBuildingCompany(buildingId) {
      return isSuperAdminOnly() || belongsToCompany(getBuildingCompanyId(buildingId));
    }

    // Unit Fields allowlist - only these fields can be updated by non-super-admin users
    // ğŸ¢ ENTERPRISE: Prevents modification of structural fields (project, id)
    // ğŸ“… Updated 2026-01-24: Added 'name' to allowlist (rename is allowed for company admins)
    // ğŸ“… Updated 2026-01-24: Added buildingId, floorId, linkedSpaces for Unit Linking System
    function isAllowedUnitFieldUpdate() {
      let allowedFields = [
        // Identity (editable by company admins)
        'name', 'description',
        // Unit Linking System (Phase 1-2) - Building/Floor/LinkedSpaces
        'buildingId', 'floorId', 'linkedSpaces',
        // Phase 1-5 Unit Fields
        'bedrooms', 'bathrooms', 'wc',
        'areas', 'orientation', 'orientations', 'condition', 'energyClass',
        'heating', 'cooling', 'flooring', 'frames', 'glazing',
        'interiorFeatures', 'securityFeatures',
        // Layout
        'layout',
        // Systems & Finishes
        'systemsOverride', 'finishes', 'energy',
        // Metadata
        'updatedAt', 'updatedBy',
        // Operational
        'operationalStatus', 'unitCoverage'
      ];
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
    }

    // Check that structural fields are not being modified (invariants)
    // ğŸ¢ ENTERPRISE: Prevents "re-tenanting" units via client update
    // ğŸ“… Updated 2026-01-24: Removed 'name' from invariants (rename is now allowed)
    // ğŸ“… Updated 2026-01-24: Removed buildingId/floorId from invariants (Unit Linking System)
    //    - Units CAN be moved between buildings/floors within the SAME project
    //    - Units CANNOT be moved to a different project (tenant isolation)
    function unitStructuralFieldsUnchanged() {
      return request.resource.data.project == resource.data.project
             && request.resource.data.id == resource.data.id;
    }

    // Validate parent document exists (for subcollections - prevents injection)
    function parentExists(path) {
      return exists(path);
    }
  }
}
