rules_version = '2';

// =============================================================================
// ðŸ”’ PRODUCTION-GRADE FIRESTORE SECURITY RULES
// =============================================================================
//
// ðŸŽ¯ Î£Î¤Î¡Î‘Î¤Î—Î“Î™ÎšÎ—: Deny-all by default, explicit allow per collection
// ðŸ›¡ï¸ Î‘Î¡Î§Î—: Zero Trust - ÎºÎ±Î¼Î¯Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Ï‡Ï‰ÏÎ¯Ï‚ authentication & authorization
// âš ï¸ ÎšÎ¡Î™Î£Î™ÎœÎŸ: Î‘Ï…Ï„Î­Ï‚ Î¿Î¹ rules Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÎ¿Ï…Î½ Ï„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î±Ï€ÏŒ unauthorized access
//
// =============================================================================

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // ðŸš« DEFAULT DENY-ALL RULE
    // =========================================================================
    // ÎŸÏ€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ ÏƒÏ…Î»Î»Î¿Î³Î® Ï€Î¿Ï… Î”Î•Î Î­Ï‡ÎµÎ¹ explicit rule â†’ Î‘Î¡ÎÎ—Î£Î—
    match /{document=**} {
      allow read, write: if false;
    }

    // =========================================================================
    // ðŸ“ PROJECTS COLLECTION - DEV-FRIENDLY ACCESS
    // =========================================================================
    match /projects/{projectId} {

      // ðŸ“– READ: Authenticated users only (Production mode)
      allow read: if isAuthenticated();

      // âœï¸ CREATE: ÎœÏŒÎ½Î¿ authenticated users Î¼Îµ validated data
      allow create: if request.auth != null
                    && isValidProjectData(request.resource.data)
                    && resource == null; // Ensure document doesn't exist

      // ðŸ“ UPDATE: ÎœÏŒÎ½Î¿ authenticated users Î¼Îµ validation
      allow update: if request.auth != null
                    && isValidProjectData(request.resource.data)
                    && resource != null  // Ensure document exists
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ðŸ—‘ï¸ DELETE: ÎœÏŒÎ½Î¿ authenticated users
      allow delete: if request.auth != null
                    && resource != null; // Ensure document exists
    }

    // =========================================================================
    // ðŸ‘¥ CONTACT_RELATIONSHIPS COLLECTION - STRICT OWNERSHIP
    // =========================================================================
    match /contact_relationships/{relationshipId} {

      // ðŸ“– READ: ÎœÏŒÎ½Î¿ authenticated users Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ source Î® target
      allow read: if request.auth != null
                  && (resource.data.sourceContactId == request.auth.uid
                      || resource.data.targetContactId == request.auth.uid);

      // âœï¸ CREATE: ÎœÏŒÎ½Î¿ authenticated users Î³Î¹Î± Î´Î¹ÎºÎ­Ï‚ Ï„Î¿Ï…Ï‚ relationships
      allow create: if request.auth != null
                    && isValidRelationshipData(request.resource.data)
                    && (request.resource.data.sourceContactId == request.auth.uid
                        || request.resource.data.targetContactId == request.auth.uid)
                    && resource == null;

      // ðŸ“ UPDATE: ÎœÏŒÎ½Î¿ owners Î¼Îµ system field protection
      allow update: if request.auth != null
                    && isValidRelationshipData(request.resource.data)
                    && (resource.data.sourceContactId == request.auth.uid
                        || resource.data.targetContactId == request.auth.uid)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ðŸ—‘ï¸ DELETE: ÎœÏŒÎ½Î¿ owners
      allow delete: if request.auth != null
                    && (resource.data.sourceContactId == request.auth.uid
                        || resource.data.targetContactId == request.auth.uid);
    }

    // =========================================================================
    // ðŸŽ¨ CAD_FILES COLLECTION - ENTERPRISE DXF STORAGE (Firebase Storage + Metadata)
    // =========================================================================
    match /cadFiles/{fileId} {

      // ðŸ“– READ: Authenticated with ownership support (Production mode)
      allow read: if request.auth != null
                  && (resource.data.keys().hasAny(['ownerId']) == false
                      || resource.data.ownerId == request.auth.uid);

      // âœï¸ CREATE: Authenticated users Î¼Îµ enterprise validation
      allow create: if request.auth != null
                    && isValidCadFileData(request.resource.data)
                    && (request.resource.data.keys().hasAny(['ownerId']) == false
                        || request.resource.data.ownerId == request.auth.uid)
                    && resource == null;

      // ðŸ“ UPDATE: Enterprise Î¼Îµ system field protection ÎºÎ±Î¹ Storage URL validation
      allow update: if request.auth != null
                    && isValidCadFileData(request.resource.data)
                    && (resource.data.keys().hasAny(['ownerId']) == false
                        || resource.data.ownerId == request.auth.uid)
                    && (request.resource.data.keys().hasAny(['ownerId']) == false
                        || request.resource.data.ownerId == request.auth.uid)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ðŸ—‘ï¸ DELETE: Owner only (Production mode)
      allow delete: if request.auth != null
                    && (resource.data.keys().hasAny(['ownerId']) == false
                        || resource.data.ownerId == request.auth.uid);
    }

    // =========================================================================
    // ðŸ“ FILES COLLECTION - ENTERPRISE CANONICAL FILE STORAGE (ADR-031)
    // =========================================================================
    // This collection stores FileRecord metadata (Source of Truth for file uploads)
    // Binary files are stored in Firebase Storage, metadata in Firestore
    //
    // Flow:
    // 1. CREATE: Client creates pending record (status: pending)
    // 2. Storage Upload: Binary uploaded to canonical path (Storage rules verify FileRecord)
    // 3. UPDATE: Client finalizes record (status: ready)
    // =========================================================================
    match /files/{fileId} {

      // ðŸ“– READ: Users belonging to file's company (tenant isolation)
      // ðŸ¢ ENTERPRISE: Allow company members OR creator (for pending files during upload)
      // This enables both:
      // - Storage Rules to validate uploads via firestore.get() (pending files)
      // - Users to list/view ready files from their company
      allow read: if isAuthenticated()
                  && resource.data.keys().hasAny(['companyId'])
                  && (
                       // Company members can read all files from their company
                       belongsToCompany(resource.data.companyId)
                       // OR super_admin can read everything
                       || isSuperAdminOnly()
                     );

      // âœï¸ CREATE: Users can create pending FileRecord for their company
      // ðŸ” SECURITY: createdBy must match request.auth.uid
      // ðŸ” SECURITY: companyId must match user's company claim
      // ðŸ” SECURITY: status must be 'pending' (no direct 'ready' creation)
      allow create: if isAuthenticated()
                    && request.resource.data.createdBy == request.auth.uid
                    && request.resource.data.companyId == getUserCompanyId()
                    && request.resource.data.status == 'pending'
                    && resource == null; // Ensure document doesn't exist

      // ðŸ“ UPDATE: Only creator or company admin can finalize
      // ðŸ” SECURITY: Limited to specific fields for finalization
      // ðŸ” SECURITY: Can only transition pending â†’ ready (or â†’ failed)
      allow update: if isAuthenticated()
                    && resource.data.companyId == getUserCompanyId()
                    && (
                         // Creator can finalize
                         resource.data.createdBy == request.auth.uid
                         // OR company admin can finalize
                         || isCompanyAdminOfCompany(resource.data.companyId)
                       )
                    // Status transitions: pending â†’ ready OR pending â†’ failed
                    && (
                         (resource.data.status == 'pending' && request.resource.data.status == 'ready')
                         || (resource.data.status == 'pending' && request.resource.data.status == 'failed')
                       )
                    // Prevent modification of immutable fields
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.companyId == resource.data.companyId
                    && request.resource.data.createdBy == resource.data.createdBy
                    && request.resource.data.storagePath == resource.data.storagePath;

      // ðŸ—‘ï¸ MOVE TO TRASH: Creator or company admin can trash ready files
      // ðŸ¢ ENTERPRISE: Ownership Principle (SAP/Salesforce/Google Drive pattern)
      //    - Creator can ALWAYS manage their own files (no claims required)
      //    - Admins need proper company claims for cross-user operations
      // ðŸ” SECURITY: Only allows setting isDeleted flag, preserves all other immutable fields
      allow update: if isAuthenticated()
                    && (
                         // OWNERSHIP PRINCIPLE: Creator can ALWAYS trash their own files
                         resource.data.createdBy == request.auth.uid
                         // OR company admin can trash any file in their company (requires claims)
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         // OR super_admin can trash anything
                         || isSuperAdminOnly()
                       )
                    // Only for ready files (soft delete)
                    && resource.data.status == 'ready'
                    // Must be setting isDeleted to true
                    && request.resource.data.isDeleted == true
                    // Preserve immutable fields
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.companyId == resource.data.companyId
                    && request.resource.data.createdBy == resource.data.createdBy
                    && request.resource.data.storagePath == resource.data.storagePath
                    && request.resource.data.status == resource.data.status;

      // â™»ï¸ RESTORE FROM TRASH: Creator or company admin can restore trashed files
      // ðŸ¢ ENTERPRISE: Ownership Principle (SAP/Salesforce/Google Drive pattern)
      //    - Creator can ALWAYS restore their own files (no claims required)
      //    - Admins need proper company claims for cross-user operations
      // ðŸ“… Added: 2026-01-20 (ADR-032 - Enterprise Trash System)
      allow update: if isAuthenticated()
                    && (
                         // OWNERSHIP PRINCIPLE: Creator can ALWAYS restore their own files
                         resource.data.createdBy == request.auth.uid
                         // OR company admin can restore any file in their company (requires claims)
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         // OR super_admin can restore anything
                         || isSuperAdminOnly()
                       )
                    // Only for trashed files (isDeleted == true)
                    && resource.data.isDeleted == true
                    // Must be setting isDeleted to false (restoring)
                    && request.resource.data.isDeleted == false
                    // Preserve immutable fields
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.companyId == resource.data.companyId
                    && request.resource.data.createdBy == resource.data.createdBy
                    && request.resource.data.storagePath == resource.data.storagePath
                    && request.resource.data.status == resource.data.status;

      // ðŸ—‘ï¸ HARD DELETE: Only creator or company admin
      allow delete: if isAuthenticated()
                    && resource.data.companyId == getUserCompanyId()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                       );
    }

    // =========================================================================
    // ðŸ¢ COMPANIES COLLECTION - READ-ONLY FOR AUTHENTICATED
    // =========================================================================
    match /companies/{companyId} {

      // ðŸ“– READ: ÎœÏŒÎ½Î¿ authenticated users
      allow read: if request.auth != null;

      // âœï¸ CREATE/UPDATE/DELETE: ÎŒÎ§Î™ Î±Ï€ÏŒ client - Î¼ÏŒÎ½Î¿ admin/server
      allow write: if false;
    }

    // =========================================================================
    // ðŸ  BUILDINGS, FLOORS & UNITS - PUBLIC READ ACCESS
    // =========================================================================
    match /buildings/{buildingId} {
      allow read: if true; // Public read for API routes (server-side)
      allow write: if false; // Admin/server only
    }

    // ðŸ¢ FLOORS: ÎŸÏÏŒÏ†Î¿Î¹ ÎºÏ„Î¹ÏÎ¯Ï‰Î½ - Navigation hierarchy support
    match /floors/{floorId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    match /units/{unitId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ðŸ“¦ STORAGE_UNITS COLLECTION - PARALLEL CATEGORY (local_4.log)
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Storage units are a PARALLEL category to Units, not nested
    // Architecture: Building â†’ [Units | Storage | Parking] (parallel)
    match /storage_units/{storageId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ðŸš— PARKING_SPOTS COLLECTION - PARALLEL CATEGORY (local_4.log)
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Parking spaces are a PARALLEL category to Units, not nested
    // Architecture: Building â†’ [Units | Storage | Parking] (parallel)
    // ðŸ“ Collection name: parking_spots (Î¼Îµ underscore - ÏŒÏ€Ï‰Ï‚ ÏƒÏ„Î· Firestore)
    match /parking_spots/{parkingId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only (use Firebase Admin SDK for seeding)
    }

    // =========================================================================
    // ðŸ§­ NAVIGATION_COMPANIES COLLECTION - DEV-FRIENDLY READ ACCESS
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Î•Ï„Î±Î¹ÏÎµÎ¯ÎµÏ‚ Ï€Î¿Ï… ÎµÎ¼Ï†Î±Î½Î¯Î¶Î¿Î½Ï„Î±Î¹ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î± ÏƒÏ„Î·Î½ Ï€Î»Î¿Î®Î³Î·ÏƒÎ·
    // Î ÎµÏÎ¹Î­Ï‡ÎµÎ¹ contactIds Ï€Î¿Ï… Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡Î¿ÏÎ½ ÏƒÎµ ÎµÏ„Î±Î¹ÏÎµÎ¯ÎµÏ‚ ÏƒÏ„Î· contacts collection
    match /navigation_companies/{navCompanyId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ðŸ”” NOTIFICATIONS COLLECTION - USER-SCOPED ACCESS
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Secure notification access per user
    // ðŸ”’ AUTHENTICATED: User can only access their own notifications
    // ðŸ“‹ ADR-027: CRM Notifications Integration - Updated 2026-01-13
    // âš ï¸ NOTE: For list queries, the userId filter must be in the query itself
    //          (where userId == auth.uid). Rules validate single doc reads.
    match /notifications/{notificationId} {
      // ðŸ“– READ: Authenticated users can read notifications
      // Query MUST include: where('userId', '==', currentUserId) for security
      // Single doc reads verify ownership
      allow read: if isAuthenticated()
                  && (resource == null || resource.data.userId == request.auth.uid);

      // ðŸ“ UPDATE: Users can mark their own notifications as read
      // Only allows updating delivery state and seen timestamp
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && isValidNotificationUpdate(request.resource.data, resource.data);

      // âœ… CREATE: Authenticated users can create notifications for themselves
      // ðŸ¢ ENTERPRISE: In production, this should be server-only
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;

      // ðŸ—‘ï¸ DELETE: Users can delete their own notifications
      // ðŸ¢ ENTERPRISE: Allows cleanup of test notifications
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }

    // =========================================================================
    // âœ… TASKS COLLECTION - CRM TASK MANAGEMENT
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Task management Î³Î¹Î± CRM leads, projects, ÎºÎ±Î¹ users
    // ðŸ”’ AUTHENTICATED: ÎœÏŒÎ½Î¿ authenticated users Î­Ï‡Î¿Ï…Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·
    // ðŸ“‹ ADR-026: CRM Tasks Backend Fix - Added 2026-01-13
    match /tasks/{taskId} {

      // ðŸ“– READ: Authenticated users can read tasks
      // TODO: Future enhancement - filter by assignedTo or leadId ownership
      allow read: if isAuthenticated();

      // âœï¸ CREATE: Authenticated users can create tasks
      allow create: if isAuthenticated()
                    && isValidTaskData(request.resource.data)
                    && resource == null;

      // ðŸ“ UPDATE: Authenticated users can update tasks
      allow update: if isAuthenticated()
                    && isValidTaskData(request.resource.data)
                    && resource != null;

      // ðŸ—‘ï¸ DELETE: Authenticated users can delete tasks
      allow delete: if isAuthenticated()
                    && resource != null;
    }

    // =========================================================================
    // ðŸ“ PROJECT_FLOORPLANS COLLECTION - DXF/PDF FLOORPLAN STORAGE
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Floorplans for projects, buildings, units
    match /project_floorplans/{floorplanId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Authenticated users can manage floorplans
    }

    // =========================================================================
    // ðŸ“ BUILDING_FLOORPLANS COLLECTION - BUILDING-LEVEL FLOORPLANS
    // =========================================================================
    match /building_floorplans/{floorplanId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ðŸ“ UNIT_FLOORPLANS COLLECTION - UNIT-LEVEL FLOORPLANS
    // =========================================================================
    match /unit_floorplans/{floorplanId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ðŸŽšï¸ DXF-VIEWER-LEVELS COLLECTION - DXF VIEWER LAYER/LEVEL SYSTEM
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Levels for DXF viewer layer management
    match /dxf-viewer-levels/{levelId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ðŸŽ¨ DXF OVERLAY LEVELS COLLECTION - DXF OVERLAY SYSTEM
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Overlay levels for DXF viewer (with items subcollection)
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix)
    // âš ï¸ BOTH naming conventions supported for backwards compatibility

    // Kebab-case version (used by overlay-store.tsx)
    match /dxf-overlay-levels/{levelId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();

      // ðŸ“ Items subcollection for overlay items
      match /items/{itemId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }

    // CamelCase version (legacy support)
    match /dxfOverlayLevels/{levelId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();

      // ðŸ“ Items subcollection for overlay items
      match /items/{itemId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }

    // =========================================================================
    // ðŸŽ¨ LAYERS COLLECTION - LEGACY LAYER SYSTEM
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Legacy layers for property visualization
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /layers/{layerId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ðŸ“‹ LAYER EVENTS COLLECTION - LAYER SYNC EVENTS
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Events for layer synchronization
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /layer-events/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ðŸ  PROPERTY LAYERS COLLECTION - PROPERTY VISUALIZATION
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Property-specific layers
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /property-layers/{layerId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ðŸ” SECURITY_ROLES COLLECTION - ÎšÎ¡Î™Î£Î™ÎœÎŸ Î“Î™Î‘ LOGIN!
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Role-based access control Î³Î¹Î± EnterpriseSecurityService
    match /security_roles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ðŸ‘¤ USERS COLLECTION & SESSIONS SUBCOLLECTION
    // =========================================================================
    // ðŸ¢ ENTERPRISE: User profile ÎºÎ±Î¹ active sessions management
    // ðŸ”’ OWNERSHIP-BASED: ÎšÎ¬Î¸Îµ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï…
    match /users/{userId} {
      // ðŸ“– READ/WRITE: ÎœÏŒÎ½Î¿ Î¿ Î¯Î´Î¹Î¿Ï‚ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚
      allow read, write: if isOwner(userId);

      // ðŸ” SESSIONS SUBCOLLECTION - Enterprise Active Sessions Management
      match /sessions/{sessionId} {
        // ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î³ÏÎ¬Ï†ÎµÎ¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï… sessions
        allow read, write: if isOwner(userId);
      }
    }

    // =========================================================================
    // ðŸ” USER_2FA_SETTINGS COLLECTION - Two-Factor Authentication
    // =========================================================================
    // ðŸ¢ ENTERPRISE: 2FA settings ÎºÎ±Î¹ backup codes storage
    // ðŸ”’ OWNERSHIP-BASED: ÎšÎ¬Î¸Îµ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï… 2FA settings
    match /user_2fa_settings/{userId} {
      // ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î³ÏÎ¬Ï†ÎµÎ¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï… 2FA settings
      allow read, write: if isOwner(userId);
    }

    // =========================================================================
    // ðŸ”” USER_NOTIFICATION_SETTINGS COLLECTION - Notification Preferences
    // =========================================================================
    // ðŸ¢ ENTERPRISE: User notification preferences management
    // ðŸ”’ OWNERSHIP-BASED: ÎšÎ¬Î¸Îµ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Ï„Î¹Ï‚ Î´Î¹ÎºÎ­Ï‚ Ï„Î¿Ï… ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚
    match /user_notification_settings/{userId} {
      // ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î³ÏÎ¬Ï†ÎµÎ¹ ÎœÎŸÎÎŸ Ï„Î¹Ï‚ Î´Î¹ÎºÎ­Ï‚ Ï„Î¿Ï… ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ‰Î½
      allow read, write: if isOwner(userId);
    }

    // =========================================================================
    // ðŸ“ž CONTACTS COLLECTION - PUBLIC READ ACCESS
    // =========================================================================
    match /contacts/{contactId} {

      // ðŸ“– READ: Authenticated users can read contacts (for business operations)
      // TODO: Refine to project-based access when relationships are implemented
      allow read: if isAuthenticated();

      // âœï¸ CREATE: ÎœÏŒÎ½Î¿ Î³Î¹Î± Ï„Î¿Î½ ÎµÎ±Ï…Ï„ÏŒ Ï„Î¿Ï…
      allow create: if request.auth != null
                    && request.auth.uid == contactId
                    && isValidContactData(request.resource.data)
                    && resource == null;

      // ðŸ“ UPDATE: ÎœÏŒÎ½Î¿ Î¿ Î¯Î´Î¹Î¿Ï‚ Î¼Îµ system field protection
      allow update: if request.auth != null
                    && request.auth.uid == contactId
                    && isValidContactData(request.resource.data)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ðŸ—‘ï¸ DELETE: ÎœÏŒÎ½Î¿ Î¿ Î¯Î´Î¹Î¿Ï‚
      allow delete: if request.auth != null
                    && request.auth.uid == contactId;
    }

    // =========================================================================
    // ðŸ’¬ COMMUNICATIONS COLLECTION - LEGACY CRM COMMUNICATIONS
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Legacy communications collection
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /communications/{communicationId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // âš™ï¸ SYSTEM COLLECTION - SYSTEM CONFIGURATION
    // =========================================================================
    // ðŸ¢ ENTERPRISE: System-wide configuration and templates
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /system/{docId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin/server only

      // ðŸ“ Subcollections (e.g., project-templates)
      match /{subcollection}/{subDocId} {
        allow read: if isAuthenticated();
        allow write: if false; // Admin/server only
      }
    }

    // =========================================================================
    // âš™ï¸ CONFIG COLLECTION - APPLICATION CONFIGURATION
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Application configuration
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /config/{configId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ðŸŽ¯ LEADS COLLECTION - CRM LEADS
    // =========================================================================
    // ðŸ¢ ENTERPRISE: CRM lead management
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /leads/{leadId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ðŸ’¼ OPPORTUNITIES COLLECTION - CRM OPPORTUNITIES
    // =========================================================================
    // ðŸ¢ ENTERPRISE: CRM opportunity management
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /opportunities/{opportunityId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ðŸ“‹ ACTIVITIES COLLECTION - CRM ACTIVITIES
    // =========================================================================
    // ðŸ¢ ENTERPRISE: CRM activity tracking
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /activities/{activityId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ðŸ’¬ CONVERSATIONS - CRM COMMUNICATIONS
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Telegram/email conversations Î³Î¹Î± CRM
    // ðŸ”’ DEV-FRIENDLY: Authenticated users Î­Ï‡Î¿Ï…Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· (Î³Î¹Î± development/testing)
    // ðŸ“… Added: 2026-01-15
    // âš ï¸ TODO (PHASE 2): ÎœÎµÏ„Î¬Î²Î±ÏƒÎ· ÏƒÎµ isInternalUser() ÏŒÏ„Î±Î½ setup custom claims (globalRole)
    match /conversations/{conversationId} {
      // ðŸ“– READ: Authenticated users (dev-friendly Î³Î¹Î± realtime listener)
      // TODO: Change to isInternalUser() after custom claims setup
      allow read: if isAuthenticated();

      // âœï¸ CREATE: Authenticated users can create new conversations
      allow create: if isAuthenticated()
                    && isValidConversationData(request.resource.data)
                    && resource == null;

      // ðŸ“ UPDATE: Authenticated users can update conversation metadata
      allow update: if isAuthenticated()
                    && isValidConversationData(request.resource.data)
                    && resource != null;

      // ðŸ—‘ï¸ DELETE: Authenticated users (prevent accidental deletions by guests)
      allow delete: if isAuthenticated()
                    && resource != null;
    }

    // =========================================================================
    // ðŸ’¬ MESSAGES (ROOT COLLECTION) - CRM COMMUNICATIONS
    // =========================================================================
    // ðŸ¢ ENTERPRISE: Messages stored in ROOT collection (not subcollection)
    // Architecture: messages/{messageId} with conversationId field
    // ðŸ”’ DEV-FRIENDLY: Authenticated users Î­Ï‡Î¿Ï…Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·
    // ðŸ“‹ REAL-TIME UPDATES: Supports Firestore onSnapshot Î³Î¹Î± instant message updates
    // ðŸ“… Added: 2026-01-15
    match /messages/{messageId} {
      // ðŸ“– READ: Authenticated users (supports real-time listener)
      // TODO: Change to isInternalUser() after custom claims setup
      allow read: if isAuthenticated();

      // âœï¸ CREATE: Authenticated users can send messages
      allow create: if isAuthenticated()
                    && isValidMessageData(request.resource.data)
                    && resource == null;

      // ðŸ“ UPDATE: Authenticated users can update message delivery status
      allow update: if isAuthenticated()
                    && isValidMessageData(request.resource.data)
                    && resource != null;

      // ðŸ—‘ï¸ DELETE: Authenticated users
      allow delete: if isAuthenticated()
                    && resource != null;
    }

    // =========================================================================
    // ðŸ” EXTERNAL IDENTITIES - TELEGRAM USER MAPPINGS
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - CRITICAL collection)
    // ðŸ¢ ENTERPRISE: Maps external platform IDs (Telegram chatId) to internal contacts
    match /external_identities/{identityId} {
      // ðŸ“– READ: Authenticated users (CRM needs to lookup identities)
      allow read: if isAuthenticated();

      // âœï¸ CREATE: Only system/admin can create identity mappings
      allow create: if isAuthenticated()
                    && resource == null;

      // ðŸ“ UPDATE: Only system/admin can update identity mappings
      allow update: if isAuthenticated()
                    && resource != null;

      // ðŸ—‘ï¸ DELETE: Only admin can delete identity mappings
      allow delete: if isAuthenticated()
                    && resource != null;
    }

    // =========================================================================
    // âš™ï¸ CONFIG - ENTERPRISE SERVICE CONFIGURATIONS
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - CRITICAL collection)
    // ðŸ¢ ENTERPRISE: System-wide configuration (channels, integrations, etc.)
    match /config/{configId} {
      // ðŸ“– READ: Authenticated users (app needs config)
      allow read: if isAuthenticated();

      // âœï¸ CREATE/UPDATE/DELETE: Only admin users
      allow create, update, delete: if isAuthenticated();
    }

    // =========================================================================
    // ðŸ”— RELATIONSHIPS - ENTITY RELATIONSHIPS (GENERIC)
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - CRITICAL collection)
    // ðŸ¢ ENTERPRISE: General-purpose relationships between entities
    // âš ï¸ Note: contact_relationships has separate, more strict rules above
    match /relationships/{relationshipId} {
      // ðŸ“– READ: Authenticated users
      allow read: if isAuthenticated();

      // âœï¸ CREATE: Authenticated users
      allow create: if isAuthenticated()
                    && resource == null;

      // ðŸ“ UPDATE: Authenticated users
      allow update: if isAuthenticated()
                    && resource != null;

      // ðŸ—‘ï¸ DELETE: Authenticated users
      allow delete: if isAuthenticated()
                    && resource != null;
    }

    // =========================================================================
    // ðŸ” SECURITY POLICIES - EMAIL DOMAIN & COUNTRY RESTRICTIONS
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - CRITICAL collection)
    // ðŸ¢ ENTERPRISE: EnterpriseSecurityService policy collections (READ-ONLY for clients)
    match /email_domain_policies/{policyId} {
      // ðŸ“– READ: Authenticated users (security validation needs this)
      allow read: if isAuthenticated();
      // ðŸš« WRITE: Server-side only (via Admin SDK)
      allow write: if false;
    }

    match /country_security_policies/{policyId} {
      // ðŸ“– READ: Authenticated users (security validation needs this)
      allow read: if isAuthenticated();
      // ðŸš« WRITE: Server-side only (via Admin SDK)
      allow write: if false;
    }

    // =========================================================================
    // ðŸ”¢ COUNTERS - PROJECT CODE GENERATION
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - HIGH priority)
    // ðŸ¢ ENTERPRISE: Auto-increment counters for project codes, etc.
    match /counters/{counterId} {
      // ðŸ“– READ: Authenticated users (need to read current counter)
      allow read: if isAuthenticated();
      // âœï¸ WRITE: Authenticated users (increment on create)
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ðŸ“Š ANALYTICS - SENDGRID WEBHOOK ANALYTICS
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - HIGH priority)
    match /analytics/{analyticsId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ðŸ“‹ OBLIGATIONS & TEMPLATES
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - HIGH priority)
    match /obligations/{obligationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && resource == null;
      allow update: if isAuthenticated() && resource != null;
      allow delete: if isAuthenticated() && resource != null;
    }

    match /obligationTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && resource == null;
      allow update: if isAuthenticated() && resource != null;
      allow delete: if isAuthenticated() && resource != null;
    }

    // ðŸ“‹ OBLIGATION-SECTIONS - Obligation sections (dash naming convention)
    // ðŸ“… Added: 2026-01-17 (Missing collection from Firestore audit)
    match /obligation-sections/{sectionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && resource == null;
      allow update: if isAuthenticated() && resource != null;
      allow delete: if isAuthenticated() && resource != null;
    }

    // =========================================================================
    // ðŸ’¼ OPPORTUNITIES - CRM SALES PIPELINE
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - HIGH priority)
    match /opportunities/{opportunityId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && resource == null;
      allow update: if isAuthenticated() && resource != null;
      allow delete: if isAuthenticated() && resource != null;
    }

    // =========================================================================
    // ðŸ‘¥ LEADS - CRM LEAD MANAGEMENT
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - MEDIUM priority)
    match /leads/{leadId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && resource == null;
      allow update: if isAuthenticated() && resource != null;
      allow delete: if isAuthenticated() && resource != null;
    }

    // =========================================================================
    // ðŸ“† ACTIVITIES - CRM ACTIVITY TRACKING
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - MEDIUM priority)
    match /activities/{activityId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && resource == null;
      allow update: if isAuthenticated() && resource != null;
      allow delete: if isAuthenticated() && resource != null;
    }

    // =========================================================================
    // ðŸ¤– BOT_CONFIGS - TELEGRAM BOT CONFIGURATIONS
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - MEDIUM priority)
    match /bot_configs/{configId} {
      allow read: if isAuthenticated();
      // ðŸš« WRITE: Server-side only (sensitive bot tokens)
      allow write: if false;
    }

    // =========================================================================
    // ðŸ—‚ï¸ LAYER GROUPS - DXF LAYER MANAGEMENT
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - MEDIUM priority)
    match /layerGroups/{groupId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ðŸ—ºï¸ FLOORPLANS - FLOOR PLAN STORAGE
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - MEDIUM priority)
    match /floorplans/{floorplanId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ðŸ“ AUDIT COLLECTIONS - SECURITY & COMPLIANCE
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - HIGH priority)
    // ðŸ¢ ENTERPRISE: Audit logs are READ-ONLY for clients (write via Admin SDK)
    match /relationship_audit/{auditId} {
      allow read: if isAuthenticated();
      allow write: if false; // Server-side only
    }

    match /admin_building_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Admin UI needs write access
    }

    match /audit_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if false; // Server-side only
    }

    match /system_audit_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if false; // Server-side only
    }

    // =========================================================================
    // ðŸ“‹ AUDIT_LOG COLLECTION - CLOUD FUNCTIONS AUDIT TRAIL
    // =========================================================================
    // ðŸ“… Added: 2026-01-20 (ADR-032 - Enterprise Trash System)
    // ðŸ¢ ENTERPRISE: Audit log for file purge operations (written by Cloud Functions)
    // ðŸ”’ READ: Only super_admin can read audit logs
    // ðŸš« WRITE: Server-side only (via Firebase Admin SDK)
    match /audit_log/{logId} {
      allow read: if isSuperAdminOnly();
      allow write: if false; // Server-side only (Cloud Functions use Admin SDK)
    }

    // =========================================================================
    // ðŸ‘¥ TEAMS - TEAM MANAGEMENT
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Final 2 collections fix)
    // ðŸ¢ ENTERPRISE: Team management for EnterpriseTeamsService
    match /teams/{teamId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ðŸ’¼ POSITIONS - ROLE/POSITION MANAGEMENT
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Final 2 collections fix)
    // ðŸ¢ ENTERPRISE: Position management (fallback for COLLECTIONS.ROLES)
    match /positions/{positionId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // âš™ï¸ SYSTEM - SYSTEM CONFIGURATION
    // =========================================================================
    // ðŸ“… Added: 2026-01-17 (Permission-denied fix - MEDIUM priority)
    // Note: Already had partial rules, adding subcollection support
    match /system/{docId} {
      allow read: if isAuthenticated();
      allow write: if false; // Server-side only

      // Subcollections (e.g., system/config/channels)
      match /{subcollection}/{subDocId} {
        allow read: if isAuthenticated();
        allow write: if false; // Server-side only
      }
    }

    // =========================================================================
    // ðŸ”’ HELPER FUNCTIONS - VALIDATION & SECURITY
    // =========================================================================

    // Project Data Validation
    function isValidProjectData(data) {
      return data.keys().hasAll(['name', 'status', 'company'])
             && data.name is string && data.name.size() > 0
             && data.status in ['planning', 'in_progress', 'completed', 'on_hold', 'cancelled']
             && data.company is string && data.company.size() > 0;
    }

    // Relationship Data Validation
    function isValidRelationshipData(data) {
      return data.keys().hasAll(['sourceContactId', 'targetContactId', 'relationshipType', 'status'])
             && data.sourceContactId is string && data.sourceContactId.size() > 0
             && data.targetContactId is string && data.targetContactId.size() > 0
             && data.relationshipType in ['employee', 'manager', 'partner', 'client', 'vendor']
             && data.status in ['active', 'inactive', 'pending', 'deleted'];
    }

    // ðŸŽ¨ Enterprise CAD File Data Validation (Firebase Storage + Metadata Only)
    function isValidCadFileData(data) {
      return data.keys().hasAll(['fileName'])
             && data.fileName is string && data.fileName.size() > 0
             // ðŸš¨ ÎšÎ¡Î™Î£Î™ÎœÎŸ: Î”Î•Î ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î¼Îµ scene object ÏƒÏ„Î¿ Firestore! (ÎœÏ€Î±ÎºÎ¬Î»Î¹ÎºÎ¿ Î³ÎµÎ¹Ï„Î¿Î½Î¹Î¬Ï‚)
             && !data.keys().hasAny(['scene'])
             // âœ… ENTERPRISE: Firebase Storage-based validation
             && (
               // Legacy format (Firestore-based data)
               !data.keys().hasAny(['storageUrl']) ||
               // ðŸ¢ ENTERPRISE FORMAT: Firebase Storage Î¼Îµ metadata
               (data.keys().hasAll(['storageUrl'])
                && data.storageUrl is string
                && data.storageUrl.size() > 0
                // âœ… Validate Firebase Storage URL format
                && data.storageUrl.matches('https://firebasestorage.googleapis.com/.*'))
             )
             // âœ… Enterprise metadata validation
             && (!data.keys().hasAny(['version']) || (data.version is number && data.version > 0))
             && (!data.keys().hasAny(['sizeBytes']) || (data.sizeBytes is number && data.sizeBytes > 0))
             && (!data.keys().hasAny(['entityCount']) || (data.entityCount is number && data.entityCount >= 0))
             && (!data.keys().hasAny(['checksum']) || (data.checksum is string && data.checksum.size() > 0));
    }

    // Contact Data Validation
    function isValidContactData(data) {
      return data.keys().hasAll(['email'])
             && data.email is string
             && data.email.matches('.*@.*\\..*'); // Basic email validation
    }

    // âœ… Task Data Validation (ADR-026: CRM Tasks Backend Fix)
    // ðŸ¢ ENTERPRISE: Validates CrmTask structure for Firestore operations
    function isValidTaskData(data) {
      return data.keys().hasAll(['title', 'type', 'assignedTo', 'status', 'priority'])
             // ðŸ“ Title validation
             && data.title is string && data.title.size() > 0
             // ðŸ“‹ Type validation (enum)
             && data.type in ['call', 'email', 'meeting', 'viewing', 'document', 'follow_up', 'other']
             // ðŸ‘¤ AssignedTo validation (User ID)
             && data.assignedTo is string && data.assignedTo.size() > 0
             // ðŸ“Š Status validation (enum)
             && data.status in ['pending', 'in_progress', 'completed', 'cancelled']
             // âš¡ Priority validation (enum)
             && data.priority in ['low', 'medium', 'high', 'urgent']
             // ðŸ”— Optional leadId validation
             && (!data.keys().hasAny(['leadId']) || (data.leadId is string))
             // ðŸ”— Optional contactId validation
             && (!data.keys().hasAny(['contactId']) || (data.contactId is string))
             // ðŸ”— Optional projectId validation
             && (!data.keys().hasAny(['projectId']) || (data.projectId is string))
             // ðŸ“ Optional description validation
             && (!data.keys().hasAny(['description']) || (data.description is string));
    }

    // =========================================================================
    // ðŸ’¬ CONVERSATION & MESSAGE DATA VALIDATION
    // =========================================================================
    // ðŸ“‹ CRM Communications - Added 2026-01-15
    // ðŸ¢ ENTERPRISE: Validates Conversation and Message structures for Firestore operations

    // Conversation Data Validation
    function isValidConversationData(data) {
      return data.keys().hasAll(['channel', 'status'])
             // ðŸ“¡ Channel validation (enum: telegram | email | whatsapp | sms)
             && data.channel in ['telegram', 'email', 'whatsapp', 'sms']
             // ðŸ“Š Status validation (enum)
             && data.status in ['active', 'archived', 'closed', 'spam']
             // ðŸ”¢ Optional messageCount validation
             && (!data.keys().hasAny(['messageCount']) || (data.messageCount is int && data.messageCount >= 0))
             // ðŸ”” Optional unreadCount validation
             && (!data.keys().hasAny(['unreadCount']) || (data.unreadCount is int && data.unreadCount >= 0))
             // ðŸ‘¤ Optional assignedTo validation
             && (!data.keys().hasAny(['assignedTo']) || (data.assignedTo == null || data.assignedTo is string));
    }

    // Message Data Validation
    function isValidMessageData(data) {
      return data.keys().hasAll(['conversationId', 'direction', 'channel', 'content'])
             // ðŸ”— ConversationId validation
             && data.conversationId is string && data.conversationId.size() > 0
             // â†”ï¸ Direction validation (enum: inbound | outbound)
             && data.direction in ['inbound', 'outbound']
             // ðŸ“¡ Channel validation (enum)
             && data.channel in ['telegram', 'email', 'whatsapp', 'sms']
             // ðŸ“ Content validation (must have text field)
             && data.content is map
             && data.content.keys().hasAll(['text'])
             && data.content.text is string
             // ðŸ‘¤ Optional sender fields validation
             && (!data.keys().hasAny(['senderId']) || (data.senderId is string))
             && (!data.keys().hasAny(['senderName']) || (data.senderName is string))
             // ðŸ“Š Optional deliveryStatus validation
             && (!data.keys().hasAny(['deliveryStatus'])
                 || data.deliveryStatus in ['queued', 'sent', 'delivered', 'read', 'failed']);
    }

    // =========================================================================
    // ðŸ”” NOTIFICATION UPDATE VALIDATION
    // =========================================================================
    // ðŸ“‹ ADR-027: CRM Notifications Integration - Added 2026-01-13
    // ðŸ”’ ENTERPRISE: Only allows updating delivery state fields
    function isValidNotificationUpdate(newData, existingData) {
      // List of fields that users are allowed to modify
      let allowedFields = ['delivery', 'seenAt', 'actedAt', 'actionId'];

      // Get the fields that changed
      let changedKeys = newData.diff(existingData).affectedKeys();

      // All changed fields must be in the allowed list
      return changedKeys.hasOnly(allowedFields)
             // Ensure delivery state is valid if being updated
             && (!changedKeys.hasAny(['delivery'])
                 || newData.delivery.state in ['queued', 'sent', 'delivered', 'seen', 'acted', 'failed', 'expired'])
             // Ensure userId is never changed
             && newData.userId == existingData.userId
             // Ensure title is never changed
             && newData.title == existingData.title;
    }

    // System Fields Protection
    function isAttemptingToModifySystemFields(newData, existingData) {
      let systemFields = ['createdAt', 'createdBy', 'ownerId', 'id'];
      return systemFields.hasAny(
        newData.diff(existingData).affectedKeys()
      );
    }

    // Relationship checking helper
    function hasRelationshipWithContact(userId, contactId) {
      // This would need to be implemented based on your relationship logic
      // For now, allowing basic access - you can refine this later
      return true;
    }

    // =========================================================================
    // ðŸ—ï¸ DEVELOPMENT MODE HELPERS
    // =========================================================================

    // Dev mode helper - PRODUCTION MODE ENABLED
    function isDevMode() {
      // ðŸ”’ PRODUCTION: Dev mode disabled for security
      // Changed from true â†’ false on 2026-01-11 (Security Audit Fix)
      return false;
    }

    // Authentication helper
    function isAuthenticated() {
      return request.auth != null;
    }

    // User ownership helper
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // =========================================================================
    // ðŸ” RFC v6 AUTHORIZATION HELPERS (PHASE 1 PREPARATION)
    // =========================================================================
    // These helpers enable future tenant-scoped access control.
    // Path migration: /collection/{id} â†’ /companies/{companyId}/collection/{id}
    //
    // @see docs/rfc/authorization-rbac.md

    // Get user's companyId from custom claims
    function getUserCompanyId() {
      return request.auth.token.companyId;
    }

    // Get user's globalRole from custom claims
    function getGlobalRole() {
      return request.auth.token.globalRole;
    }

    // Check if user is super_admin (system-wide access)
    function isSuperAdminOnly() {
      return isAuthenticated() && getGlobalRole() == 'super_admin';
    }

    // Check if user is company_admin or higher
    function isCompanyAdmin() {
      return isAuthenticated() && getGlobalRole() in ['super_admin', 'company_admin'];
    }

    // Check if user is internal_user or higher
    function isInternalUser() {
      return isAuthenticated() && getGlobalRole() in ['super_admin', 'company_admin', 'internal_user'];
    }

    // Check if user belongs to a specific company (tenant isolation)
    function belongsToCompany(companyId) {
      return isAuthenticated() && getUserCompanyId() == companyId;
    }

    // P0-B FIX: Tenant-bound company admin (prevents cross-tenant writes)
    function isCompanyAdminOfCompany(companyId) {
      return isSuperAdminOnly() ||
             (getGlobalRole() == 'company_admin' && belongsToCompany(companyId));
    }

    // P0-B FIX: Tenant-bound internal user (prevents cross-tenant reads)
    function isInternalUserOfCompany(companyId) {
      return isSuperAdminOnly() ||
             (isInternalUser() && belongsToCompany(companyId));
    }

    // Validate parent document exists (for subcollections - prevents injection)
    function parentExists(path) {
      return exists(path);
    }
  }
}
