rules_version = '2';

// =============================================================================
// ğŸ”’ PRODUCTION-GRADE FIRESTORE SECURITY RULES
// =============================================================================
//
// ğŸ¯ Î£Î¤Î¡Î‘Î¤Î—Î“Î™ÎšÎ—: Deny-all by default, explicit allow per collection
// ğŸ›¡ï¸ Î‘Î¡Î§Î—: Zero Trust - ÎºÎ±Î¼Î¯Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Ï‡Ï‰ÏÎ¯Ï‚ authentication & authorization
// âš ï¸ ÎšÎ¡Î™Î£Î™ÎœÎŸ: Î‘Ï…Ï„Î­Ï‚ Î¿Î¹ rules Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÎ¿Ï…Î½ Ï„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î±Ï€ÏŒ unauthorized access
//
// =============================================================================

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // ğŸš« DEFAULT DENY-ALL RULE
    // =========================================================================
    // ÎŸÏ€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ ÏƒÏ…Î»Î»Î¿Î³Î® Ï€Î¿Ï… Î”Î•Î Î­Ï‡ÎµÎ¹ explicit rule â†’ Î‘Î¡ÎÎ—Î£Î—
    match /{document=**} {
      allow read, write: if false;
    }

    // =========================================================================
    // ğŸ“ PROJECTS COLLECTION - DEV-FRIENDLY ACCESS
    // =========================================================================
    match /projects/{projectId} {

      // ğŸ“– READ: Authenticated users only (Production mode)
      allow read: if isAuthenticated();

      // âœï¸ CREATE: ÎœÏŒÎ½Î¿ authenticated users Î¼Îµ validated data
      allow create: if request.auth != null
                    && isValidProjectData(request.resource.data)
                    && resource == null; // Ensure document doesn't exist

      // ğŸ“ UPDATE: ÎœÏŒÎ½Î¿ authenticated users Î¼Îµ validation
      allow update: if request.auth != null
                    && isValidProjectData(request.resource.data)
                    && resource != null  // Ensure document exists
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ğŸ—‘ï¸ DELETE: ÎœÏŒÎ½Î¿ authenticated users
      allow delete: if request.auth != null
                    && resource != null; // Ensure document exists
    }

    // =========================================================================
    // ğŸ‘¥ CONTACT_RELATIONSHIPS COLLECTION - STRICT OWNERSHIP
    // =========================================================================
    match /contact_relationships/{relationshipId} {

      // ğŸ“– READ: ÎœÏŒÎ½Î¿ authenticated users Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ source Î® target
      allow read: if request.auth != null
                  && (resource.data.sourceContactId == request.auth.uid
                      || resource.data.targetContactId == request.auth.uid);

      // âœï¸ CREATE: ÎœÏŒÎ½Î¿ authenticated users Î³Î¹Î± Î´Î¹ÎºÎ­Ï‚ Ï„Î¿Ï…Ï‚ relationships
      allow create: if request.auth != null
                    && isValidRelationshipData(request.resource.data)
                    && (request.resource.data.sourceContactId == request.auth.uid
                        || request.resource.data.targetContactId == request.auth.uid)
                    && resource == null;

      // ğŸ“ UPDATE: ÎœÏŒÎ½Î¿ owners Î¼Îµ system field protection
      allow update: if request.auth != null
                    && isValidRelationshipData(request.resource.data)
                    && (resource.data.sourceContactId == request.auth.uid
                        || resource.data.targetContactId == request.auth.uid)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ğŸ—‘ï¸ DELETE: ÎœÏŒÎ½Î¿ owners
      allow delete: if request.auth != null
                    && (resource.data.sourceContactId == request.auth.uid
                        || resource.data.targetContactId == request.auth.uid);
    }

    // =========================================================================
    // ğŸ¨ CAD_FILES COLLECTION - ENTERPRISE DXF STORAGE (Firebase Storage + Metadata)
    // =========================================================================
    match /cadFiles/{fileId} {

      // ğŸ“– READ: Authenticated with ownership support (Production mode)
      allow read: if request.auth != null
                  && (resource.data.keys().hasAny(['ownerId']) == false
                      || resource.data.ownerId == request.auth.uid);

      // âœï¸ CREATE: Authenticated users Î¼Îµ enterprise validation
      allow create: if request.auth != null
                    && isValidCadFileData(request.resource.data)
                    && (request.resource.data.keys().hasAny(['ownerId']) == false
                        || request.resource.data.ownerId == request.auth.uid)
                    && resource == null;

      // ğŸ“ UPDATE: Enterprise Î¼Îµ system field protection ÎºÎ±Î¹ Storage URL validation
      allow update: if request.auth != null
                    && isValidCadFileData(request.resource.data)
                    && (resource.data.keys().hasAny(['ownerId']) == false
                        || resource.data.ownerId == request.auth.uid)
                    && (request.resource.data.keys().hasAny(['ownerId']) == false
                        || request.resource.data.ownerId == request.auth.uid)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ğŸ—‘ï¸ DELETE: Owner only (Production mode)
      allow delete: if request.auth != null
                    && (resource.data.keys().hasAny(['ownerId']) == false
                        || resource.data.ownerId == request.auth.uid);
    }

    // =========================================================================
    // ğŸ¢ COMPANIES COLLECTION - READ-ONLY FOR AUTHENTICATED
    // =========================================================================
    match /companies/{companyId} {

      // ğŸ“– READ: ÎœÏŒÎ½Î¿ authenticated users
      allow read: if request.auth != null;

      // âœï¸ CREATE/UPDATE/DELETE: ÎŒÎ§Î™ Î±Ï€ÏŒ client - Î¼ÏŒÎ½Î¿ admin/server
      allow write: if false;
    }

    // =========================================================================
    // ğŸ  BUILDINGS, FLOORS & UNITS - PUBLIC READ ACCESS
    // =========================================================================
    match /buildings/{buildingId} {
      allow read: if true; // Public read for API routes (server-side)
      allow write: if false; // Admin/server only
    }

    // ğŸ¢ FLOORS: ÎŸÏÏŒÏ†Î¿Î¹ ÎºÏ„Î¹ÏÎ¯Ï‰Î½ - Navigation hierarchy support
    match /floors/{floorId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    match /units/{unitId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸ“¦ STORAGE_UNITS COLLECTION - PARALLEL CATEGORY (local_4.log)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Storage units are a PARALLEL category to Units, not nested
    // Architecture: Building â†’ [Units | Storage | Parking] (parallel)
    match /storage_units/{storageId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸš— PARKING_SPOTS COLLECTION - PARALLEL CATEGORY (local_4.log)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Parking spaces are a PARALLEL category to Units, not nested
    // Architecture: Building â†’ [Units | Storage | Parking] (parallel)
    // ğŸ“ Collection name: parking_spots (Î¼Îµ underscore - ÏŒÏ€Ï‰Ï‚ ÏƒÏ„Î· Firestore)
    match /parking_spots/{parkingId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only (use Firebase Admin SDK for seeding)
    }

    // =========================================================================
    // ğŸ§­ NAVIGATION_COMPANIES COLLECTION - DEV-FRIENDLY READ ACCESS
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Î•Ï„Î±Î¹ÏÎµÎ¯ÎµÏ‚ Ï€Î¿Ï… ÎµÎ¼Ï†Î±Î½Î¯Î¶Î¿Î½Ï„Î±Î¹ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î± ÏƒÏ„Î·Î½ Ï€Î»Î¿Î®Î³Î·ÏƒÎ·
    // Î ÎµÏÎ¹Î­Ï‡ÎµÎ¹ contactIds Ï€Î¿Ï… Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡Î¿ÏÎ½ ÏƒÎµ ÎµÏ„Î±Î¹ÏÎµÎ¯ÎµÏ‚ ÏƒÏ„Î· contacts collection
    match /navigation_companies/{navCompanyId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸ”” NOTIFICATIONS COLLECTION - USER-SCOPED ACCESS
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Secure notification access per user
    // ğŸ”’ AUTHENTICATED: User can only access their own notifications
    // ğŸ“‹ ADR-027: CRM Notifications Integration - Updated 2026-01-13
    match /notifications/{notificationId} {
      // ğŸ“– READ: Users can only read their own notifications
      allow read: if isAuthenticated()
                  && resource.data.userId == request.auth.uid;

      // ğŸ“ UPDATE: Users can mark their own notifications as read
      // Only allows updating delivery state and seen timestamp
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && isValidNotificationUpdate(request.resource.data, resource.data);

      // âŒ CREATE/DELETE: Server/Admin only (via Firebase Admin SDK)
      allow create: if false;
      allow delete: if false;
    }

    // =========================================================================
    // âœ… TASKS COLLECTION - CRM TASK MANAGEMENT
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Task management Î³Î¹Î± CRM leads, projects, ÎºÎ±Î¹ users
    // ğŸ”’ AUTHENTICATED: ÎœÏŒÎ½Î¿ authenticated users Î­Ï‡Î¿Ï…Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·
    // ğŸ“‹ ADR-026: CRM Tasks Backend Fix - Added 2026-01-13
    match /tasks/{taskId} {

      // ğŸ“– READ: Authenticated users can read tasks
      // TODO: Future enhancement - filter by assignedTo or leadId ownership
      allow read: if isAuthenticated();

      // âœï¸ CREATE: Authenticated users can create tasks
      allow create: if isAuthenticated()
                    && isValidTaskData(request.resource.data)
                    && resource == null;

      // ğŸ“ UPDATE: Authenticated users can update tasks
      allow update: if isAuthenticated()
                    && isValidTaskData(request.resource.data)
                    && resource != null;

      // ğŸ—‘ï¸ DELETE: Authenticated users can delete tasks
      allow delete: if isAuthenticated()
                    && resource != null;
    }

    // =========================================================================
    // ğŸ“ PROJECT_FLOORPLANS COLLECTION - DXF/PDF FLOORPLAN STORAGE
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Floorplans for projects, buildings, units
    match /project_floorplans/{floorplanId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Authenticated users can manage floorplans
    }

    // =========================================================================
    // ğŸ“ BUILDING_FLOORPLANS COLLECTION - BUILDING-LEVEL FLOORPLANS
    // =========================================================================
    match /building_floorplans/{floorplanId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ“ UNIT_FLOORPLANS COLLECTION - UNIT-LEVEL FLOORPLANS
    // =========================================================================
    match /unit_floorplans/{floorplanId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸšï¸ DXF-VIEWER-LEVELS COLLECTION - DXF VIEWER LAYER/LEVEL SYSTEM
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Levels for DXF viewer layer management
    match /dxf-viewer-levels/{levelId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ” SECURITY_ROLES COLLECTION - ÎšÎ¡Î™Î£Î™ÎœÎŸ Î“Î™Î‘ LOGIN!
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Role-based access control Î³Î¹Î± EnterpriseSecurityService
    match /security_roles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸ‘¤ USERS COLLECTION & SESSIONS SUBCOLLECTION
    // =========================================================================
    // ğŸ¢ ENTERPRISE: User profile ÎºÎ±Î¹ active sessions management
    // ğŸ”’ OWNERSHIP-BASED: ÎšÎ¬Î¸Îµ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï…
    match /users/{userId} {
      // ğŸ“– READ/WRITE: ÎœÏŒÎ½Î¿ Î¿ Î¯Î´Î¹Î¿Ï‚ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚
      allow read, write: if isOwner(userId);

      // ğŸ” SESSIONS SUBCOLLECTION - Enterprise Active Sessions Management
      match /sessions/{sessionId} {
        // ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î³ÏÎ¬Ï†ÎµÎ¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï… sessions
        allow read, write: if isOwner(userId);
      }
    }

    // =========================================================================
    // ğŸ” USER_2FA_SETTINGS COLLECTION - Two-Factor Authentication
    // =========================================================================
    // ğŸ¢ ENTERPRISE: 2FA settings ÎºÎ±Î¹ backup codes storage
    // ğŸ”’ OWNERSHIP-BASED: ÎšÎ¬Î¸Îµ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï… 2FA settings
    match /user_2fa_settings/{userId} {
      // ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î³ÏÎ¬Ï†ÎµÎ¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï… 2FA settings
      allow read, write: if isOwner(userId);
    }

    // =========================================================================
    // ğŸ”” USER_NOTIFICATION_SETTINGS COLLECTION - Notification Preferences
    // =========================================================================
    // ğŸ¢ ENTERPRISE: User notification preferences management
    // ğŸ”’ OWNERSHIP-BASED: ÎšÎ¬Î¸Îµ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Ï„Î¹Ï‚ Î´Î¹ÎºÎ­Ï‚ Ï„Î¿Ï… ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚
    match /user_notification_settings/{userId} {
      // ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î³ÏÎ¬Ï†ÎµÎ¹ ÎœÎŸÎÎŸ Ï„Î¹Ï‚ Î´Î¹ÎºÎ­Ï‚ Ï„Î¿Ï… ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ‰Î½
      allow read, write: if isOwner(userId);
    }

    // =========================================================================
    // ğŸ“ CONTACTS COLLECTION - PUBLIC READ ACCESS
    // =========================================================================
    match /contacts/{contactId} {

      // ğŸ“– READ: Authenticated users can read contacts (for business operations)
      // TODO: Refine to project-based access when relationships are implemented
      allow read: if isAuthenticated();

      // âœï¸ CREATE: ÎœÏŒÎ½Î¿ Î³Î¹Î± Ï„Î¿Î½ ÎµÎ±Ï…Ï„ÏŒ Ï„Î¿Ï…
      allow create: if request.auth != null
                    && request.auth.uid == contactId
                    && isValidContactData(request.resource.data)
                    && resource == null;

      // ğŸ“ UPDATE: ÎœÏŒÎ½Î¿ Î¿ Î¯Î´Î¹Î¿Ï‚ Î¼Îµ system field protection
      allow update: if request.auth != null
                    && request.auth.uid == contactId
                    && isValidContactData(request.resource.data)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ğŸ—‘ï¸ DELETE: ÎœÏŒÎ½Î¿ Î¿ Î¯Î´Î¹Î¿Ï‚
      allow delete: if request.auth != null
                    && request.auth.uid == contactId;
    }

    // =========================================================================
    // ğŸ”’ HELPER FUNCTIONS - VALIDATION & SECURITY
    // =========================================================================

    // Project Data Validation
    function isValidProjectData(data) {
      return data.keys().hasAll(['name', 'status', 'company'])
             && data.name is string && data.name.size() > 0
             && data.status in ['planning', 'in_progress', 'completed', 'on_hold', 'cancelled']
             && data.company is string && data.company.size() > 0;
    }

    // Relationship Data Validation
    function isValidRelationshipData(data) {
      return data.keys().hasAll(['sourceContactId', 'targetContactId', 'relationshipType', 'status'])
             && data.sourceContactId is string && data.sourceContactId.size() > 0
             && data.targetContactId is string && data.targetContactId.size() > 0
             && data.relationshipType in ['employee', 'manager', 'partner', 'client', 'vendor']
             && data.status in ['active', 'inactive', 'pending', 'deleted'];
    }

    // ğŸ¨ Enterprise CAD File Data Validation (Firebase Storage + Metadata Only)
    function isValidCadFileData(data) {
      return data.keys().hasAll(['fileName'])
             && data.fileName is string && data.fileName.size() > 0
             // ğŸš¨ ÎšÎ¡Î™Î£Î™ÎœÎŸ: Î”Î•Î ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î¼Îµ scene object ÏƒÏ„Î¿ Firestore! (ÎœÏ€Î±ÎºÎ¬Î»Î¹ÎºÎ¿ Î³ÎµÎ¹Ï„Î¿Î½Î¹Î¬Ï‚)
             && !data.keys().hasAny(['scene'])
             // âœ… ENTERPRISE: Firebase Storage-based validation
             && (
               // Legacy format (Firestore-based data)
               !data.keys().hasAny(['storageUrl']) ||
               // ğŸ¢ ENTERPRISE FORMAT: Firebase Storage Î¼Îµ metadata
               (data.keys().hasAll(['storageUrl'])
                && data.storageUrl is string
                && data.storageUrl.size() > 0
                // âœ… Validate Firebase Storage URL format
                && data.storageUrl.matches('https://firebasestorage.googleapis.com/.*'))
             )
             // âœ… Enterprise metadata validation
             && (!data.keys().hasAny(['version']) || (data.version is number && data.version > 0))
             && (!data.keys().hasAny(['sizeBytes']) || (data.sizeBytes is number && data.sizeBytes > 0))
             && (!data.keys().hasAny(['entityCount']) || (data.entityCount is number && data.entityCount >= 0))
             && (!data.keys().hasAny(['checksum']) || (data.checksum is string && data.checksum.size() > 0));
    }

    // Contact Data Validation
    function isValidContactData(data) {
      return data.keys().hasAll(['email'])
             && data.email is string
             && data.email.matches('.*@.*\\..*'); // Basic email validation
    }

    // âœ… Task Data Validation (ADR-026: CRM Tasks Backend Fix)
    // ğŸ¢ ENTERPRISE: Validates CrmTask structure for Firestore operations
    function isValidTaskData(data) {
      return data.keys().hasAll(['title', 'type', 'assignedTo', 'status', 'priority'])
             // ğŸ“ Title validation
             && data.title is string && data.title.size() > 0
             // ğŸ“‹ Type validation (enum)
             && data.type in ['call', 'email', 'meeting', 'viewing', 'document', 'follow_up', 'other']
             // ğŸ‘¤ AssignedTo validation (User ID)
             && data.assignedTo is string && data.assignedTo.size() > 0
             // ğŸ“Š Status validation (enum)
             && data.status in ['pending', 'in_progress', 'completed', 'cancelled']
             // âš¡ Priority validation (enum)
             && data.priority in ['low', 'medium', 'high', 'urgent']
             // ğŸ”— Optional leadId validation
             && (!data.keys().hasAny(['leadId']) || (data.leadId is string))
             // ğŸ”— Optional contactId validation
             && (!data.keys().hasAny(['contactId']) || (data.contactId is string))
             // ğŸ”— Optional projectId validation
             && (!data.keys().hasAny(['projectId']) || (data.projectId is string))
             // ğŸ“ Optional description validation
             && (!data.keys().hasAny(['description']) || (data.description is string));
    }

    // =========================================================================
    // ğŸ”” NOTIFICATION UPDATE VALIDATION
    // =========================================================================
    // ğŸ“‹ ADR-027: CRM Notifications Integration - Added 2026-01-13
    // ğŸ”’ ENTERPRISE: Only allows updating delivery state fields
    function isValidNotificationUpdate(newData, existingData) {
      // List of fields that users are allowed to modify
      let allowedFields = ['delivery', 'seenAt', 'actedAt', 'actionId'];

      // Get the fields that changed
      let changedKeys = newData.diff(existingData).affectedKeys();

      // All changed fields must be in the allowed list
      return changedKeys.hasOnly(allowedFields)
             // Ensure delivery state is valid if being updated
             && (!changedKeys.hasAny(['delivery'])
                 || newData.delivery.state in ['queued', 'sent', 'delivered', 'seen', 'acted', 'failed', 'expired'])
             // Ensure userId is never changed
             && newData.userId == existingData.userId
             // Ensure title is never changed
             && newData.title == existingData.title;
    }

    // System Fields Protection
    function isAttemptingToModifySystemFields(newData, existingData) {
      let systemFields = ['createdAt', 'createdBy', 'ownerId', 'id'];
      return systemFields.hasAny(
        newData.diff(existingData).affectedKeys()
      );
    }

    // Relationship checking helper
    function hasRelationshipWithContact(userId, contactId) {
      // This would need to be implemented based on your relationship logic
      // For now, allowing basic access - you can refine this later
      return true;
    }

    // =========================================================================
    // ğŸ—ï¸ DEVELOPMENT MODE HELPERS
    // =========================================================================

    // Dev mode helper - PRODUCTION MODE ENABLED
    function isDevMode() {
      // ğŸ”’ PRODUCTION: Dev mode disabled for security
      // Changed from true â†’ false on 2026-01-11 (Security Audit Fix)
      return false;
    }

    // Authentication helper
    function isAuthenticated() {
      return request.auth != null;
    }

    // User ownership helper
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
  }
}