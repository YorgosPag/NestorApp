rules_version = '2';

// =============================================================================
// ğŸ”’ PRODUCTION-GRADE FIRESTORE SECURITY RULES
// =============================================================================
//
// ğŸ¯ Î£Î¤Î¡Î‘Î¤Î—Î“Î™ÎšÎ—: Deny-all by default, explicit allow per collection
// ğŸ›¡ï¸ Î‘Î¡Î§Î—: Zero Trust - ÎºÎ±Î¼Î¯Î± Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· Ï‡Ï‰ÏÎ¯Ï‚ authentication & authorization
// âš ï¸ ÎšÎ¡Î™Î£Î™ÎœÎŸ: Î‘Ï…Ï„Î­Ï‚ Î¿Î¹ rules Ï€ÏÎ¿ÏƒÏ„Î±Ï„ÎµÏÎ¿Ï…Î½ Ï„Î·Î½ ÎµÏ†Î±ÏÎ¼Î¿Î³Î® Î±Ï€ÏŒ unauthorized access
//
// =============================================================================

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // ğŸš« DEFAULT DENY-ALL RULE
    // =========================================================================
    // ÎŸÏ€Î¿Î¹Î±Î´Î®Ï€Î¿Ï„Îµ ÏƒÏ…Î»Î»Î¿Î³Î® Ï€Î¿Ï… Î”Î•Î Î­Ï‡ÎµÎ¹ explicit rule â†’ Î‘Î¡ÎÎ—Î£Î—
    match /{document=**} {
      allow read, write: if false;
    }

    // =========================================================================
    // ğŸ“ PROJECTS COLLECTION - DEV-FRIENDLY ACCESS
    // =========================================================================
    match /projects/{projectId} {

      // ğŸ“– READ: Authenticated users only (Production mode)
      allow read: if isAuthenticated();

      // âœï¸ CREATE: ÎœÏŒÎ½Î¿ authenticated users Î¼Îµ validated data
      allow create: if request.auth != null
                    && isValidProjectData(request.resource.data)
                    && resource == null; // Ensure document doesn't exist

      // ğŸ“ UPDATE: ÎœÏŒÎ½Î¿ authenticated users Î¼Îµ validation
      allow update: if request.auth != null
                    && isValidProjectData(request.resource.data)
                    && resource != null  // Ensure document exists
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ğŸ—‘ï¸ DELETE: ÎœÏŒÎ½Î¿ authenticated users
      allow delete: if request.auth != null
                    && resource != null; // Ensure document exists
    }

    // =========================================================================
    // ğŸ‘¥ CONTACT_RELATIONSHIPS COLLECTION - STRICT OWNERSHIP
    // =========================================================================
    match /contact_relationships/{relationshipId} {

      // ğŸ“– READ: ÎœÏŒÎ½Î¿ authenticated users Ï€Î¿Ï… ÎµÎ¯Î½Î±Î¹ source Î® target
      allow read: if request.auth != null
                  && (resource.data.sourceContactId == request.auth.uid
                      || resource.data.targetContactId == request.auth.uid);

      // âœï¸ CREATE: ÎœÏŒÎ½Î¿ authenticated users Î³Î¹Î± Î´Î¹ÎºÎ­Ï‚ Ï„Î¿Ï…Ï‚ relationships
      allow create: if request.auth != null
                    && isValidRelationshipData(request.resource.data)
                    && (request.resource.data.sourceContactId == request.auth.uid
                        || request.resource.data.targetContactId == request.auth.uid)
                    && resource == null;

      // ğŸ“ UPDATE: ÎœÏŒÎ½Î¿ owners Î¼Îµ system field protection
      allow update: if request.auth != null
                    && isValidRelationshipData(request.resource.data)
                    && (resource.data.sourceContactId == request.auth.uid
                        || resource.data.targetContactId == request.auth.uid)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ğŸ—‘ï¸ DELETE: ÎœÏŒÎ½Î¿ owners
      allow delete: if request.auth != null
                    && (resource.data.sourceContactId == request.auth.uid
                        || resource.data.targetContactId == request.auth.uid);
    }

    // =========================================================================
    // ğŸ¨ CAD_FILES COLLECTION - ENTERPRISE DXF STORAGE (Firebase Storage + Metadata)
    // =========================================================================
    match /cadFiles/{fileId} {

      // ğŸ“– READ: Authenticated with ownership support (Production mode)
      allow read: if request.auth != null
                  && (resource.data.keys().hasAny(['ownerId']) == false
                      || resource.data.ownerId == request.auth.uid);

      // âœï¸ CREATE: Authenticated users Î¼Îµ enterprise validation
      allow create: if request.auth != null
                    && isValidCadFileData(request.resource.data)
                    && (request.resource.data.keys().hasAny(['ownerId']) == false
                        || request.resource.data.ownerId == request.auth.uid)
                    && resource == null;

      // ğŸ“ UPDATE: Enterprise Î¼Îµ system field protection ÎºÎ±Î¹ Storage URL validation
      allow update: if request.auth != null
                    && isValidCadFileData(request.resource.data)
                    && (resource.data.keys().hasAny(['ownerId']) == false
                        || resource.data.ownerId == request.auth.uid)
                    && (request.resource.data.keys().hasAny(['ownerId']) == false
                        || request.resource.data.ownerId == request.auth.uid)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ğŸ—‘ï¸ DELETE: Owner only (Production mode)
      allow delete: if request.auth != null
                    && (resource.data.keys().hasAny(['ownerId']) == false
                        || resource.data.ownerId == request.auth.uid);
    }

    // =========================================================================
    // ğŸ“ FILES COLLECTION - ENTERPRISE CANONICAL FILE STORAGE (ADR-031)
    // =========================================================================
    // This collection stores FileRecord metadata (Source of Truth for file uploads)
    // Binary files are stored in Firebase Storage, metadata in Firestore
    //
    // Flow:
    // 1. CREATE: Client creates pending record (status: pending)
    // 2. Storage Upload: Binary uploaded to canonical path (Storage rules verify FileRecord)
    // 3. UPDATE: Client finalizes record (status: ready)
    // =========================================================================
    match /files/{fileId} {

      // ğŸ“– READ: Users belonging to file's company (tenant isolation)
      // ğŸ¢ ENTERPRISE: Allow company members OR creator (for pending files during upload)
      // This enables both:
      // - Storage Rules to validate uploads via firestore.get() (pending files)
      // - Users to list/view ready files from their company
      allow read: if isAuthenticated()
                  && resource.data.keys().hasAny(['companyId'])
                  && (
                       // Company members can read all files from their company
                       belongsToCompany(resource.data.companyId)
                       // OR super_admin can read everything
                       || isSuperAdminOnly()
                     );

      // âœï¸ CREATE: Users can create pending FileRecord for their company
      // ğŸ” SECURITY: createdBy must match request.auth.uid
      // ğŸ” SECURITY: companyId must match user's company claim
      // ğŸ” SECURITY: status must be 'pending' (no direct 'ready' creation)
      allow create: if isAuthenticated()
                    && request.resource.data.createdBy == request.auth.uid
                    && request.resource.data.companyId == getUserCompanyId()
                    && request.resource.data.status == 'pending'
                    && resource == null; // Ensure document doesn't exist

      // ğŸ“ UPDATE: Only creator or company admin can finalize
      // ğŸ” SECURITY: Limited to specific fields for finalization
      // ğŸ” SECURITY: Can only transition pending â†’ ready (or â†’ failed)
      allow update: if isAuthenticated()
                    && resource.data.companyId == getUserCompanyId()
                    && (
                         // Creator can finalize
                         resource.data.createdBy == request.auth.uid
                         // OR company admin can finalize
                         || isCompanyAdminOfCompany(resource.data.companyId)
                       )
                    // Status transitions: pending â†’ ready OR pending â†’ failed
                    && (
                         (resource.data.status == 'pending' && request.resource.data.status == 'ready')
                         || (resource.data.status == 'pending' && request.resource.data.status == 'failed')
                       )
                    // Prevent modification of immutable fields
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.companyId == resource.data.companyId
                    && request.resource.data.createdBy == resource.data.createdBy
                    && request.resource.data.storagePath == resource.data.storagePath;

      // ğŸ—‘ï¸ MOVE TO TRASH: Creator or company admin can trash ready files
      // ğŸ¢ ENTERPRISE: Ownership Principle (SAP/Salesforce/Google Drive pattern)
      //    - Creator can ALWAYS manage their own files (no claims required)
      //    - Admins need proper company claims for cross-user operations
      // ğŸ” SECURITY: Only allows setting isDeleted flag, preserves all other immutable fields
      allow update: if isAuthenticated()
                    && (
                         // OWNERSHIP PRINCIPLE: Creator can ALWAYS trash their own files
                         resource.data.createdBy == request.auth.uid
                         // OR company admin can trash any file in their company (requires claims)
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         // OR super_admin can trash anything
                         || isSuperAdminOnly()
                       )
                    // Only for ready files (soft delete)
                    && resource.data.status == 'ready'
                    // Must be setting isDeleted to true
                    && request.resource.data.isDeleted == true
                    // Preserve immutable fields
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.companyId == resource.data.companyId
                    && request.resource.data.createdBy == resource.data.createdBy
                    && request.resource.data.storagePath == resource.data.storagePath
                    && request.resource.data.status == resource.data.status;

      // â™»ï¸ RESTORE FROM TRASH: Creator or company admin can restore trashed files
      // ğŸ¢ ENTERPRISE: Ownership Principle (SAP/Salesforce/Google Drive pattern)
      //    - Creator can ALWAYS restore their own files (no claims required)
      //    - Admins need proper company claims for cross-user operations
      // ğŸ“… Added: 2026-01-20 (ADR-032 - Enterprise Trash System)
      allow update: if isAuthenticated()
                    && (
                         // OWNERSHIP PRINCIPLE: Creator can ALWAYS restore their own files
                         resource.data.createdBy == request.auth.uid
                         // OR company admin can restore any file in their company (requires claims)
                         || isCompanyAdminOfCompany(resource.data.companyId)
                         // OR super_admin can restore anything
                         || isSuperAdminOnly()
                       )
                    // Only for trashed files (isDeleted == true)
                    && resource.data.isDeleted == true
                    // Must be setting isDeleted to false (restoring)
                    && request.resource.data.isDeleted == false
                    // Preserve immutable fields
                    && request.resource.data.id == resource.data.id
                    && request.resource.data.companyId == resource.data.companyId
                    && request.resource.data.createdBy == resource.data.createdBy
                    && request.resource.data.storagePath == resource.data.storagePath
                    && request.resource.data.status == resource.data.status;

      // ğŸ—‘ï¸ HARD DELETE: Only creator or company admin
      allow delete: if isAuthenticated()
                    && resource.data.companyId == getUserCompanyId()
                    && (
                         resource.data.createdBy == request.auth.uid
                         || isCompanyAdminOfCompany(resource.data.companyId)
                       );
    }

    // =========================================================================
    // ğŸ¢ COMPANIES COLLECTION - READ-ONLY FOR AUTHENTICATED
    // =========================================================================
    match /companies/{companyId} {

      // ğŸ“– READ: ÎœÏŒÎ½Î¿ authenticated users
      allow read: if request.auth != null;

      // âœï¸ CREATE/UPDATE/DELETE: ÎŒÎ§Î™ Î±Ï€ÏŒ client - Î¼ÏŒÎ½Î¿ admin/server
      allow write: if false;
    }

    // =========================================================================
    // ğŸ  BUILDINGS, FLOORS & UNITS - PUBLIC READ ACCESS
    // =========================================================================
    match /buildings/{buildingId} {
      allow read: if true; // Public read for API routes (server-side)
      allow write: if false; // Admin/server only
    }

    // ğŸ¢ FLOORS: ÎŸÏÏŒÏ†Î¿Î¹ ÎºÏ„Î¹ÏÎ¯Ï‰Î½ - Navigation hierarchy support
    match /floors/{floorId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸ  UNITS COLLECTION - ENTERPRISE TENANT ISOLATION (2026-01-24)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Full tenant isolation via projectâ†’company lookup
    // ğŸ“‹ Security Model:
    //    - READ: Only users belonging to the project's company (tenant-scoped)
    //    - UPDATE: Company admins of project's company + field allowlist + invariants
    //    - CREATE/DELETE: Admin/server only (via Firebase Admin SDK)
    // ğŸ” Invariants: project, buildingId, floorId, name, id cannot be changed by client
    // ğŸ“… Implemented: 2026-01-24
    match /units/{unitId} {
      // ğŸ“– READ: Tenant-scoped - only users from the project's company
      // ğŸ”’ SECURITY: Prevents cross-tenant data leak
      allow read: if isAuthenticated()
                  && (
                       // Super admin can read all
                       isSuperAdminOnly()
                       // OR user belongs to the project's company
                       || belongsToProjectCompany(resource.data.project)
                     );

      // âœï¸ CREATE: Admin/server only
      allow create: if false;

      // ğŸ“ UPDATE: Company admin of project's company + field allowlist + invariants
      // ğŸ”’ SECURITY LAYERS:
      //    1. Role gate: Must be company_admin or super_admin
      //    2. Tenant gate: Must belong to project's company
      //    3. Field allowlist: Only unit fields can be updated (not structural fields)
      //    4. Invariants: Structural fields (project, buildingId, floorId, name, id) unchanged
      allow update: if isAuthenticated()
                    && (
                         // Super admin bypasses all checks
                         isSuperAdminOnly()
                         // OR company admin of project's company with allowlist + invariants
                         || (
                              isCompanyAdminOfProject(resource.data.project)
                              && isAllowedUnitFieldUpdate()
                              && unitStructuralFieldsUnchanged()
                            )
                       );

      // ğŸ—‘ï¸ DELETE: Admin/server only
      allow delete: if false;
    }

    // =========================================================================
    // ğŸ“¦ STORAGE_UNITS COLLECTION - PARALLEL CATEGORY (local_4.log)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Storage units are a PARALLEL category to Units, not nested
    // Architecture: Building â†’ [Units | Storage | Parking] (parallel)
    match /storage_units/{storageId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸš— PARKING_SPOTS COLLECTION - PARALLEL CATEGORY (local_4.log)
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Parking spaces are a PARALLEL category to Units, not nested
    // Architecture: Building â†’ [Units | Storage | Parking] (parallel)
    // ğŸ“ Collection name: parking_spots (Î¼Îµ underscore - ÏŒÏ€Ï‰Ï‚ ÏƒÏ„Î· Firestore)
    match /parking_spots/{parkingId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only (use Firebase Admin SDK for seeding)
    }

    // =========================================================================
    // ğŸ§­ NAVIGATION_COMPANIES COLLECTION - DEV-FRIENDLY READ ACCESS
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Î•Ï„Î±Î¹ÏÎµÎ¯ÎµÏ‚ Ï€Î¿Ï… ÎµÎ¼Ï†Î±Î½Î¯Î¶Î¿Î½Ï„Î±Î¹ Ï‡ÎµÎ¹ÏÎ¿ÎºÎ¯Î½Î·Ï„Î± ÏƒÏ„Î·Î½ Ï€Î»Î¿Î®Î³Î·ÏƒÎ·
    // Î ÎµÏÎ¹Î­Ï‡ÎµÎ¹ contactIds Ï€Î¿Ï… Î±Î½Ï„Î¹ÏƒÏ„Î¿Î¹Ï‡Î¿ÏÎ½ ÏƒÎµ ÎµÏ„Î±Î¹ÏÎµÎ¯ÎµÏ‚ ÏƒÏ„Î· contacts collection
    match /navigation_companies/{navCompanyId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸ”” NOTIFICATIONS COLLECTION - USER-SCOPED ACCESS
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Secure notification access per user
    // ğŸ”’ AUTHENTICATED: User can only access their own notifications
    // ğŸ“‹ ADR-027: CRM Notifications Integration - Updated 2026-01-13
    // âš ï¸ NOTE: For list queries, the userId filter must be in the query itself
    //          (where userId == auth.uid). Rules validate single doc reads.
    match /notifications/{notificationId} {
      // ğŸ“– READ: Authenticated users can read notifications
      // Query MUST include: where('userId', '==', currentUserId) for security
      // Single doc reads verify ownership
      allow read: if isAuthenticated()
                  && (resource == null || resource.data.userId == request.auth.uid);

      // ğŸ“ UPDATE: Users can mark their own notifications as read
      // Only allows updating delivery state and seen timestamp
      allow update: if isAuthenticated()
                    && resource.data.userId == request.auth.uid
                    && isValidNotificationUpdate(request.resource.data, resource.data);

      // âœ… CREATE: Authenticated users can create notifications for themselves
      // ğŸ¢ ENTERPRISE: In production, this should be server-only
      allow create: if isAuthenticated()
                    && request.resource.data.userId == request.auth.uid;

      // ğŸ—‘ï¸ DELETE: Users can delete their own notifications
      // ğŸ¢ ENTERPRISE: Allows cleanup of test notifications
      allow delete: if isAuthenticated()
                    && resource.data.userId == request.auth.uid;
    }

    // =========================================================================
    // âœ… TASKS COLLECTION - CRM TASK MANAGEMENT
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Task management Î³Î¹Î± CRM leads, projects, ÎºÎ±Î¹ users
    // ğŸ”’ AUTHENTICATED: ÎœÏŒÎ½Î¿ authenticated users Î­Ï‡Î¿Ï…Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·
    // ğŸ“‹ ADR-026: CRM Tasks Backend Fix - Added 2026-01-13
    match /tasks/{taskId} {

      // ğŸ“– READ: Authenticated users can read tasks
      // TODO: Future enhancement - filter by assignedTo or leadId ownership
      allow read: if isAuthenticated();

      // âœï¸ CREATE: Authenticated users can create tasks
      allow create: if isAuthenticated()
                    && isValidTaskData(request.resource.data)
                    && resource == null;

      // ğŸ“ UPDATE: Authenticated users can update tasks
      allow update: if isAuthenticated()
                    && isValidTaskData(request.resource.data)
                    && resource != null;

      // ğŸ—‘ï¸ DELETE: Authenticated users can delete tasks
      allow delete: if isAuthenticated()
                    && resource != null;
    }

    // =========================================================================
    // ğŸ“ PROJECT_FLOORPLANS COLLECTION - DXF/PDF FLOORPLAN STORAGE
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Floorplans for projects, buildings, units
    match /project_floorplans/{floorplanId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Authenticated users can manage floorplans
    }

    // =========================================================================
    // ğŸ“ BUILDING_FLOORPLANS COLLECTION - BUILDING-LEVEL FLOORPLANS
    // =========================================================================
    match /building_floorplans/{floorplanId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ“ UNIT_FLOORPLANS COLLECTION - UNIT-LEVEL FLOORPLANS
    // =========================================================================
    match /unit_floorplans/{floorplanId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸšï¸ DXF-VIEWER-LEVELS COLLECTION - DXF VIEWER LAYER/LEVEL SYSTEM
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Levels for DXF viewer layer management
    match /dxf-viewer-levels/{levelId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ¨ DXF OVERLAY LEVELS COLLECTION - DXF OVERLAY SYSTEM
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Overlay levels for DXF viewer (with items subcollection)
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix)
    // âš ï¸ BOTH naming conventions supported for backwards compatibility

    // Kebab-case version (used by overlay-store.tsx)
    match /dxf-overlay-levels/{levelId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();

      // ğŸ“ Items subcollection for overlay items
      match /items/{itemId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }

    // CamelCase version (legacy support)
    match /dxfOverlayLevels/{levelId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();

      // ğŸ“ Items subcollection for overlay items
      match /items/{itemId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
    }

    // =========================================================================
    // ğŸ¨ LAYERS COLLECTION - LEGACY LAYER SYSTEM
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Legacy layers for property visualization
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /layers/{layerId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ“‹ LAYER EVENTS COLLECTION - LAYER SYNC EVENTS
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Events for layer synchronization
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /layer-events/{eventId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ  PROPERTY LAYERS COLLECTION - PROPERTY VISUALIZATION
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Property-specific layers
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /property-layers/{layerId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ” SECURITY_ROLES COLLECTION - ÎšÎ¡Î™Î£Î™ÎœÎŸ Î“Î™Î‘ LOGIN!
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Role-based access control Î³Î¹Î± EnterpriseSecurityService
    match /security_roles/{roleId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸ‘¤ USERS COLLECTION & SESSIONS SUBCOLLECTION
    // =========================================================================
    // ğŸ¢ ENTERPRISE: User profile ÎºÎ±Î¹ active sessions management
    // ğŸ”’ OWNERSHIP-BASED: ÎšÎ¬Î¸Îµ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï…
    match /users/{userId} {
      // ğŸ“– READ/WRITE: ÎœÏŒÎ½Î¿ Î¿ Î¯Î´Î¹Î¿Ï‚ Î¿ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚
      allow read, write: if isOwner(userId);

      // ğŸ” SESSIONS SUBCOLLECTION - Enterprise Active Sessions Management
      match /sessions/{sessionId} {
        // ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î³ÏÎ¬Ï†ÎµÎ¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï… sessions
        allow read, write: if isOwner(userId);
      }
    }

    // =========================================================================
    // ğŸ” USER_2FA_SETTINGS COLLECTION - Two-Factor Authentication
    // =========================================================================
    // ğŸ¢ ENTERPRISE: 2FA settings ÎºÎ±Î¹ backup codes storage
    // ğŸ”’ OWNERSHIP-BASED: ÎšÎ¬Î¸Îµ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï… 2FA settings
    match /user_2fa_settings/{userId} {
      // ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î³ÏÎ¬Ï†ÎµÎ¹ ÎœÎŸÎÎŸ Ï„Î± Î´Î¹ÎºÎ¬ Ï„Î¿Ï… 2FA settings
      allow read, write: if isOwner(userId);
    }

    // =========================================================================
    // ğŸ”” USER_NOTIFICATION_SETTINGS COLLECTION - Notification Preferences
    // =========================================================================
    // ğŸ¢ ENTERPRISE: User notification preferences management
    // ğŸ”’ OWNERSHIP-BASED: ÎšÎ¬Î¸Îµ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Ï‡ÎµÎ¹ÏÎ¯Î¶ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Ï„Î¹Ï‚ Î´Î¹ÎºÎ­Ï‚ Ï„Î¿Ï… ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚
    match /user_notification_settings/{userId} {
      // ÎŸ Ï‡ÏÎ®ÏƒÏ„Î·Ï‚ Î¼Ï€Î¿ÏÎµÎ¯ Î½Î± Î´Î¹Î±Î²Î¬Î¶ÎµÎ¹ ÎºÎ±Î¹ Î½Î± Î³ÏÎ¬Ï†ÎµÎ¹ ÎœÎŸÎÎŸ Ï„Î¹Ï‚ Î´Î¹ÎºÎ­Ï‚ Ï„Î¿Ï… ÏÏ…Î¸Î¼Î¯ÏƒÎµÎ¹Ï‚ ÎµÎ¹Î´Î¿Ï€Î¿Î¹Î®ÏƒÎµÏ‰Î½
      allow read, write: if isOwner(userId);
    }

    // =========================================================================
    // ğŸ¢ WORKSPACES COLLECTION - AUTHENTICATED READ ACCESS
    // =========================================================================
    // ğŸ“… Added 2026-01-24: Fix WorkspaceContext permission error
    match /workspaces/{workspaceId} {
      // ğŸ“– READ: Authenticated users can read workspaces
      // TODO: Refine to workspace membership when implemented
      allow read: if isAuthenticated();

      // âœï¸ WRITE: Admin/server only for now
      allow write: if false;
    }

    // =========================================================================
    // ğŸ“ CONTACTS COLLECTION - PUBLIC READ ACCESS
    // =========================================================================
    match /contacts/{contactId} {

      // ğŸ“– READ: Authenticated users can read contacts (for business operations)
      // TODO: Refine to project-based access when relationships are implemented
      allow read: if isAuthenticated();

      // âœï¸ CREATE: ÎœÏŒÎ½Î¿ Î³Î¹Î± Ï„Î¿Î½ ÎµÎ±Ï…Ï„ÏŒ Ï„Î¿Ï…
      allow create: if request.auth != null
                    && request.auth.uid == contactId
                    && isValidContactData(request.resource.data)
                    && resource == null;

      // ğŸ“ UPDATE: ÎœÏŒÎ½Î¿ Î¿ Î¯Î´Î¹Î¿Ï‚ Î¼Îµ system field protection
      allow update: if request.auth != null
                    && request.auth.uid == contactId
                    && isValidContactData(request.resource.data)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // ğŸ—‘ï¸ DELETE: ÎœÏŒÎ½Î¿ Î¿ Î¯Î´Î¹Î¿Ï‚
      allow delete: if request.auth != null
                    && request.auth.uid == contactId;
    }

    // =========================================================================
    // ğŸ’¬ COMMUNICATIONS COLLECTION - LEGACY CRM COMMUNICATIONS
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Legacy communications collection
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /communications/{communicationId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // âš™ï¸ SYSTEM COLLECTION - SYSTEM CONFIGURATION
    // =========================================================================
    // ğŸ¢ ENTERPRISE: System-wide configuration and templates
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /system/{docId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin/server only

      // ğŸ“ Subcollections (e.g., project-templates)
      match /{subcollection}/{subDocId} {
        allow read: if isAuthenticated();
        allow write: if false; // Admin/server only
      }
    }

    // =========================================================================
    // âš™ï¸ CONFIG COLLECTION - APPLICATION CONFIGURATION
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Application configuration
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /config/{configId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // ğŸ¯ LEADS COLLECTION - CRM LEADS
    // =========================================================================
    // ğŸ¢ ENTERPRISE: CRM lead management
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /leads/{leadId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ’¼ OPPORTUNITIES COLLECTION - CRM OPPORTUNITIES
    // =========================================================================
    // ğŸ¢ ENTERPRISE: CRM opportunity management
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /opportunities/{opportunityId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ“‹ ACTIVITIES COLLECTION - CRM ACTIVITIES
    // =========================================================================
    // ğŸ¢ ENTERPRISE: CRM activity tracking
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix)
    match /activities/{activityId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ’¬ CONVERSATIONS - CRM COMMUNICATIONS
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Telegram/email conversations Î³Î¹Î± CRM
    // ğŸ”’ DEV-FRIENDLY: Authenticated users Î­Ï‡Î¿Ï…Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ· (Î³Î¹Î± development/testing)
    // ğŸ“… Added: 2026-01-15
    // âš ï¸ TODO (PHASE 2): ÎœÎµÏ„Î¬Î²Î±ÏƒÎ· ÏƒÎµ isInternalUser() ÏŒÏ„Î±Î½ setup custom claims (globalRole)
    match /conversations/{conversationId} {
      // ğŸ“– READ: Authenticated users (dev-friendly Î³Î¹Î± realtime listener)
      // TODO: Change to isInternalUser() after custom claims setup
      allow read: if isAuthenticated();

      // âœï¸ CREATE: Authenticated users can create new conversations
      allow create: if isAuthenticated()
                    && isValidConversationData(request.resource.data)
                    && resource == null;

      // ğŸ“ UPDATE: Authenticated users can update conversation metadata
      allow update: if isAuthenticated()
                    && isValidConversationData(request.resource.data)
                    && resource != null;

      // ğŸ—‘ï¸ DELETE: Authenticated users (prevent accidental deletions by guests)
      allow delete: if isAuthenticated()
                    && resource != null;
    }

    // =========================================================================
    // ğŸ’¬ MESSAGES (ROOT COLLECTION) - CRM COMMUNICATIONS
    // =========================================================================
    // ğŸ¢ ENTERPRISE: Messages stored in ROOT collection (not subcollection)
    // Architecture: messages/{messageId} with conversationId field
    // ğŸ”’ DEV-FRIENDLY: Authenticated users Î­Ï‡Î¿Ï…Î½ Ï€ÏÏŒÏƒÎ²Î±ÏƒÎ·
    // ğŸ“‹ REAL-TIME UPDATES: Supports Firestore onSnapshot Î³Î¹Î± instant message updates
    // ğŸ“… Added: 2026-01-15
    match /messages/{messageId} {
      // ğŸ“– READ: Authenticated users (supports real-time listener)
      // TODO: Change to isInternalUser() after custom claims setup
      allow read: if isAuthenticated();

      // âœï¸ CREATE: Authenticated users can send messages
      allow create: if isAuthenticated()
                    && isValidMessageData(request.resource.data)
                    && resource == null;

      // ğŸ“ UPDATE: Authenticated users can update message delivery status
      allow update: if isAuthenticated()
                    && isValidMessageData(request.resource.data)
                    && resource != null;

      // ğŸ—‘ï¸ DELETE: Authenticated users
      allow delete: if isAuthenticated()
                    && resource != null;
    }

    // =========================================================================
    // ğŸ” EXTERNAL IDENTITIES - TELEGRAM USER MAPPINGS
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - CRITICAL collection)
    // ğŸ¢ ENTERPRISE: Maps external platform IDs (Telegram chatId) to internal contacts
    match /external_identities/{identityId} {
      // ğŸ“– READ: Authenticated users (CRM needs to lookup identities)
      allow read: if isAuthenticated();

      // âœï¸ CREATE: Only system/admin can create identity mappings
      allow create: if isAuthenticated()
                    && resource == null;

      // ğŸ“ UPDATE: Only system/admin can update identity mappings
      allow update: if isAuthenticated()
                    && resource != null;

      // ğŸ—‘ï¸ DELETE: Only admin can delete identity mappings
      allow delete: if isAuthenticated()
                    && resource != null;
    }

    // =========================================================================
    // âš™ï¸ CONFIG - ENTERPRISE SERVICE CONFIGURATIONS
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - CRITICAL collection)
    // ğŸ¢ ENTERPRISE: System-wide configuration (channels, integrations, etc.)
    match /config/{configId} {
      // ğŸ“– READ: Authenticated users (app needs config)
      allow read: if isAuthenticated();

      // âœï¸ CREATE/UPDATE/DELETE: Only admin users
      allow create, update, delete: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ”— RELATIONSHIPS - ENTITY RELATIONSHIPS (GENERIC)
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - CRITICAL collection)
    // ğŸ¢ ENTERPRISE: General-purpose relationships between entities
    // âš ï¸ Note: contact_relationships has separate, more strict rules above
    match /relationships/{relationshipId} {
      // ğŸ“– READ: Authenticated users
      allow read: if isAuthenticated();

      // âœï¸ CREATE: Authenticated users
      allow create: if isAuthenticated()
                    && resource == null;

      // ğŸ“ UPDATE: Authenticated users
      allow update: if isAuthenticated()
                    && resource != null;

      // ğŸ—‘ï¸ DELETE: Authenticated users
      allow delete: if isAuthenticated()
                    && resource != null;
    }

    // =========================================================================
    // ğŸ” SECURITY POLICIES - EMAIL DOMAIN & COUNTRY RESTRICTIONS
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - CRITICAL collection)
    // ğŸ¢ ENTERPRISE: EnterpriseSecurityService policy collections (READ-ONLY for clients)
    match /email_domain_policies/{policyId} {
      // ğŸ“– READ: Authenticated users (security validation needs this)
      allow read: if isAuthenticated();
      // ğŸš« WRITE: Server-side only (via Admin SDK)
      allow write: if false;
    }

    match /country_security_policies/{policyId} {
      // ğŸ“– READ: Authenticated users (security validation needs this)
      allow read: if isAuthenticated();
      // ğŸš« WRITE: Server-side only (via Admin SDK)
      allow write: if false;
    }

    // =========================================================================
    // ğŸ”¢ COUNTERS - PROJECT CODE GENERATION
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - HIGH priority)
    // ğŸ¢ ENTERPRISE: Auto-increment counters for project codes, etc.
    match /counters/{counterId} {
      // ğŸ“– READ: Authenticated users (need to read current counter)
      allow read: if isAuthenticated();
      // âœï¸ WRITE: Authenticated users (increment on create)
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ“Š ANALYTICS - SENDGRID WEBHOOK ANALYTICS
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - HIGH priority)
    match /analytics/{analyticsId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ“‹ OBLIGATIONS & TEMPLATES
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - HIGH priority)
    match /obligations/{obligationId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && resource == null;
      allow update: if isAuthenticated() && resource != null;
      allow delete: if isAuthenticated() && resource != null;
    }

    match /obligationTemplates/{templateId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && resource == null;
      allow update: if isAuthenticated() && resource != null;
      allow delete: if isAuthenticated() && resource != null;
    }

    // ğŸ“‹ OBLIGATION-SECTIONS - Obligation sections (dash naming convention)
    // ğŸ“… Added: 2026-01-17 (Missing collection from Firestore audit)
    match /obligation-sections/{sectionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && resource == null;
      allow update: if isAuthenticated() && resource != null;
      allow delete: if isAuthenticated() && resource != null;
    }

    // =========================================================================
    // ğŸ’¼ OPPORTUNITIES - CRM SALES PIPELINE
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - HIGH priority)
    match /opportunities/{opportunityId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && resource == null;
      allow update: if isAuthenticated() && resource != null;
      allow delete: if isAuthenticated() && resource != null;
    }

    // =========================================================================
    // ğŸ‘¥ LEADS - CRM LEAD MANAGEMENT
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - MEDIUM priority)
    match /leads/{leadId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && resource == null;
      allow update: if isAuthenticated() && resource != null;
      allow delete: if isAuthenticated() && resource != null;
    }

    // =========================================================================
    // ğŸ“† ACTIVITIES - CRM ACTIVITY TRACKING
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - MEDIUM priority)
    match /activities/{activityId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && resource == null;
      allow update: if isAuthenticated() && resource != null;
      allow delete: if isAuthenticated() && resource != null;
    }

    // =========================================================================
    // ğŸ¤– BOT_CONFIGS - TELEGRAM BOT CONFIGURATIONS
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - MEDIUM priority)
    match /bot_configs/{configId} {
      allow read: if isAuthenticated();
      // ğŸš« WRITE: Server-side only (sensitive bot tokens)
      allow write: if false;
    }

    // =========================================================================
    // ğŸ—‚ï¸ LAYER GROUPS - DXF LAYER MANAGEMENT
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - MEDIUM priority)
    match /layerGroups/{groupId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ—ºï¸ FLOORPLANS - FLOOR PLAN STORAGE
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - MEDIUM priority)
    match /floorplans/{floorplanId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ“ AUDIT COLLECTIONS - SECURITY & COMPLIANCE
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - HIGH priority)
    // ğŸ¢ ENTERPRISE: Audit logs are READ-ONLY for clients (write via Admin SDK)
    match /relationship_audit/{auditId} {
      allow read: if isAuthenticated();
      allow write: if false; // Server-side only
    }

    match /admin_building_templates/{templateId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated(); // Admin UI needs write access
    }

    match /audit_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if false; // Server-side only
    }

    match /system_audit_logs/{logId} {
      allow read: if isAuthenticated();
      allow write: if false; // Server-side only
    }

    // =========================================================================
    // ğŸ“‹ AUDIT_LOG COLLECTION - CLOUD FUNCTIONS AUDIT TRAIL
    // =========================================================================
    // ğŸ“… Added: 2026-01-20 (ADR-032 - Enterprise Trash System)
    // ğŸ¢ ENTERPRISE: Audit log for file purge operations (written by Cloud Functions)
    // ğŸ”’ READ: Only super_admin can read audit logs
    // ğŸš« WRITE: Server-side only (via Firebase Admin SDK)
    match /audit_log/{logId} {
      allow read: if isSuperAdminOnly();
      allow write: if false; // Server-side only (Cloud Functions use Admin SDK)
    }

    // =========================================================================
    // ğŸ‘¥ TEAMS - TEAM MANAGEMENT
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Final 2 collections fix)
    // ğŸ¢ ENTERPRISE: Team management for EnterpriseTeamsService
    match /teams/{teamId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }

    // =========================================================================
    // ğŸ’¼ POSITIONS - ROLE/POSITION MANAGEMENT
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Final 2 collections fix)
    // ğŸ¢ ENTERPRISE: Position management (fallback for COLLECTIONS.ROLES)
    match /positions/{positionId} {
      allow read: if isAuthenticated();
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // âš™ï¸ SYSTEM - SYSTEM CONFIGURATION
    // =========================================================================
    // ğŸ“… Added: 2026-01-17 (Permission-denied fix - MEDIUM priority)
    // Note: Already had partial rules, adding subcollection support
    match /system/{docId} {
      allow read: if isAuthenticated();
      allow write: if false; // Server-side only

      // Subcollections (e.g., system/config/channels)
      match /{subcollection}/{subDocId} {
        allow read: if isAuthenticated();
        allow write: if false; // Server-side only
      }
    }

    // =========================================================================
    // ğŸ”’ HELPER FUNCTIONS - VALIDATION & SECURITY
    // =========================================================================

    // Project Data Validation
    function isValidProjectData(data) {
      return data.keys().hasAll(['name', 'status', 'company'])
             && data.name is string && data.name.size() > 0
             && data.status in ['planning', 'in_progress', 'completed', 'on_hold', 'cancelled']
             && data.company is string && data.company.size() > 0;
    }

    // Relationship Data Validation
    function isValidRelationshipData(data) {
      return data.keys().hasAll(['sourceContactId', 'targetContactId', 'relationshipType', 'status'])
             && data.sourceContactId is string && data.sourceContactId.size() > 0
             && data.targetContactId is string && data.targetContactId.size() > 0
             && data.relationshipType in ['employee', 'manager', 'partner', 'client', 'vendor']
             && data.status in ['active', 'inactive', 'pending', 'deleted'];
    }

    // ğŸ¨ Enterprise CAD File Data Validation (Firebase Storage + Metadata Only)
    function isValidCadFileData(data) {
      return data.keys().hasAll(['fileName'])
             && data.fileName is string && data.fileName.size() > 0
             // ğŸš¨ ÎšÎ¡Î™Î£Î™ÎœÎŸ: Î”Î•Î ÎµÏ€Î¹Ï„ÏÎ­Ï€Î¿Ï…Î¼Îµ scene object ÏƒÏ„Î¿ Firestore! (ÎœÏ€Î±ÎºÎ¬Î»Î¹ÎºÎ¿ Î³ÎµÎ¹Ï„Î¿Î½Î¹Î¬Ï‚)
             && !data.keys().hasAny(['scene'])
             // âœ… ENTERPRISE: Firebase Storage-based validation
             && (
               // Legacy format (Firestore-based data)
               !data.keys().hasAny(['storageUrl']) ||
               // ğŸ¢ ENTERPRISE FORMAT: Firebase Storage Î¼Îµ metadata
               (data.keys().hasAll(['storageUrl'])
                && data.storageUrl is string
                && data.storageUrl.size() > 0
                // âœ… Validate Firebase Storage URL format
                && data.storageUrl.matches('https://firebasestorage.googleapis.com/.*'))
             )
             // âœ… Enterprise metadata validation
             && (!data.keys().hasAny(['version']) || (data.version is number && data.version > 0))
             && (!data.keys().hasAny(['sizeBytes']) || (data.sizeBytes is number && data.sizeBytes > 0))
             && (!data.keys().hasAny(['entityCount']) || (data.entityCount is number && data.entityCount >= 0))
             && (!data.keys().hasAny(['checksum']) || (data.checksum is string && data.checksum.size() > 0));
    }

    // Contact Data Validation
    function isValidContactData(data) {
      return data.keys().hasAll(['email'])
             && data.email is string
             && data.email.matches('.*@.*\\..*'); // Basic email validation
    }

    // âœ… Task Data Validation (ADR-026: CRM Tasks Backend Fix)
    // ğŸ¢ ENTERPRISE: Validates CrmTask structure for Firestore operations
    function isValidTaskData(data) {
      return data.keys().hasAll(['title', 'type', 'assignedTo', 'status', 'priority'])
             // ğŸ“ Title validation
             && data.title is string && data.title.size() > 0
             // ğŸ“‹ Type validation (enum)
             && data.type in ['call', 'email', 'meeting', 'viewing', 'document', 'follow_up', 'other']
             // ğŸ‘¤ AssignedTo validation (User ID)
             && data.assignedTo is string && data.assignedTo.size() > 0
             // ğŸ“Š Status validation (enum)
             && data.status in ['pending', 'in_progress', 'completed', 'cancelled']
             // âš¡ Priority validation (enum)
             && data.priority in ['low', 'medium', 'high', 'urgent']
             // ğŸ”— Optional leadId validation
             && (!data.keys().hasAny(['leadId']) || (data.leadId is string))
             // ğŸ”— Optional contactId validation
             && (!data.keys().hasAny(['contactId']) || (data.contactId is string))
             // ğŸ”— Optional projectId validation
             && (!data.keys().hasAny(['projectId']) || (data.projectId is string))
             // ğŸ“ Optional description validation
             && (!data.keys().hasAny(['description']) || (data.description is string));
    }

    // =========================================================================
    // ğŸ’¬ CONVERSATION & MESSAGE DATA VALIDATION
    // =========================================================================
    // ğŸ“‹ CRM Communications - Added 2026-01-15
    // ğŸ¢ ENTERPRISE: Validates Conversation and Message structures for Firestore operations

    // Conversation Data Validation
    function isValidConversationData(data) {
      return data.keys().hasAll(['channel', 'status'])
             // ğŸ“¡ Channel validation (enum: telegram | email | whatsapp | sms)
             && data.channel in ['telegram', 'email', 'whatsapp', 'sms']
             // ğŸ“Š Status validation (enum)
             && data.status in ['active', 'archived', 'closed', 'spam']
             // ğŸ”¢ Optional messageCount validation
             && (!data.keys().hasAny(['messageCount']) || (data.messageCount is int && data.messageCount >= 0))
             // ğŸ”” Optional unreadCount validation
             && (!data.keys().hasAny(['unreadCount']) || (data.unreadCount is int && data.unreadCount >= 0))
             // ğŸ‘¤ Optional assignedTo validation
             && (!data.keys().hasAny(['assignedTo']) || (data.assignedTo == null || data.assignedTo is string));
    }

    // Message Data Validation
    function isValidMessageData(data) {
      return data.keys().hasAll(['conversationId', 'direction', 'channel', 'content'])
             // ğŸ”— ConversationId validation
             && data.conversationId is string && data.conversationId.size() > 0
             // â†”ï¸ Direction validation (enum: inbound | outbound)
             && data.direction in ['inbound', 'outbound']
             // ğŸ“¡ Channel validation (enum)
             && data.channel in ['telegram', 'email', 'whatsapp', 'sms']
             // ğŸ“ Content validation (must have text field)
             && data.content is map
             && data.content.keys().hasAll(['text'])
             && data.content.text is string
             // ğŸ‘¤ Optional sender fields validation
             && (!data.keys().hasAny(['senderId']) || (data.senderId is string))
             && (!data.keys().hasAny(['senderName']) || (data.senderName is string))
             // ğŸ“Š Optional deliveryStatus validation
             && (!data.keys().hasAny(['deliveryStatus'])
                 || data.deliveryStatus in ['queued', 'sent', 'delivered', 'read', 'failed']);
    }

    // =========================================================================
    // ğŸ”” NOTIFICATION UPDATE VALIDATION
    // =========================================================================
    // ğŸ“‹ ADR-027: CRM Notifications Integration - Added 2026-01-13
    // ğŸ”’ ENTERPRISE: Only allows updating delivery state fields
    function isValidNotificationUpdate(newData, existingData) {
      // List of fields that users are allowed to modify
      let allowedFields = ['delivery', 'seenAt', 'actedAt', 'actionId'];

      // Get the fields that changed
      let changedKeys = newData.diff(existingData).affectedKeys();

      // All changed fields must be in the allowed list
      return changedKeys.hasOnly(allowedFields)
             // Ensure delivery state is valid if being updated
             && (!changedKeys.hasAny(['delivery'])
                 || newData.delivery.state in ['queued', 'sent', 'delivered', 'seen', 'acted', 'failed', 'expired'])
             // Ensure userId is never changed
             && newData.userId == existingData.userId
             // Ensure title is never changed
             && newData.title == existingData.title;
    }

    // System Fields Protection
    function isAttemptingToModifySystemFields(newData, existingData) {
      let systemFields = ['createdAt', 'createdBy', 'ownerId', 'id'];
      return systemFields.hasAny(
        newData.diff(existingData).affectedKeys()
      );
    }

    // Relationship checking helper
    function hasRelationshipWithContact(userId, contactId) {
      // This would need to be implemented based on your relationship logic
      // For now, allowing basic access - you can refine this later
      return true;
    }

    // =========================================================================
    // ğŸ—ï¸ DEVELOPMENT MODE HELPERS
    // =========================================================================

    // Dev mode helper - PRODUCTION MODE ENABLED
    function isDevMode() {
      // ğŸ”’ PRODUCTION: Dev mode disabled for security
      // Changed from true â†’ false on 2026-01-11 (Security Audit Fix)
      return false;
    }

    // Authentication helper
    function isAuthenticated() {
      return request.auth != null;
    }

    // User ownership helper
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // =========================================================================
    // ğŸ” RFC v6 AUTHORIZATION HELPERS (PHASE 1 PREPARATION)
    // =========================================================================
    // These helpers enable future tenant-scoped access control.
    // Path migration: /collection/{id} â†’ /companies/{companyId}/collection/{id}
    //
    // @see docs/rfc/authorization-rbac.md

    // Get user's companyId from custom claims
    function getUserCompanyId() {
      return request.auth.token.companyId;
    }

    // Get user's globalRole from custom claims
    function getGlobalRole() {
      return request.auth.token.globalRole;
    }

    // Check if user is super_admin (system-wide access)
    function isSuperAdminOnly() {
      return isAuthenticated() && getGlobalRole() == 'super_admin';
    }

    // Check if user is company_admin or higher
    function isCompanyAdmin() {
      return isAuthenticated() && getGlobalRole() in ['super_admin', 'company_admin'];
    }

    // Check if user is internal_user or higher
    function isInternalUser() {
      return isAuthenticated() && getGlobalRole() in ['super_admin', 'company_admin', 'internal_user'];
    }

    // Check if user belongs to a specific company (tenant isolation)
    function belongsToCompany(companyId) {
      return isAuthenticated() && getUserCompanyId() == companyId;
    }

    // P0-B FIX: Tenant-bound company admin (prevents cross-tenant writes)
    function isCompanyAdminOfCompany(companyId) {
      return isSuperAdminOnly() ||
             (getGlobalRole() == 'company_admin' && belongsToCompany(companyId));
    }

    // P0-B FIX: Tenant-bound internal user (prevents cross-tenant reads)
    function isInternalUserOfCompany(companyId) {
      return isSuperAdminOnly() ||
             (isInternalUser() && belongsToCompany(companyId));
    }

    // =========================================================================
    // ğŸ  UNIT FIELDS SECURITY HELPERS (2026-01-24)
    // =========================================================================
    // These helpers enable tenant-scoped access for units via projectâ†’company lookup
    // Units don't have companyId directly - must lookup via project reference

    // Get companyId from a project document (for tenant isolation)
    // Usage: getProjectCompanyId(resource.data.project) where project is the project ID string
    function getProjectCompanyId(projectId) {
      return get(/databases/$(database)/documents/projects/$(projectId)).data.companyId;
    }

    // Check if user belongs to the company that owns this project
    function belongsToProjectCompany(projectId) {
      return isSuperAdminOnly() || belongsToCompany(getProjectCompanyId(projectId));
    }

    // Check if user is company admin of the project's company
    function isCompanyAdminOfProject(projectId) {
      return isCompanyAdminOfCompany(getProjectCompanyId(projectId));
    }

    // Unit Fields allowlist - only these fields can be updated by non-super-admin users
    // ğŸ¢ ENTERPRISE: Prevents modification of structural fields (project, id)
    // ğŸ“… Updated 2026-01-24: Added 'name' to allowlist (rename is allowed for company admins)
    // ğŸ“… Updated 2026-01-24: Added buildingId, floorId, linkedSpaces for Unit Linking System
    function isAllowedUnitFieldUpdate() {
      let allowedFields = [
        // Identity (editable by company admins)
        'name', 'description',
        // Unit Linking System (Phase 1-2) - Building/Floor/LinkedSpaces
        'buildingId', 'floorId', 'linkedSpaces',
        // Phase 1-5 Unit Fields
        'bedrooms', 'bathrooms', 'wc',
        'areas', 'orientation', 'orientations', 'condition', 'energyClass',
        'heating', 'cooling', 'flooring', 'frames', 'glazing',
        'interiorFeatures', 'securityFeatures',
        // Layout
        'layout',
        // Systems & Finishes
        'systemsOverride', 'finishes', 'energy',
        // Metadata
        'updatedAt', 'updatedBy',
        // Operational
        'operationalStatus', 'unitCoverage'
      ];
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
    }

    // Check that structural fields are not being modified (invariants)
    // ğŸ¢ ENTERPRISE: Prevents "re-tenanting" units via client update
    // ğŸ“… Updated 2026-01-24: Removed 'name' from invariants (rename is now allowed)
    // ğŸ“… Updated 2026-01-24: Removed buildingId/floorId from invariants (Unit Linking System)
    //    - Units CAN be moved between buildings/floors within the SAME project
    //    - Units CANNOT be moved to a different project (tenant isolation)
    function unitStructuralFieldsUnchanged() {
      return request.resource.data.project == resource.data.project
             && request.resource.data.id == resource.data.id;
    }

    // Validate parent document exists (for subcollections - prevents injection)
    function parentExists(path) {
      return exists(path);
    }
  }
}
