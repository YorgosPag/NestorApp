rules_version = '2';

// =============================================================================
// üîí PRODUCTION-GRADE FIRESTORE SECURITY RULES
// =============================================================================
//
// üéØ Œ£Œ§Œ°ŒëŒ§ŒóŒìŒôŒöŒó: Deny-all by default, explicit allow per collection
// üõ°Ô∏è ŒëŒ°ŒßŒó: Zero Trust - Œ∫Œ±ŒºŒØŒ± œÄœÅœåœÉŒ≤Œ±œÉŒ∑ œáœâœÅŒØœÇ authentication & authorization
// ‚ö†Ô∏è ŒöŒ°ŒôŒ£ŒôŒúŒü: ŒëœÖœÑŒ≠œÇ ŒøŒπ rules œÄœÅŒøœÉœÑŒ±œÑŒµœçŒøœÖŒΩ œÑŒ∑ŒΩ ŒµœÜŒ±œÅŒºŒøŒ≥ŒÆ Œ±œÄœå unauthorized access
//
// =============================================================================

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // üö´ DEFAULT DENY-ALL RULE
    // =========================================================================
    // ŒüœÄŒøŒπŒ±Œ¥ŒÆœÄŒøœÑŒµ œÉœÖŒªŒªŒøŒ≥ŒÆ œÄŒøœÖ ŒîŒïŒù Œ≠œáŒµŒπ explicit rule ‚Üí ŒëŒ°ŒùŒóŒ£Œó
    match /{document=**} {
      allow read, write: if false;
    }

    // =========================================================================
    // üìÅ PROJECTS COLLECTION - DEV-FRIENDLY ACCESS
    // =========================================================================
    match /projects/{projectId} {

      // üìñ READ: Authenticated users only (Production mode)
      allow read: if isAuthenticated();

      // ‚úçÔ∏è CREATE: ŒúœåŒΩŒø authenticated users ŒºŒµ validated data
      allow create: if request.auth != null
                    && isValidProjectData(request.resource.data)
                    && resource == null; // Ensure document doesn't exist

      // üìù UPDATE: ŒúœåŒΩŒø authenticated users ŒºŒµ validation
      allow update: if request.auth != null
                    && isValidProjectData(request.resource.data)
                    && resource != null  // Ensure document exists
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // üóëÔ∏è DELETE: ŒúœåŒΩŒø authenticated users
      allow delete: if request.auth != null
                    && resource != null; // Ensure document exists
    }

    // =========================================================================
    // üë• CONTACT_RELATIONSHIPS COLLECTION - STRICT OWNERSHIP
    // =========================================================================
    match /contact_relationships/{relationshipId} {

      // üìñ READ: ŒúœåŒΩŒø authenticated users œÄŒøœÖ ŒµŒØŒΩŒ±Œπ source ŒÆ target
      allow read: if request.auth != null
                  && (resource.data.sourceContactId == request.auth.uid
                      || resource.data.targetContactId == request.auth.uid);

      // ‚úçÔ∏è CREATE: ŒúœåŒΩŒø authenticated users Œ≥ŒπŒ± Œ¥ŒπŒ∫Œ≠œÇ œÑŒøœÖœÇ relationships
      allow create: if request.auth != null
                    && isValidRelationshipData(request.resource.data)
                    && (request.resource.data.sourceContactId == request.auth.uid
                        || request.resource.data.targetContactId == request.auth.uid)
                    && resource == null;

      // üìù UPDATE: ŒúœåŒΩŒø owners ŒºŒµ system field protection
      allow update: if request.auth != null
                    && isValidRelationshipData(request.resource.data)
                    && (resource.data.sourceContactId == request.auth.uid
                        || resource.data.targetContactId == request.auth.uid)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // üóëÔ∏è DELETE: ŒúœåŒΩŒø owners
      allow delete: if request.auth != null
                    && (resource.data.sourceContactId == request.auth.uid
                        || resource.data.targetContactId == request.auth.uid);
    }

    // =========================================================================
    // üé® CAD_FILES COLLECTION - ENTERPRISE DXF STORAGE (Firebase Storage + Metadata)
    // =========================================================================
    match /cadFiles/{fileId} {

      // üìñ READ: Authenticated with ownership support (Production mode)
      allow read: if request.auth != null
                  && (resource.data.keys().hasAny(['ownerId']) == false
                      || resource.data.ownerId == request.auth.uid);

      // ‚úçÔ∏è CREATE: Authenticated users ŒºŒµ enterprise validation
      allow create: if request.auth != null
                    && isValidCadFileData(request.resource.data)
                    && (request.resource.data.keys().hasAny(['ownerId']) == false
                        || request.resource.data.ownerId == request.auth.uid)
                    && resource == null;

      // üìù UPDATE: Enterprise ŒºŒµ system field protection Œ∫Œ±Œπ Storage URL validation
      allow update: if request.auth != null
                    && isValidCadFileData(request.resource.data)
                    && (resource.data.keys().hasAny(['ownerId']) == false
                        || resource.data.ownerId == request.auth.uid)
                    && (request.resource.data.keys().hasAny(['ownerId']) == false
                        || request.resource.data.ownerId == request.auth.uid)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // üóëÔ∏è DELETE: Owner only (Production mode)
      allow delete: if request.auth != null
                    && (resource.data.keys().hasAny(['ownerId']) == false
                        || resource.data.ownerId == request.auth.uid);
    }

    // =========================================================================
    // üè¢ COMPANIES COLLECTION - READ-ONLY FOR AUTHENTICATED
    // =========================================================================
    match /companies/{companyId} {

      // üìñ READ: ŒúœåŒΩŒø authenticated users
      allow read: if request.auth != null;

      // ‚úçÔ∏è CREATE/UPDATE/DELETE: ŒåŒßŒô Œ±œÄœå client - ŒºœåŒΩŒø admin/server
      allow write: if false;
    }

    // =========================================================================
    // üè† BUILDINGS, FLOORS & UNITS - PUBLIC READ ACCESS
    // =========================================================================
    match /buildings/{buildingId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // üè¢ FLOORS: ŒüœÅœåœÜŒøŒπ Œ∫œÑŒπœÅŒØœâŒΩ - Navigation hierarchy support
    match /floors/{floorId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    match /units/{unitId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // üì¶ STORAGE_UNITS COLLECTION - PARALLEL CATEGORY (local_4.log)
    // =========================================================================
    // üè¢ ENTERPRISE: Storage units are a PARALLEL category to Units, not nested
    // Architecture: Building ‚Üí [Units | Storage | Parking] (parallel)
    match /storage_units/{storageId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // üöó PARKING_SPOTS COLLECTION - PARALLEL CATEGORY (local_4.log)
    // =========================================================================
    // üè¢ ENTERPRISE: Parking spaces are a PARALLEL category to Units, not nested
    // Architecture: Building ‚Üí [Units | Storage | Parking] (parallel)
    // üìç Collection name: parking_spots (ŒºŒµ underscore - œåœÄœâœÇ œÉœÑŒ∑ Firestore)
    match /parking_spots/{parkingId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only (use Firebase Admin SDK for seeding)
    }

    // =========================================================================
    // üß≠ NAVIGATION_COMPANIES COLLECTION - DEV-FRIENDLY READ ACCESS
    // =========================================================================
    // üè¢ ENTERPRISE: ŒïœÑŒ±ŒπœÅŒµŒØŒµœÇ œÄŒøœÖ ŒµŒºœÜŒ±ŒΩŒØŒ∂ŒøŒΩœÑŒ±Œπ œáŒµŒπœÅŒøŒ∫ŒØŒΩŒ∑œÑŒ± œÉœÑŒ∑ŒΩ œÄŒªŒøŒÆŒ≥Œ∑œÉŒ∑
    // Œ†ŒµœÅŒπŒ≠œáŒµŒπ contactIds œÄŒøœÖ Œ±ŒΩœÑŒπœÉœÑŒøŒπœáŒøœçŒΩ œÉŒµ ŒµœÑŒ±ŒπœÅŒµŒØŒµœÇ œÉœÑŒ∑ contacts collection
    match /navigation_companies/{navCompanyId} {
      allow read: if isAuthenticated(); // Authenticated users only
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // üîî NOTIFICATIONS COLLECTION - PUBLIC READ ACCESS
    // =========================================================================
    match /notifications/{notificationId} {
      allow read: if true; // Public read access for notifications
      allow write: if false; // Admin/server only
    }

    // =========================================================================
    // üìû CONTACTS COLLECTION - PUBLIC READ ACCESS
    // =========================================================================
    match /contacts/{contactId} {

      // üìñ READ: Authenticated users can read contacts (for business operations)
      // TODO: Refine to project-based access when relationships are implemented
      allow read: if isAuthenticated();

      // ‚úçÔ∏è CREATE: ŒúœåŒΩŒø Œ≥ŒπŒ± œÑŒøŒΩ ŒµŒ±œÖœÑœå œÑŒøœÖ
      allow create: if request.auth != null
                    && request.auth.uid == contactId
                    && isValidContactData(request.resource.data)
                    && resource == null;

      // üìù UPDATE: ŒúœåŒΩŒø Œø ŒØŒ¥ŒπŒøœÇ ŒºŒµ system field protection
      allow update: if request.auth != null
                    && request.auth.uid == contactId
                    && isValidContactData(request.resource.data)
                    && !isAttemptingToModifySystemFields(request.resource.data, resource.data);

      // üóëÔ∏è DELETE: ŒúœåŒΩŒø Œø ŒØŒ¥ŒπŒøœÇ
      allow delete: if request.auth != null
                    && request.auth.uid == contactId;
    }

    // =========================================================================
    // üîí HELPER FUNCTIONS - VALIDATION & SECURITY
    // =========================================================================

    // Project Data Validation
    function isValidProjectData(data) {
      return data.keys().hasAll(['name', 'status', 'company'])
             && data.name is string && data.name.size() > 0
             && data.status in ['planning', 'in_progress', 'completed', 'on_hold', 'cancelled']
             && data.company is string && data.company.size() > 0;
    }

    // Relationship Data Validation
    function isValidRelationshipData(data) {
      return data.keys().hasAll(['sourceContactId', 'targetContactId', 'relationshipType', 'status'])
             && data.sourceContactId is string && data.sourceContactId.size() > 0
             && data.targetContactId is string && data.targetContactId.size() > 0
             && data.relationshipType in ['employee', 'manager', 'partner', 'client', 'vendor']
             && data.status in ['active', 'inactive', 'pending', 'deleted'];
    }

    // üé® Enterprise CAD File Data Validation (Firebase Storage + Metadata Only)
    function isValidCadFileData(data) {
      return data.keys().hasAll(['fileName'])
             && data.fileName is string && data.fileName.size() > 0
             // üö® ŒöŒ°ŒôŒ£ŒôŒúŒü: ŒîŒïŒù ŒµœÄŒπœÑœÅŒ≠œÄŒøœÖŒºŒµ scene object œÉœÑŒø Firestore! (ŒúœÄŒ±Œ∫Œ¨ŒªŒπŒ∫Œø Œ≥ŒµŒπœÑŒøŒΩŒπŒ¨œÇ)
             && !data.keys().hasAny(['scene'])
             // ‚úÖ ENTERPRISE: Firebase Storage-based validation
             && (
               // Legacy format (Firestore-based data)
               !data.keys().hasAny(['storageUrl']) ||
               // üè¢ ENTERPRISE FORMAT: Firebase Storage ŒºŒµ metadata
               (data.keys().hasAll(['storageUrl'])
                && data.storageUrl is string
                && data.storageUrl.size() > 0
                // ‚úÖ Validate Firebase Storage URL format
                && data.storageUrl.matches('https://firebasestorage.googleapis.com/.*'))
             )
             // ‚úÖ Enterprise metadata validation
             && (!data.keys().hasAny(['version']) || (data.version is number && data.version > 0))
             && (!data.keys().hasAny(['sizeBytes']) || (data.sizeBytes is number && data.sizeBytes > 0))
             && (!data.keys().hasAny(['entityCount']) || (data.entityCount is number && data.entityCount >= 0))
             && (!data.keys().hasAny(['checksum']) || (data.checksum is string && data.checksum.size() > 0));
    }

    // Contact Data Validation
    function isValidContactData(data) {
      return data.keys().hasAll(['email'])
             && data.email is string
             && data.email.matches('.*@.*\\..*'); // Basic email validation
    }

    // System Fields Protection
    function isAttemptingToModifySystemFields(newData, existingData) {
      let systemFields = ['createdAt', 'createdBy', 'ownerId', 'id'];
      return systemFields.hasAny(
        newData.diff(existingData).affectedKeys()
      );
    }

    // Relationship checking helper
    function hasRelationshipWithContact(userId, contactId) {
      // This would need to be implemented based on your relationship logic
      // For now, allowing basic access - you can refine this later
      return true;
    }

    // =========================================================================
    // üèóÔ∏è DEVELOPMENT MODE HELPERS
    // =========================================================================

    // Dev mode helper - PRODUCTION MODE ENABLED
    function isDevMode() {
      // üîí PRODUCTION: Dev mode disabled for security
      // Changed from true ‚Üí false on 2026-01-11 (Security Audit Fix)
      return false;
    }

    // Authentication helper
    function isAuthenticated() {
      return request.auth != null;
    }

    // User ownership helper
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
  }
}